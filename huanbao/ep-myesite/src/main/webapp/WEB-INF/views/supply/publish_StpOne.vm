#set($compulsiveUpdate="1")
#set($layout="/layout/defaultS.vm")
<link rel="stylesheet" type="text/css" href="http://subject.zz91.com/comm/css/jquery.alert.css"/>
<script type="text/javascript" src="http://subject.zz91.com/comm/js/jquery.easydrag.js"></script>
<script type="text/javascript" src="http://subject.zz91.com/comm/js/jquery.alert.js"></script>
<div class="clearfix"></div>

<section class="container mt">
	<ul class="breadcrumb">
		<li><strong>发布供应信息</strong></li>
	</ul>
</section>

<section class="container">
    <div class="process-bar">
        <ul class="clearfix">
            <li class="active">第一步：选择类别<s class="l"></s><s class="r"></s></li>
            <li>第二步：填写详细信息<s class="l"></s><s class="r"></s></li>
            <li>第三步：发布成功<s class="l"></s><s class="r"></s></li>
        </ul>
    </div>	
</section>

<section class="container ">
	<div class="alert alert-info">
		您当前选择的类别是：<strong><span id="selectresult">$!{categoryPath}</span></strong>
	</div>
</section>

#set($choice0="none")
#set($choice1="")
#if("$!{choiceType}"=="0")
	#set($choice0="")
	#set($choice1="none")
#end

##常用类别选择 
<section class="container well mt" style="display: $!{choice0};" id="choiceSection0">	
	<div class="well-head">第一步：选择类别(常用类别)</div>
	<div class="well-content">
		<form name="historyForm" id="historyForm" action="#springUrl('/supply/publish_StpTwo.htm')" method="post">
			<div class="center">
				<input type="button" class="btn btn-small" name="choice1" id="choice1" value="从所有类别选取" /> 或
			</div>
			<ul>
				#if(!$!{publishedCategory})
				<li>暂时没有常用类别</li>
				#end
				#foreach($pc in $!{publishedCategory.keySet()})
				<li>
					<label class="radio">
						<input type="radio" name="category" value="$pc" onclick="jQuery('#selectresult').html('$!{publishedCategory.get($pc)}');" #if(!$!{category}) checked #elseif($!{category}==$pc) checked #end/>
						$!{publishedCategory.get($pc)}
					</label>
				</li>
				#end
			</ul>
			<div class="mt center">
				<input type="submit" class="btn btn-primary btn-large" name="historyBtn" id="historyBtn" value="下一步，填写详细信息" />
				<input type="hidden" name="choiceType" value="0" />
			</div>
		</form>
	</div>
</section>

##常规类别选择
<section class="container well mt" style="display: $!{choice1};" id="choiceSection1">	
	<div class="well-head">
		第一步：选择类别
	</div>
	<div class="well-content">

		<form name="typicalForm" id="typicalForm" action="#springUrl('/supply/publish_StpTwo.htm')" method="post">
			<div class="center">
				<input type="button" class="btn btn-small" name="choice0" id="choice0" value="从已发布的供应导入类别" /> 或
			</div>
			<div class="center mt">
				<select multiple="true" class="input-xlarge" style="height:300px;" id="c1">
					<option value="" >--请选择--</option>
				</select>	
				<select multiple="true" class="input-xlarge" style="height:300px;" id="c2">
					<option value="" >--请选择--</option>
				</select>	
				<select multiple="true" class="input-xlarge" style="height:300px;" id="c3">
					<option value="" >--请选择--</option>
				</select>
			</div>
			<div class="mt center">
				<input type="submit" class="btn btn-primary btn-large" name="typicalBtn" id="typicalBtn" value="下一步，填写详细信息" />
				<input type="hidden" value="$!{category}" name="category" id="typcialCategory" />
				<input type="hidden" name="choiceType" value="1" />
			</div>
		</form>
	</div>
</section>

##登录信息
#if($!{epAuthUser})
<input type="hidden" id="loginstatus" value="1" />
#else
<input type="hidden" id="loginstatus" value="0" />
#end
<script type="text/javascript">
function weixinopen(){
	//判断微信验证
	var ajaxurl="http://pyapp.zz91.com/weixin/huanbaoweixin_yzfront.html?account=$!{epAuthUser.account}&flag=1";
	jQuery.getScript(ajaxurl, function() {
		var result = _suggest_result_.result;
		if (result=="0"){
			//debug时，注释下面两行
			jIframe('http://pyapp.zz91.com/weixin/huanbaoweixin_yz.html?account=$!{epAuthUser.account}', '微信验证','550','300');
			return false;
		}
	});
}
	jQuery(document).ready(function(){
		
		var selector = new Asto.util.Selector({
			url:"#springUrl('/common/getTradeCategory.htm')",
			changeCallback:function(sel,idx){
				var vs=sel.getTexts();
				jQuery("#selectresult").html(vs.join(" > "));
				jQuery("#typcialCategory").val(sel.getValue());
			},
			selects:["#c1","#c2","#c3"],
			field:{code:"code",label:"name"}
		});

		selector.init({
			#if("$!{category}" != "")
			initCode:"$!{category}",
			#else
			initCode:"1000",
			#end
			rootCode:"1000"
		});

		//TODO 表单提交，若未登录，则先登后（弹出）再提交
		//提交前验证是否该选的都选了
		jQuery("#typicalForm").submit(function(){
			//验证选择
			
			//return false;
			if(jQuery("#c3").val()==null || jQuery("#c3").val()=="" || jQuery("#c1").val()=="" || jQuery("#c2").val()==""){
				alert("请选择完整的类别后再进行下一步操作！");
				return false;
			}

			//判断登录
			if(jQuery("#loginstatus").val()=="1"){
				return true;
			}
			

			//显示登录框
			var loginBox=new Asto.util.Modal({
				title:"请先登录后再操作",
				url:"#springUrl('/common/loginMini.htm')?destUrl=/callback/login.htm",
				width:400,
				height:260,
				modal:true
			});

			//设置 Callback 
			Asto.util.Callback.setSubmitCallback(function(success,data){
				loginBox.close();
				jQuery("#loginstatus").val(1);
				jQuery("#typicalForm").submit();
			});
			return false;
		});
		
		jQuery("#c1").change(function(){
			weixinopen();
			//jQuery("#c1").val('');
		});
		jQuery("#c2").change(function(){
			weixinopen();
			//jQuery("#c2").val('');
		});
		jQuery("#c3").change(function(){
			weixinopen();
			//jQuery("#c3").val('');
		});

		jQuery("#choice0").click(function(){
			if(jQuery("#loginstatus").val()=="0"){
				var loginBox=new Asto.util.Modal({
					title:"请先登录后再操作",
					url:"#springUrl('/common/loginMini.htm')?destUrl=/callback/login.htm",
					width:400,
					height:260,
					modal:true
				});
				
				//设置 Callback 
				Asto.util.Callback.setSubmitCallback(function(success,data){
					loginBox.close();
					window.location.href="#springUrl('/supply/publish_StpOne.htm')?choiceType=0";
				});
				return false;
			}
			//判断微信验证
			weixinopen();
			jQuery("#choiceSection1").hide();
			jQuery("#choiceSection0").show();
		});

		jQuery("#choice1").click(function(){
			jQuery("#choiceSection0").hide();
			jQuery("#choiceSection1").show();
		});

	});
</script>

#if("$!{epAuthUser.account}"!="")
<script type="text/javascript" >
	jQuery(document).ready(function(){
		myrc.select("Js_select");
		myrc.menu(2, 1);
	});
</script>
#end

##<section class="hb_mainblock sup_block">
##    <header class="trade_postofferone_top">
##        <div class="mainb_top_l">发布供应信息</div>
##        <div class="mainb_top_r">
##			<span class="top_r_t">提交成功，等待审核</span>
##            <span class="top_r_s">填写信息详情</span>
##			<span class="top_r_f_y">选择类目</span>
##        </div>
##    </header>
##
##	<div class="trade_postofferone_neck">
##        <span class="postofferone_neck_l">选择类目或<a class="fontblue" href="javascript:void(0)" onclick="return userCategory();">导入您最近发布的类别</a>进行快速发布</span>
##		
##        <span class="postofferone_neck_r">如果您对类目设置有建议，请<a class="fontblue" href="http://www.huanbao.com/fudus/leaveMsg.htm">点此反馈</a></span>
##    </div>
####    <div class="post_search">
####        <label for="pos_seach" class="pos_seach_lab">请输入产品名称以查找类别：</label>
####		<input id="pos_seach" name="keyWords" class="pso_search_ipt" type="text" />
####        <input type="button" onclick="publish_search()" class="pso_search_sub" value=" 查 找"/>
####        <div class="clear"></div>
####    </div>
##<form id="stepTwoForm" method="post" action="#springUrl('/supply/publish_StpTwo.htm')" style="display: none">
##	<div class="trade_postofferone_class">
##        <ul id="Js_select">
##			#foreach($l in ${supplyDto})
##        	<li><input name="category" type="radio" value="$!{l.categoryCode}" />$!{l.categoryName}</li>
##			#end
##        </ul>
##    </div>
##	    <div class="pst_foot">
##		<span class="pst_foot_slet" id="selectresult0">
##			您当前选择的类别是：<span id="Js_result">$!{categoryPath}</span>
##        </span>
##		<div class="clear">
##			#if($!{epAuthUser})
##			<input type="hidden" id="loginstatus" value="1" />
##		    #else
##			<input type="hidden" id="loginstatus" value="0" />
##            #end
##       </div>
##        <span class="pst_foot_sub">
##            <input type="submit" value="下一步，填写详细信息" class="pstf_sub_btn"/>
##        </span>
##    </div>
##</form>
##
##<form id="stepOneForm" method="post" action="#springUrl('/supply/publish_StpTwo.htm')" >
##    <div class="trade_postofferone_type">
##        <span class="postoferone_type_l">
##            <select name="category1" id="category1" class="type_top_sel" multiple>
##                <option value="" >--请选择--</option>
##            </select>
##        </span>
##        <span class="postoferone_type_l" >
##            <select name="category2" id="category2" class="type_top_sel" multiple>
##                <option value="" >--请选择--</option>
##            </select>
##        </span>
##        <span class="postoferone_type_l" multiple>
##            <select name="category3" id="category3" class="type_top_sel" multiple>
##                <option value="" >--请选择--</option>
##            </select>
##        </span>
##        <div class="clear"></div>
##    </div>
##	
##    <div class="pst_foot">
##        <span class="pst_foot_slet" id="selectresult">
##			您当前选择的类别是：$!{categoryPath}
##        </span>
##        <span class="pst_foot_sub">
##			<input type="hidden" id="category" name="category" value="$!{category}" />
##            <input type="submit" value="下一步，填写详细信息" class="pstf_sub_btn"/>
##        </span>
##    </div>   
##</form>
##
##</section>
###*
##<div class="popup_box_bc"></div>
##<div class="popup_box">
##<div class="popup_box_close"></div>
##here is a test html
##</div>
##*#
##<script language="javascript">
##
##	jQuery(document).ready(function(){
##		
##		var _selects = ["#category1","#category2","#category3"];
##		var selector=new hb.util.Selector({
##		   selects:_selects,
##			url:"#springUrl('/common/getTradeCategory.htm')",
##			changeCallback:function(sel,idx){
##				var vs=sel.getTexts();
##				jQuery("#selectresult").html("您当前选择的是："+vs.join(">"));
##				
##				if((idx+1) == _selects.length){
##					
##					jQuery("#category").val(sel.getValue());
##					
##					jQuery("#nextstep").attr("disabled",false);
##				} else {
##				    jQuery("#nextstep").attr("disabled",true);
##				}
##			},
##			field:{code:"code",label:"name"}
##		});
##		
##		selector.init({
##			rootCode:"1000",
##			#if($!{category} != "")
##			initCode:"$!{category}"
##			#else
##			initCode:"1000"
##			#end
##		});
##		
##		hb.util.MiniLogin.loginUrl="#springUrl('/loginMini.htm')";
##		hb.util.MiniLogin.destUrl="#springUrl('/callback/login.htm')";
##		
##	});
##	
##	jQuery("#Js_select").find("input").bind("change", function(){
##        var text = jQuery(this).parent().text();
##        jQuery("#Js_result").empty().append(text);
##		
##    });
##	
##	jQuery('#stepOneForm').validate({
##		rules:{
##			category1:{required:true},
##			category2:{required:true},
##			category3:{required:true}
##			},
##		messages:{
##			category1:{required:"请选择一级类别"},
##			category2:{required:"请选择二级类别"},
##			category3:{required:"请选择三级类别"}
##		},
##		submitHandler:function(form){
##			form.submit();
##		}
##	});
##	
##	
##    function userCategory(){
##    	if(jQuery("#loginstatus").val()!="1" ){
##    		var loginbox=new Asto.util.PopupBox({
##    	  		url:"$!{address.myesite}/common/loginMini.htm",
##    		  	destUrl:"$!{address.myesite}/callback/login.htm",
##    	  		callbackFn:function(success, data){
##    	  			loginbox.close();
##    				Asto.util.Message.show({
##                        msg:"登录成功,正在重新载入页面,请稍候...",
##                        autoClose:10000
##                	});
##    				window.location.reload();
##    	  			jQuery("#loginstatus").val("1");
##    	 		},
##    			modal:true,
##    	  		width:510,
##    	  		height:400
##      		});
##    		loginbox.show();
##    	  	
##    	}else {
##    	    jQuery('#stepTwoForm').toggle();
##    	}
##    }
##</script>
