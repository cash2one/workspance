<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="message">

	<typeAlias alias="message" type="com.zz91.ep.domain.trade.Message" />
	<typeAlias alias="messageDto" type="com.zz91.ep.dto.trade.MessageDto" />

	<resultMap class="messageDto" id="fullColumnMap">
		<result property="message" resultMap="message.fullColumnResult" />
		<result property="cname" column="name" />
	</resultMap>

	<resultMap class="message" id="fullColumnResult">
		<result property="id" column="id" />
		<result property="uid" column="uid" />
		<result property="cid" column="cid" />
		<result property="targetUid" column="target_uid" />
		<result property="targetId" column="target_id" />
		<result property="targetCid" column="target_cid" />
		<result property="targetType" column="target_type" />
		<result property="title" column="title" />
		<result property="details" column="details" />
		<result property="readStatus" column="read_status" />
		<result property="replyStatus" column="reply_status" />
		<result property="replyDetails" column="reply_details" />
		<result property="gmtReply" column="gmt_reply" />
		<result property="gmtCreated" column="gmt_created" />
	</resultMap>

	<sql id="dynamicQueryMessagesByCompany">
		<dynamic prepend="where">
			<isNotEmpty property="type" prepend="and">
				ms.target_type = #type#
			</isNotEmpty>
			<isEqual property="sendStatus" compareValue="1" prepend="and">
				ms.target_cid = #cid# and ms.del_receive_status = 0
			</isEqual>
			<isEqual property="sendStatus" compareValue="0" prepend="and">
				 ms.cid = #cid# and ms.del_send_status = 0
			</isEqual>
			<isNotEmpty property="targetId" prepend="and">
				ms.target_id = #targetId#
			</isNotEmpty>
			<isNotEmpty property="replyStatus" prepend="and">
				ms.reply_status = #replyStatus#
			</isNotEmpty>
			<isNotEmpty property="readStatus" prepend="and">
				ms.read_status = #readStatus#
			</isNotEmpty>
		</dynamic>
	</sql>

	<sql id="fullColumn">
		ms.id,
		ms.uid,
		ms.cid,
		ms.target_uid,
		ms.target_cid,
		ms.target_id,
		ms.target_type,
		ms.title,
		ms.details,
		ms.read_status,
		ms.reply_status,
		ms.reply_details,
		ms.gmt_reply,
		ms.gmt_created
	</sql>
	<resultMap class="messageDto" id="messageDtoResultMap">
		<result property="uname" column="uname" />
		<result property="tcname" column="tcname" />
		<result property="gmtCreated" column="gmt_created"/>
	</resultMap>

	<insert id="insertMessage" parameterClass="message">
		insert into message(
		uid,
		cid,
		target_uid,
		target_cid,
		target_id,
		target_type,
		title,
		details,
		del_send_status,
		gmt_reply,
		gmt_created,
		gmt_modified)
		values(
		#uid#,
		#cid#,
		#targetUid#,
		#targetCid#,
		#targetId#,
		#targetType#,
		#title#,
		#details#,
		#delSendStatus#,
		now(),
		now(),
		now()
		)
		<selectKey keyProperty="id" resultClass="java.lang.Integer">
			select LAST_INSERT_ID()
		</selectKey>
	</insert>

	<sql id="dynamicInnerJoin">
		<isEqual property="sendStatus" compareValue="1">
			inner join comp_profile cp on cp.id=ms.cid
		</isEqual>
		<isEqual property="sendStatus" compareValue="0">
			inner join comp_profile cp on cp.id=ms.target_cid
		</isEqual>
	</sql>

	<select id="queryMessagesByCompanyCount" resultClass="java.lang.Integer"
		parameterClass="java.util.HashMap">
		select count(*) from message ms
		<include refid="dynamicInnerJoin" />
		<include refid="dynamicQueryMessagesByCompany" />
	</select>

	<select id="queryMessagesByCompany" resultMap="fullColumnMap"
		parameterClass="java.util.HashMap">
		select
		<include refid="fullColumn" />
		,cp.name
		from message ms
		<include refid="dynamicInnerJoin" />
		<include refid="dynamicQueryMessagesByCompany" />
		<include refid="common.pageOrderBy" />
		<include refid="common.pageLimit" />
	</select>

	<update id="updateMessageBysendStatus" parameterClass="java.util.Map">
		update message set
		gmt_modified = now()
		<isEqual property="sendStatus" compareValue="0">
			,del_send_status = 1
		</isEqual>
		<isEqual property="sendStatus" compareValue="1">
			,del_receive_status = 1
		</isEqual>
		where id = #id#
		<isEqual property="sendStatus" compareValue="0">
			and cid = #cid#
		</isEqual>
		<isEqual property="sendStatus" compareValue="1">
			and target_cid = #cid#
		</isEqual>
	</update>

	<update id="updateReplyMessage" parameterClass="java.util.Map">
		update message set
		reply_status = 1
		,reply_details = #replyMessage#
		,gmt_reply = now()
		,gmt_modified = now()
		where id = #id# and target_cid=#cid#
	</update>
	<select id="queryNewestMessage" parameterClass="java.util.Map"
		resultMap="messageDtoResultMap">
		SELECT ca.name  as uname,cp2.name as tcname,
		ms.gmt_created
		FROM message ms
		join comp_account ca on ms.uid=ca.id
		join comp_profile cp2
		on ms.target_cid=cp2.id
		<isNotEmpty property="messageType">
			where ms.target_type=#messageType#
		</isNotEmpty>
		order by
		ms.gmt_created desc
		limit #size#;
	</select>
	
	<select id="queryMessageById" parameterClass="java.util.HashMap" resultMap="fullColumnMap">
		select 
			<include refid="fullColumn"/>
			,cp.name 
		from message ms
			<include refid="dynamicInnerJoin"/>
		 where ms.id = #id#
	</select>
	
	<update id="updateReadStatus" parameterClass="java.util.HashMap" >
		update message set read_status = #readStatus# where id = #id#
	</update>
	
	<select id="queryMessageCountByReplyAndRead" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select count(*) from message where target_id = #id# and reply_status = #replyStatus# and read_status = #readStatus#
	</select>
	
</sqlMap>