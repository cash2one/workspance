
Ext.namespace("com.zz91.data.buy");
com.zz91.data.buy.SimpleField=["id","title","gmtPublish"];

com.zz91.data.buy.Grid=Ext.extend(Ext.grid.GridPanel,{
	constructor:function(config){
		config=config||{};
		Ext.apply(this,config);
		
		var _store=new Ext.data.JsonStore({
			root:"records",
			totalProperty:"totals",
			remoteSort:true,
			fields:com.zz91.data.buy.SimpleField,
			url:Context.ROOT+"/data/buy/queryBuy.htm",
			autoLoad:true
		});
		
		var grid=this;
		
		var _sm=new Ext.grid.CheckboxSelectionModel();
		
		var _cm=new Ext.grid.ColumnModel([_sm,{
			header:"编号",
			sortable:true,
			dataIndex:"id"
		},{
			header:"标题",
			width:500,
			dataIndex:"title"
		},{
			header:"发布时间",dataIndex:"gmtPublish",sortable:true,width:150,
			renderer : function(value, metadata, record, rowIndex,colIndex, store) {
				if(value!=null){
					return Ext.util.Format.date(new Date(value.time), 'Y-m-d H:i:s');
				}
			}
		}]);
		
		var _bbar=com.zz91.utils.pageNav(_store);
		
		var grid=this;
		
		var c={
			store:_store,
			sm:_sm,
			cm:_cm,
			loadMask:MESSAGE.loadmask,
			tbar:[{
				iconCls:"add16",
				text:"添加",
				handler:function(btn){
					window.open(Context.ROOT+"/data/buy/details.htm");
				}
			},{
				iconCls:"delete16",
				text:"删除",
				handler:function(btn){
					var row = grid.getSelectionModel().getSelections();
					if (row.length > 0) {
						Ext.MessageBox.confirm(Context.MSG_TITLE, '是否要删除选中的 ' + row.length + '条记录?', function(_btn){
							if (_btn != "yes")
								return;
							com.zz91.data.buy.deleteBuy(row, _store);
						});
					}
				}
			}],
			bbar:_bbar
		};
		
		com.zz91.data.buy.Grid.superclass.constructor.call(this,c);
	}

});

com.zz91.data.buy.deleteBuy=function(rows, store){
	for(var i=0;i<rows.length;i++){
		Ext.Ajax.request({
			url:Context.ROOT+"/data/buy/deleteBuy.htm",
			params:{"id":rows[i].get("id")},
			success:function(response,opt){
				var obj = Ext.decode(response.responseText);
				if(obj.success){
					store.reload();
				}else{
					com.zz91.utils.Msg(MESSAGE.TITLE, MESSAGE.submitFailure);
				}
			},
			failure:function(response,opt){
				com.zz91.utils.Msg(MESSAGE.TITLE, MESSAGE.submitFailure);
			}
		});
	}
}

com.zz91.data.buy.Form=Ext.extend(Ext.form.FormPanel,{
	constructor:function(config){
		config = config||{};
		Ext.apply(this,config);
		
		var form=this;
		
		var c={
			layout:"column",
			frame:true,
			labelAlign : "right",
			labelWidth : 80,
			items:[{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"求购标题",
					name:"title",
					itemCls:"required",
					allowBlank:false
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"公司名称",
					name:"companyName",
					itemCls:"required",
					allowBlank:false
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"公司联系电话",
					name:"telephone"
					
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"公司联系手机",
					name:"mobile",
					itemCls:"required",
					allowBlank:false,
					listeners:{
						"blur":function(field){
							if(field.getValue()==""){
								return false;
							}
							Ext.Ajax.request({
								url:Context.ROOT+"/data/buy/validateMobile.htm",
								params:{"mobile":field.getValue()},
								success:function(response,opt){
									var obj = Ext.decode(response.responseText);
									if(obj.success){
										Ext.MessageBox.show({
							                title:MESSAGE.title,
							                msg : "手机号码已经存在",
							                buttons:Ext.MessageBox.OK,
							                icon:Ext.MessageBox.INFO
							            });
									}
								},
								failure:function(response,opt){
									com.zz91.utils.Msg(MESSAGE.TITLE, MESSAGE.submitFailure);
								}
							});							
						}
					}
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"联系人",
					name:"name"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"email地址",
					name:"email"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"公司所在省份",
					name:"provinceName",
					itemCls:"required",
					allowBlank:false
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"公司所在地区/市",
					name:"areaName",
					itemCls:"required",
					allowBlank:false
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"公司详细地址",
					name:"address"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"采购类型",
					name:"buyType",
					value:"0"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"采购数量",
					name:"quantity"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"预计年采购量",
					name:"quantityYear"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"采购数量的单位",
					name:"quantityUnits"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"期望供应商所在地",
					name:"supplyAreaName"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"用途",
					name:"useTo"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"有效期天数",
					name:"validDays"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"留言/报价数量",
					name:"messageCount"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"查看次数",
					name:"viewCount"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"信息被收藏次数",
					name:"favoriteCount"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"信息被+1次数",
					name:"plusCount"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"生成静态页面的地址",
					name:"htmlPath"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"删除标记(0:未删除,1:已删除)",
					value:"0",
					name:"delStatus"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"审核状态(0:未审核,1:审核通过,2:审核不通过)",
					value:"1",
					name:"checkStatus"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"审核人账号",
					name:"checkAdmin"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"审核不通过原因",
					name:"checkRefuse"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					xtype:"datefield",
					fieldLabel:"审核时间",
					name:"gmtCheckStr",
					format:"Y-m-d H:i:s",
					value:new Date()
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					xtype:"datefield",
					fieldLabel:"发布时间",
					name:"gmtPublishStr",
					format:"Y-m-d H:i:s",
					value:new Date()
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"信息标签",
					name:"tags"
				}]
			},{
				columnWidth:.5,
				layout:"form",
				defaults:{
					anchor:"99%",
					xtype:"textfield",
					labelSeparator:""
				},
				items:[{
					fieldLabel:"所属分类",
					name:"categoryName",
					itemCls:"required",
					allowBlank:false
				}]
			},{
				columnWidth:1,
				layout:"form",
				items:[{
					xtype:"htmleditor",
					anchor:"99%",
					fieldLabel:"采购详细信息",
					name:"details",
					itemCls:"required",
					allowBlank:false
				}]
			}],
			buttons:[{
				text:"保存",
				handler:function(){
				 if(form.getForm().isValid()){
				    	form.getForm().submit({
			                url:Context.ROOT+"/data/buy/save.htm",
			                method:"post",
			                type:"json",
			                success:function(_form,_action){
								com.zz91.utils.Msg(MESSAGE.title, MESSAGE.saveSuccess);
								form.reset();
							},
							failure:function(_form,_action){
								Ext.MessageBox.show({
									title:MESSAGE.title,
									msg : MESSAGE.saveFailure,
									buttons:Ext.MessageBox.OK,
									icon:Ext.MessageBox.ERROR
								});
							}
			            });
				    }else{
			            Ext.MessageBox.show({
			                title:MESSAGE.title,
			                msg : MESSAGE.unValidate,
			                buttons:Ext.MessageBox.OK,
			                icon:Ext.MessageBox.ERROR
			            });
				    }
				}
			},{
				text:"重置",
//				scope:this,
				handler:function(){
					form.getForm().reset();
				}
			}]
		};
		
		com.zz91.data.buy.Form.superclass.constructor.call(this,c);
	},
	loadData:function(){
		
	}
});
