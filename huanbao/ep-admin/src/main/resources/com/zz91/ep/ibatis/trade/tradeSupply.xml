<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="tradeSupply">

    <typeAlias alias="tradeSupply" type="com.zz91.ep.domain.trade.TradeSupply"/>
    <typeAlias alias="tradeSupplyDto" type="com.zz91.ep.dto.trade.TradeSupplyDto"/>
    <typeAlias alias="compProfile" type="com.zz91.ep.domain.comp.CompProfile"/>
    <typeAlias alias="compAccount" type="com.zz91.ep.domain.comp.CompAccount"/>
    
    <resultMap class="tradeSupply" id="simpleDetailsResult">
        <result property="id" column="id"/>
        <result property="uid" column="uid"/>
        <result property="cid" column="cid"/>
        <result property="title" column="title"/>
        <result property="categoryCode" column="category_code"/>
        <result property="groupId" column="group_id"/>
        <result property="photoCover" column="photo_cover"/>
        <result property="provinceCode" column="province_code"/>
        <result property="areaCode" column="area_code"/>
        <result property="totalNum" column="total_num"/>
        <result property="totalUnits" column="total_units"/>
        <result property="priceNum" column="price_num"/>
        <result property="priceUnits" column="price_units"/>
        <result property="priceFrom" column="price_from"/>
        <result property="priceTo" column="price_to"/>
        <result property="useTo" column="use_to"/>
        <result property="tags" column="tags"/>
        <result property="usedProduct" column="used_product"/>
        <result property="propertyQuery" column="property_query"/>
        <result property="messageCount" column="message_count"/>
        <result property="viewCount" column="view_count"/>
        <result property="favoriteCount" column="favorite_count"/>
        <result property="plusCount" column="plus_count"/>
        <result property="htmlPath" column="html_path"/>
        <result property="integrity" column="integrity"/>
        <result property="pauseStatus" column="pause_status"/>
        <result property="checkStatus" column="check_status"/>
        <result property="gmtPublish" column="gmt_publish"/>
        <result property="gmtRefresh" column="gmt_refresh"/>
        <result property="validDays" column="valid_days"/>
        <result property="gmtExpired" column="gmt_expired"/>
        <result property="delStatus" column="del_status"/>
    </resultMap>

    <resultMap class="tradeSupply" id="longDetailsResult" extends="simpleDetailsResult">
        <result property="details" column="details"/>
    </resultMap>
    
    <resultMap class="tradeSupplyDto" id="longDetailsDtoMap">
        <result property="supply" resultMap="tradeSupply.shortSupplyResult"/>
        <result property="compName" column="name"/>
        <result property="isDel" column="delStatus"/>
        <result property="memberCodeBlock" column="member_code_block"/>
        <result property="rid" column="rid"/>
        <result property="memberCode" column="member_code"/>
    </resultMap> 
    
    <resultMap class="tradeSupply" id="shortSupplyResult">
        <result property="id" column="id"/>
        <result property="uid" column="uid"/>
        <result property="cid" column="cid"/>
        <result property="title" column="title"/>
        <result property="categoryCode" column="category_code"/>
        <result property="provinceCode" column="province_code"/>
        <result property="areaCode" column="area_code"/>
        <result property="tags" column="tags"/>
        <result property="propertyQuery" column="property_query"/>
        <result property="pauseStatus" column="pause_status"/>
        <result property="checkAdmin" column="check_admin"/>
        <result property="checkStatus" column="check_status"/>
        <result property="gmtPublish" column="gmt_publish"/>
        <result property="delStatus" column="del_status"/>
        <result property="gmtRefresh" column="gmt_refresh"/>
        <result property="gmtCheck" column="gmt_check"/>
        <result property="gmtExpired" column="gmt_expired"/>
    </resultMap>
    
    <resultMap class="tradeSupply" id="shortTradeSupplyResult">
         <result property="id" column="id"/>
         <result property="uid" column="uid"/>
         <result property="cid" column="cid"/>
         <result property="title" column="title"/>
    </resultMap>
    
    <resultMap class="tradeSupplyDto" id="shortSupplyDtoResult">
    	<result property="supply" resultMap="tradeSupply.shortSupplyResult"/>
    	<result property="compName" column="name"/>
    	<result property="isDel" column="delStatus"/>
    	<result property="memberCodeBlock" column="member_code_block"/>
   	    <result property="memberCode" column="member_code"/>
    </resultMap>
    
    <resultMap class="tradeSupply" id="topNewestSupplyMap">
    	<result property="id" column="id"/>
    	<result property="title" column="title"/>
    </resultMap>
    
    <resultMap class="tradeSupply" id="detailsResult" extends="simpleDetailsResult">
    	<result property="details" column="details"/>
    	<result property="checkAdmin" column="check_admin"/>
    	<result property="checkRefuse" column="check_refuse"/>
    	<result property="gmtCheck" column="gmt_check"/>
    	<result property="detailsQuery" column="details_query"/>
    	<result property="infoComeFrom" column="info_come_from"/>
    	<result property="tagsSys" column="tags_sys"/>
    </resultMap>
    
    <resultMap class="tradeSupply" id="simpSupplyResult">
    	 <result property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="gmtPublish" column="gmt_publish"/>
    </resultMap>
    
    <resultMap class="tradeSupply" id="codeAndPropertyMap">
    	<result property="categoryCode" column="category_code"/>
    	<result property="propertyQuery" column="property_query"/>
    </resultMap>
    
    <resultMap class="tradeSupply" id="simpBwResult">
    	<result property="id" column="id"/>
    	<result property="cid" column="cid"/>
    	<result property="title" column="title"/>
    	<result property="photoCover" column="photo_cover"/>
    	<result property="detailsQuery" column="details_query"/>
    	<result property="areaCode" column="area_code"/>
    	<result property="provinceCode" column="province_code"/>
    	<result property="priceNum" column="price_num"/>
    	<result property="priceUnits" column="price_units"/>
    </resultMap>
    
	<sql id="shortSupplyColumn">
		ts.id,
        ts.uid,
        ts.cid,
        ts.title,
        ts.category_code,
        ts.province_code,
        ts.area_code,
        ts.tags,
        ts.property_query,
        ts.pause_status,
		ts.check_admin,
        ts.check_status,
        ts.gmt_publish,
        ts.del_status,
        ts.gmt_refresh,
	    ts.gmt_check,
		ts.gmt_expired,
        cp.register_code,
        cp.name,
		cp.del_status as delStatus,
		cp.member_code_block,
        cp.member_code
	</sql>

    <sql id="simpleDetailsColumn">
        ts.id,
        ts.uid,
        ts.cid,
        ts.title,
        ts.category_code,
        ts.group_id,
        ts.photo_cover,
        ts.province_code,
        ts.area_code,
        ts.total_num,
        ts.total_units,
        ts.price_num,
        ts.price_units,
        ts.price_from,
        ts.price_to,
        ts.use_to,
        ts.tags,
        ts.used_product,
        ts.property_query,
        ts.message_count,
        ts.view_count,
        ts.favorite_count,
        ts.plus_count,
        ts.html_path,
        ts.integrity,
        ts.pause_status,
        ts.check_status,
        ts.gmt_publish,
        ts.gmt_refresh,
        ts.valid_days,
        ts.gmt_expired,
        ts.del_status
    </sql>
	
    <sql id="normalWhere">
        ts.check_status = 1
        and ts.pause_status = 0
        and ts.del_status = 0
    </sql>
	<!-- 
	<resultMap class="tradeSupply" id="shortDetailsResult" extends="simpleDetailsResult">
        <result property="detailsQuery" column="details_query"/>
    </resultMap>
    
    <resultMap class="tradeSupply" id="newestSupplyMap">
    	<result property="id" column="id"/>
    	<result property="cid" column="cid"/>
        <result property="title" column="title"/>
        <result property="priceNum" column="price_num"/>
        <result property="priceUnits" column="price_units"/>
        <result property="photoCover" column="photo_cover"/>
    </resultMap>
    
    <resultMap class="tradeSupply" id="simpRecommendSupplyResult">
    	<result property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="priceNum" column="price_num"/>
        <result property="priceUnits" column="price_units"/>
        <result property="photoCover" column="photo_cover"/>
    </resultMap>
    
   	<resultMap class="tradeSupplyDto" id="simpleDetailsMap">
        <result property="supply" resultMap="tradeSupply.simpleDetailsResult"/>
        <result property="compName" column="name"/>
    </resultMap>

    <resultMap class="compProfile" id="simpCompResult">
    	<result property="id" column="cid"/>
    	<result property="name" column="name"/>
    </resultMap>
    
    <resultMap class="tradeSupplyDto" id="longDetailsMap">
        <result property="supply" resultMap="tradeSupply.longDetailsResult"/>
        <result property="compName" column="name"/>
    </resultMap> 
    
   	<resultMap class="tradeSupplyDto" id="shortDetailsMap">
        <result property="supply" resultMap="tradeSupply.shortDetailsResult"/>
        <result property="compName" column="name"/>
        <result property="businessCode" column="business_code"/>
    </resultMap>
    
    <select id="queryShortDetailsById" resultMap="shortDetailsMap" parameterClass="java.lang.Integer">
        select
            <include refid="simpleDetailsColumn"/>
            ,ts.details_query
            ,cp.name,cp.business_code
        from 
            trade_supply ts
        inner join comp_profile cp on cp.id=ts.cid
        where
            <include refid="normalWhere"/>
            and ts.id = #id#
    </select>
    <select id="queryLongDetailsById" resultMap="longDetailsMap" parameterClass="java.lang.Integer">
        select
            <include refid="simpleDetailsColumn"/>
            ,ts.details
            ,cp.name
        from 
            trade_supply ts
        inner join comp_profile cp on cp.id=ts.cid
        where
            <include refid="normalWhere"/>
            and ts.id = #id#
    </select>
    
   	<sql id="dynamicConditionsWhere">
        <dynamic prepend="where">
            ts.cid = #cid# and ts.del_status = 0
            <isNotEmpty property="pauseStatus">
                and ts.pause_status = #pauseStatus#
            </isNotEmpty>
            <isNotEmpty property="checkStatus">
                and ts.check_status = #checkStatus#
            </isNotEmpty>
            <isNotEmpty property="groupId">
                and ts.group_id = #groupId#
            </isNotEmpty>
            <isEqual property="overdueStatus" compareValue="0">
                and (now() > ts.gmt_expired and ts.valid_days !=0)
            </isEqual>
            <isEqual property="overdueStatus" compareValue="1">
                and (ts.gmt_expired > now() or ts.valid_days ==0)
            </isEqual>
            <isNotEmpty property="recommend">
                and tr.type=2
            </isNotEmpty>
        </dynamic>
   	</sql>
   	
   <select id="querySupplyByConditions" resultMap="shortDetailsResult" parameterClass="java.util.Map">
        select
            <include refid="simpleDetailsColumn"/>
            ,ts.details_query
        from 
            trade_supply ts
        <isNotEmpty property="recommend">
        	inner join trade_recommend tr on tr.target_id=ts.id
        </isNotEmpty>
        <include refid="dynamicConditionsWhere"/>
        <include refid="common.pageOrderBy"/>
        <include refid="common.pageLimit"/>
    </select>
    
   <select id="querySupplyByConditionsCount" resultClass="java.lang.Integer" parameterClass="java.util.Map">
        select count(*)
        from 
            trade_supply ts
        <isNotEmpty property="recommend">
        	inner join trade_recommend tr on tr.target_id=ts.id
        </isNotEmpty>
        <include refid="dynamicConditionsWhere"/>
    </select>
    
   	<update id="updateBaseSupplyById" parameterClass="java.util.Map">
        update trade_supply set
            title = #supply.title#,
            details = #supply.details#,
            province_code = #supply.provinceCode#,
            area_code = #supply.areaCode#,
            total_num = #supply.totalNum#,
            total_units = #supply.totalUnits#,
            price_num = #supply.priceNum#,
            price_units = #supply.priceUnits#,
            price_from  = #supply.priceFrom#,
            price_to = #supply.priceTo#,
            tags = #supply.tags#,
            use_to = #supply.useTo#,
            used_product = #supply.usedProduct#,
            details_query = #supply.detailsQuery#,
            check_status = #supply.checkStatus#,
            valid_days = #supply.validDays#,
            gmt_modified = now()
        where id = #id# and cid=#cid#
    </update>
    
   	<update id="updateCategoryById" parameterClass="java.util.Map">
        update trade_supply set
            category_code = #category#,
            property_query = #propertyValue#,
            gmt_modified = now()
        where id = #id# and cid=#cid#
    </update>
    
  	<update id="updatePauseStatusById" parameterClass="java.util.Map">
        update trade_supply set
            pause_status = #newStatus#
            ,gmt_modified = now()
        where id = #id# and cid=#cid#
    </update>
    
   	<update id="updateRefreshById" parameterClass="java.util.Map">
        update trade_supply set
            gmt_refresh = now(),
            gmt_expired = date_add(now(),INTERVAL valid_days day),
            gmt_modified=now()
        where id = #id# and cid=#cid#
    </update>
    
  	<update id="updateSupplyGroupIdById" parameterClass="java.util.Map">
        update trade_supply set
            group_id = #gid#
            ,gmt_modified = now()
        where id = #id# and cid=#cid#
    </update>
    
    <select id="queryUpdateSupplyById" resultMap="longDetailsMap" parameterClass="java.util.Map">
        select
            <include refid="simpleDetailsColumn"/>
            ,ts.details
            ,cp.name
        from 
            trade_supply ts
        inner join comp_profile cp on cp.id=ts.cid
        where
            ts.id = #id# and ts.cid=#cid#
            and ts.del_status = 0
    </select>
    
 	<select id="querySupplyByCategoryCode" parameterClass="java.util.HashMap" resultMap="longDetailsMap">
		select 
		<include refid="simpleDetailsColumn"/>
		 ,ts.details
		,cp.name
		from trade_supply ts
		inner join comp_profile cp on cp.id=ts.cid
		where ts.category_code like concat(#dto.supply.categoryCode#,'%')
		<include refid="common.pageOrderBy"/>
		<include refid="common.pageLimit"/>
	</select>
	
	<select id="querySupplysCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select count(*)
		from trade_supply
		where category_code like concat(#dto.supply.categoryCode#,'%')
	</select>
	
	<select id="querySupplyCountByCategory" parameterClass="java.lang.String" resultClass="java.lang.Integer">
		select count(*) from trade_supply 
		where 
			category_code like concat(#value#,'%')
			and del_status = 0
			and pause_status = 0
			and check_status=1
	</select>
	
	<select id="queryAllSupplyCount" resultClass="java.lang.Integer">
		select count(*) from trade_supply
	</select>
	
	<select id="queryWeekSupplyCount" resultClass="java.lang.Integer">
		select count(*) from trade_supply
		where WEEK(gmt_created) = WEEK(now())
	</select>
	
	<update id="updatePropertyQueryById" parameterClass="java.util.Map">
        update trade_supply 
        set property_query = concat(property_query,#properyValue#,";"),
        gmt_refresh=now(),
        gmt_modified=now()
        where id=#id#
    </update>
    
   	<select id="queryCompByKeywords" parameterClass="java.util.HashMap" resultMap="simpCompResult">
    	select distinct ts.cid,c.name
    	from trade_supply ts
    	left join comp_profile c on c.id=ts.cid
    	where ts.title like concat('%',#keywords#,'%') and c.name is not null and c.name !=''
    	order by ts.gmt_created desc
    	limit #size# 
    </select>
    
   	<select id="querySupplysByKeywords" parameterClass="java.util.Map" resultMap="simpleDetailsMap">
        select
            <include refid="simpleDetailsColumn"/>
            ,cp.name
        from 
            trade_supply ts
        inner join comp_profile cp on cp.id=ts.cid
        where ts.title like concat('%',#keywords#,'%')
        order by ts.gmt_publish desc
        limit #size#
    </select>
    
   	<select id="queryRecommendSupply" parameterClass="java.util.Map" resultMap="simpRecommendSupplyResult">
        select
       		ts.id,
	        ts.title,
	        ts.price_num,
	        ts.price_units,
	        ts.photo_cover
        from 
            trade_recommend tr
        inner join trade_supply ts on tr.target_id=ts.id and tr.type=2
        <isNotEmpty property="cid">
			where tr.cid=#cid#
		</isNotEmpty>
            order by ts.gmt_refresh desc
        <isNotEqual property="size" compareValue="0">
           limit #size#
        </isNotEqual>
    </select>
    
   	<select id="queryRecommendSupplyC" parameterClass="java.util.Map" resultMap="simpRecommendSupplyResult">
        select
       		ts.id,
	        ts.title,
	        ts.price_num,
	        ts.price_units,
	        ts.photo_cover
        from 
            trade_recommend tr
        inner join trade_supply ts on tr.target_id=ts.id and tr.type=0
        <isNotEmpty property="cid">
			where tr.cid=#cid#
		</isNotEmpty>
            order by ts.gmt_refresh desc
        <isNotEqual property="size" compareValue="0">
           limit #size#
        </isNotEqual>
    </select>
    
   	<select id="queryNewSimplySupply" parameterClass="java.util.HashMap" resultMap="simpSupplyResult">
    	select
        id,title,gmt_publish
        from trade_supply
        where  category_code like concat(#code#,'%')
        order by gmt_refresh desc
        limit #size#
    </select>
    
	<select id="queryNewestSupply" parameterClass="java.util.Map" resultMap="newestSupplyMap">
		select id,title,photo_cover,price_num,price_units,cid 
		from trade_supply 
		where del_status = 0 and pause_status = 0 and check_status=1 and category_code like concat(#code#,'%')
		order by gmt_publish desc limit #size#
	</select>
	
	<select id="querySupplyByCompanyCount" parameterClass="java.util.HashMap"
        resultClass="java.lang.Integer">
        select count(*) from trade_supply ts
        <include refid="dynamicQuerySupplyByCompany"/>
    </select>

    <select id="querySupplyByCompany" resultMap="shortDetailsResult"
        parameterClass="java.util.HashMap">
        select
        <include refid="simpleDetailsColumn"/>
        ,ts.details_query
        from trade_supply ts
        <include refid="dynamicQuerySupplyByCompany"/>
        <include refid="common.pageOrderBy"/>
        <include refid="common.pageLimit"/>
    </select>
    
    <sql id="dynamicQuerySupplyByCompany">
        <dynamic prepend="where">
            <include refid="normalWhere"/>
            <isNotEmpty property="cid">
                and ts.cid=#cid#
            </isNotEmpty>
            <isNotEmpty property="group">
            	and ts.group_id=#group#
            </isNotEmpty>
            <isNotEmpty property="categoryCode">
                and ts.category_code = #categoryCode#
            </isNotEmpty>
            <isNotEmpty property="keywords">
                and ts.title like concat('%',#keywords#,'%')
            </isNotEmpty>
        </dynamic>
    </sql>
	 -->

	<select id="queryTopNewestSupply" parameterClass="java.util.Map" resultMap="topNewestSupplyMap">
		select id,title 
		from trade_supply 
		where del_status = 0 and pause_status = 0 and check_status=1 
		<isNotEmpty property="cid">
        	and cid=#cid#
        </isNotEmpty>
		order by gmt_publish desc limit #max#
	</select>

    <insert id="insertTradeSupply" parameterClass="tradeSupply">
        insert into trade_supply
            (
            uid,
            cid,
            title,
            details,
            category_code,
            province_code,
            area_code,
            total_num,
            total_units,
            price_num,
            price_units,
            price_from,
            price_to,
            use_to,
            used_product,
            tags,
            tags_sys,
            details_query,
            property_query,
            html_path,
            integrity,
            gmt_publish,
            gmt_refresh,
            valid_days,
            check_status,
            gmt_created,
            gmt_modified,
            gmt_expired,
            photo_cover,
            info_come_from)
            VALUES
            (
            #uid#,
            #cid#,
            #title#,
            #details#,
            #categoryCode#,
            #provinceCode#,
            #areaCode#,
            #totalNum#,
            #totalUnits#,
            #priceNum#,
            #priceUnits#,
            #priceFrom#,
            #priceTo#,
            #useTo#,
            #usedProduct#,
            #tags#,
            #tagsSys#,
            #detailsQuery#,
            #propertyQuery#,
            #htmlPath#,
            #integrity#,
            #gmtPublish#,
            #gmtRefresh#,
            #validDays#,
            #checkStatus#,
            now(),
            now(),
            #gmtExpired#,
            #photoCover#,
            #infoComeFrom#
            )
            <selectKey keyProperty="id" resultClass="java.lang.Integer">
                select LAST_INSERT_ID()
            </selectKey>
    </insert>

    <update id="updatePhotoCoverById" parameterClass="java.util.Map">
        update trade_supply 
            set photo_cover = #photoCover#,
            gmt_modified=now()
        where id = #id#
    </update>

    <update id="updateMessageCount" parameterClass="java.lang.Integer">
        update trade_supply 
            set message_count = message_count+1,
            gmt_modified = now()
        where id = #id#
    </update>

    <delete id="deleteSupplyById" parameterClass="java.lang.Integer">
    	delete 
    	from trade_supply
    	where id=#id#
    </delete>
    
    <update id="updateStatusOfTradeSupply" parameterClass="java.util.HashMap">
		update trade_supply 
		set check_status=#checkStatus#,
		gmt_check=now(),
		gmt_modified=now()
		where id=#id#
	</update>
	<update id="updateSupplyCheckStatus" parameterClass="java.util.HashMap">
		update trade_supply 
		set check_status=#checkStatus#,
		check_admin=#check_admin#,
		check_refuse=#check_refuse#,
		gmt_modified=now()
		where id=#id#
	</update>
    
    <select id="countTradeSupply" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
    	select count(*) from trade_supply
    	where 
    	uid=#uid# and cid=#cid# and title=#title#
    </select>
 
     <sql id="dynamicByAdmin">
		<dynamic prepend="where" >
			<isNotEmpty property="dto.supply.categoryCode" prepend="and">
				ts.category_code like concat(#dto.supply.categoryCode#,'%')
			</isNotEmpty>
			<isNotEmpty property="dto.supply.title" prepend="and">
				ts.title like concat('%',#dto.supply.title#,'%')
			</isNotEmpty>
			<isNotEmpty property="dto.supply.checkStatus" prepend="and">
				ts.check_status=#dto.supply.checkStatus#
			</isNotEmpty>
			<isNotEmpty property="dto.supply.checkAdmin" prepend="and">
				ts.check_admin=#dto.supply.checkAdmin#
			</isNotEmpty>
			<isNotEmpty property="dto.supply.delStatus" prepend="and">
				ts.del_status=#dto.supply.delStatus#
			</isNotEmpty>
			<isNotEmpty property="dto.supply.cid" prepend="and">
				ts.cid=#dto.supply.cid#
			</isNotEmpty>
			<isNotEmpty property="dto.supply.infoComeFrom" prepend="and">
				ts.info_come_from=#dto.supply.infoComeFrom#
			</isNotEmpty>
			<isEqual property="queryType" compareValue="0">
				<isNotEmpty prepend="and" property="gmtPublishStart">
	                ts.gmt_publish > #gmtPublishStart# 
				</isNotEmpty>
				<isNotEmpty prepend="and" property="gmtPublishEnd">
	                #gmtPublishEnd# > ts.gmt_publish
				</isNotEmpty>
            </isEqual>
            <isEqual property="queryType" compareValue="1">
            	<isNotEmpty prepend="and" property="gmtPublishStart">
	                ts.gmt_refresh > #gmtPublishStart# 
				</isNotEmpty>
				<isNotEmpty prepend="and" property="gmtPublishEnd">
	                #gmtPublishEnd# > ts.gmt_refresh
				</isNotEmpty>
            </isEqual>
            <isEqual property="queryType" compareValue="2">
            	<isNotEmpty prepend="and" property="gmtPublishStart">
	                ts.gmt_check > #gmtPublishStart# 
				</isNotEmpty>
				<isNotEmpty prepend="and" property="gmtPublishEnd">
	                #gmtPublishEnd# > ts.gmt_check
				</isNotEmpty>
            </isEqual>
			<isNotEmpty property="dto.compName" prepend="and">
				cp.name like concat(#dto.compName#,'%')
			</isNotEmpty>
			<isNotEmpty property="subRecommend" prepend="and">
				str.subnet_category=#subRecommend#
			</isNotEmpty>
			<isNotEmpty property="memberCode" prepend="and">
				cp.member_code= #memberCode#
			</isNotEmpty>
			<isNotEmpty property="codeBlock" prepend="and">
				cp.member_code_block = #codeBlock#
			</isNotEmpty>
		</dynamic>
		</sql>
	 <select id="querySupplyByCategoryCodeAndTitleAndCheckStatus" parameterClass="java.util.HashMap" resultMap="longDetailsDtoMap">
		select 
		<include refid="shortSupplyColumn"/>
		<isNotEmpty property="recommendType">
			,trr.id as rid
		</isNotEmpty>
		<isEmpty property="recommendType">
			,0 as rid
		</isEmpty>
		from trade_supply ts
		inner join comp_profile cp on cp.id=ts.cid
		<isNotEmpty property="recommendType">
			inner join (select tr.id,tr.target_id from trade_recommend tr where tr.type=#recommendType#) trr on trr.target_id=ts.id
		</isNotEmpty>
		<isNotEmpty property="subRecommend">
			left join  subnet_trade_recommend str on str.supply_id=ts.id
		</isNotEmpty>
		<include refid="tradeSupply.dynamicByAdmin"/>
		order by ts.gmt_publish desc
		<!--<isNotEmpty property="page.sort">-->
		<!--	order by ts.$page.sort$ desc  -->
		<!--</isNotEmpty>  -->
		<include refid="common.pageLimit"/>
	</select>
	
	<select id="querySupplysCountByTitleAndCheckStatus" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select count(0)
		from trade_supply ts
		<isNotEmpty property="compProfile">
			inner join comp_profile cp on cp.id=ts.cid
		</isNotEmpty>
		<isNotEmpty property="recommendType">
			inner join (select tr.id,tr.target_id from trade_recommend tr where tr.type=#recommendType#) trr on trr.target_id=ts.id
		</isNotEmpty>
		<isNotEmpty property="subRecommend">
			left join  subnet_trade_recommend str on str.supply_id=ts.id
		</isNotEmpty>
		<include refid="tradeSupply.dynamicByAdmin"/>
	</select>
    
  <select id="querySupplyCount" parameterClass="java.lang.Integer" resultClass="java.lang.Integer">
		select count(*) from trade_supply 
		where cid=#cid#
		and del_status = 0
		and pause_status = 0
		and check_status=1
	</select>
	
	<sql id="dynamicSupplyByAdmin">
		<dynamic prepend="where">
			<isNotEmpty property="tradeSupply.cid">
				ts.cid=#tradeSupply.cid#
			</isNotEmpty>
			<isNotEmpty property="tradeSupply.title" prepend="and">
				ts.title like concat(#tradeSupply.title#,'%')
			</isNotEmpty>
			<isNotEmpty property="tradeSupply.checkStatus" prepend="and">
				ts.check_status=#tradeSupply.checkStatus#
			</isNotEmpty>
			<isNotEmpty property="type">
				 and ts.cid in (select tr.cid from trade_recommend tr where tr.type=#type# and tr.target_id=ts.id) 
			</isNotEmpty>
		</dynamic>
	</sql>
	
	<select id="querySupplyByAdmin" parameterClass="java.util.HashMap" resultMap="shortSupplyDtoResult">
		select 
		<include refid="tradeSupply.shortSupplyColumn"/>
		from trade_supply ts
		inner join comp_profile cp on cp.id=ts.cid
		<include refid="tradeSupply.dynamicSupplyByAdmin"/>
		<include refid="common.pageOrderBy"/>
		<include refid="common.pageLimit"/>
	</select>
	
	<select id="querySupplyByAdminCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select count(*)
		from trade_supply ts
		inner join comp_profile cp on cp.id=ts.cid
		<include refid="tradeSupply.dynamicSupplyByAdmin"/>
	</select>
	<select id="queryOneSupplyById" parameterClass="java.lang.Integer" resultMap="detailsResult">
		select 
		<include refid="simpleDetailsColumn"/>
		,ts.details,ts.check_admin,ts.check_refuse,
		ts.gmt_check,ts.details_query,ts.info_come_from,ts.tags_sys
		from trade_supply ts
		where ts.id=#id#
	</select>
	
	<update id="updateTradeSupply" parameterClass="tradeSupply">
		update `trade_supply`
		set
		`uid` = #uid#,
		`cid` = #cid#,
		`category_code` = #categoryCode#,
		`title` = #title#,
		`details` = #details#,
		`group_id` = #groupId#,
		`province_code` = #provinceCode#,
		`area_code` = #areaCode#,
		`total_num` = #totalNum#,
		`total_units` = #totalUnits#,
		`price_num` = #priceNum#,
		`price_units` = #priceUnits#,
		`price_from` = #priceFrom#,
		`price_to` = #priceTo#,
		`use_to` = #useTo#,
		`used_product` = #usedProduct#,
		`tags` = #tags#,
		`tags_sys` = #tagsSys#,
		<isNotEmpty property="detailsQuery">
			`details_query` = #detailsQuery#,
		</isNotEmpty>
		<isNotEmpty property="propertyQuery">
			`property_query` = #propertyQuery#,
		</isNotEmpty>
		<isNotEmpty property="messageCount">
			`message_count` = #messageCount#,
		</isNotEmpty>
		<isNotEmpty property="viewCount">
			`view_count` = #viewCount#,
		</isNotEmpty>
		<isNotEmpty property="favoriteCount">
			`favorite_count` = #favoriteCount#,
		</isNotEmpty>
		<isNotEmpty property="plusCount">
			`plus_count` = #plusCount#,
		</isNotEmpty>
		<isNotEmpty property="htmlPath">
			`html_path` = #htmlPath#,
		</isNotEmpty>
		
		`integrity` = #integrity#,
		`valid_days` = #validDays#,
		<isNotEmpty property="delStatus">
			`del_status` = #delStatus#,
		</isNotEmpty>
		<isNotEmpty property="pauseStatus">
			`pause_status` = #pauseStatus#,
		</isNotEmpty>
		
		`check_admin` = #checkAdmin#,
		`check_refuse` = #checkRefuse#,
		<isNotEmpty property="gmtPublish">
			`gmt_publish` = #gmtPublish#,
		</isNotEmpty>
		<isNotEmpty property="gmtRefresh">
			`gmt_refresh` = #gmtRefresh#,
		</isNotEmpty>
		<isNotEmpty property="gmtExpired">
			`gmt_expired` = #gmtExpired#,
		</isNotEmpty>
		<isNotEmpty property="infoComeFrom">
			`info_come_from` = #infoComeFrom#,
		</isNotEmpty>
		`gmt_check`=now(),
		`gmt_modified` = now()
		where id=#id#
	</update>
	
	<select id="queryCidById" parameterClass="java.lang.Integer" resultClass="java.lang.Integer">
		select cid from trade_supply
		where id=#id#
	</select>
	
	<update id="updateUnPassCheckStatus" parameterClass="java.util.HashMap">
		update `trade_supply`
		set
		`check_status` = #checkStatus#,
		`check_admin` = #checkAdmin#,
		`check_refuse`= #checkRefuse#,
		`gmt_check`= now(),
		`gmt_modified` = now()
		where id=#id#
	</update>
	
	<update id="updateDelStatus" parameterClass="java.util.HashMap">
		update trade_supply
		set
		del_status=#delStatus#,
		gmt_modified=now()
		where id=#id#
	</update>
	
	<select id="queryCategoryCodeById" parameterClass="java.lang.Integer" resultClass="java.lang.String">
		select category_code
		from trade_supply
		where id=#id#
	</select>
	
	<update id="updateGmtRefresh" parameterClass="java.util.HashMap">
		update trade_supply 
		set gmt_refresh=now(),
		gmt_expired = #gmtExpired#,
		valid_days = #validDays#,
		gmt_modified=now()
		where id=#id#
	</update>
    
    <update id="updatePropertyQueryAllById" parameterClass="java.util.Map">
        update trade_supply 
        set property_query = #properyValue#,
        gmt_refresh=now(),
        gmt_modified=now()
        where id=#id#
    </update>
    
    <select id="queryPropertyQueryById" parameterClass="java.lang.Integer" resultClass="java.lang.String">
    	select property_query 
    	from trade_supply
    	where id=#id#
    </select>
    
    <select id="querySupplyByKeywords" parameterClass="java.util.HashMap" resultMap="simpSupplyResult">
    	select
        id,title,gmt_publish
        from trade_supply
        where title like concat('%',#keywords#,'%')
        order by gmt_publish desc
        limit #size#
    </select>

    <update id="updateCategoryCodeById" parameterClass="java.util.HashMap" >
    	update trade_supply 
    	set category_code=#categoryCode#,
    	gmt_modified=now()
    	where id=#id#
    </update>

    <select id="querySimplyByKeywords" parameterClass="java.util.HashMap" resultMap="shortTradeSupplyResult">
	    	select t.id,t.cid,t.uid,t.title
			from trade_supply t
			where t.del_status = 0 and t.check_status = 1 and t.pause_status = 0
			<isNotEmpty property="compName" prepend="and">
			exists (select c.id from comp_profile c where c.id = t.cid and c.name=#compName#)
			</isNotEmpty>
			<isNotEmpty property="loginCount" prepend="and">
			exists (select ca.id from comp_account ca where ca.id=t.uid and ca.login_count=#loginCount# )
			</isNotEmpty>
			<isNotEmpty property="keywords" prepend="and">
			t.title like concat(#keywords#,'%')
			</isNotEmpty>
			group by cid
			limit 500
    </select>
    
    <update id="updateGmtmodifiedBySvrClose" parameterClass="java.lang.Integer">
    	update trade_supply
		set
		gmt_modified=now()
		where cid=#cid#
    </update>
    
    <select id="queryPropertyQueryAndCategoryCodeById" parameterClass="java.lang.Integer" resultMap="codeAndPropertyMap">
    	select category_code,property_query 
    	from trade_supply
    	where id=#id#
    </select>
    <select id="queryMaxId" resultClass="java.lang.Integer">
       select max(id) from trade_supply where 10000000 > id
    </select>
    
    <!-- 标王信息查询 -->
    <select id="queryShortBwDetailsById" parameterClass="java.lang.Integer" resultMap="simpBwResult">
    	select 
    	id,cid,title,photo_cover,details_query,area_code,
    	province_code,price_num,price_units
    	from trade_supply ts
    	where  
    	<include refid="tradeSupply.normalWhere"/>
    	and ts.id=#sid#
    </select>
    
    <resultMap class="tradeSupply" id="simplyDataResultMap">
        <result property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="gmtPublish" column="gmt_publish"/>
    </resultMap>
    
    <select id="querySupplys" parameterClass="java.util.HashMap" resultMap="simplyDataResultMap">
    	select id,title,gmt_publish 
    	from trade_supply
    	where del_status=0
    	<!-- 
    	<include refid="common.pageOrderBy"/>
    	 -->
    	order by gmt_publish desc
        <include refid="common.pageLimit"/>
    </select>
    
    <select id="querySupplysCount" resultClass="java.lang.Integer">
     	select count(*) from trade_supply where del_status=0
    </select>
</sqlMap>
