<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="phoneLog">
	<typeAlias alias="phoneLogDO" type="com.ast.ast1949.domain.phone.PhoneLog" />
	<resultMap class="phoneLogDO" id="phoneLogResult">
		<result property="id" column="id" />
		<result property="callerId" column="caller_id" />
		<result property="tel" column="tel" />
		<result property="callFee" column="call_fee" />
		<result property="startTime" column="start_time" />
		<result property="endTime" column="end_time" />
		<result property="gmtCreated" column="gmt_created" />
		<result property="gmtModified" column="gmt_modified" />
		<result property="callSn" column="call_sn" />
	</resultMap>

	<sql id="defaultColumn">
		id,
		caller_id,
		tel,
		call_fee,
		start_time,
		gmt_created,
		gmt_modified,
		end_time,
		call_sn
	</sql>
	
	<select id="queryByCallSn" parameterClass="java.lang.String" resultMap="phoneLogResult">
		select 
		<include refid="defaultColumn" />
		from phone_log
		where call_sn = #callSn#
		limit 1
	</select>

	<insert id="insert" parameterClass="phoneLogDO">
		INSERT INTO phone_log
		(
		caller_id,
		tel,
		call_fee,
		start_time,
		gmt_created,
		gmt_modified,
		end_time,
		call_sn)
		VALUES
		(
		#callerId#,
		#tel#,
		#callFee#,
		#startTime#,
		now(),
		now(),
		#endTime#,
		#callSn#
		)
		<selectKey keyProperty="id" resultClass="java.lang.Integer">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
	</insert>

	<sql id="whereClause">
		<dynamic prepend="where">
			<isNotEmpty prepend="and" property="phoneLog.tel">
				tel = #phoneLog.tel#
			</isNotEmpty>
		</dynamic>
	</sql>

	<select id="queryList" parameterClass="java.util.Map" resultMap="phoneLogResult">
		SELECT
		<include refid="defaultColumn" />
		FROM phone_log
		<include refid="whereClause" />
		<include refid="common.pageOrderBy" />
		<include refid="common.pageLimit" />
	</select>

	<select id="queryListCount" parameterClass="java.util.Map"
		resultClass="java.lang.Integer">
		SELECT count(0)
		FROM phone_log
		<include refid="whereClause" />
	</select>
	
	<select id="countCallFee" parameterClass="java.lang.String" resultClass="java.lang.String">
		SELECT sum(call_fee) 
		FROM phone_log 
		where tel = #tel#
	</select>


</sqlMap>