<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bbsPost">
	<typeAlias alias="bbsPostDO" type="com.ast.ast1949.domain.bbs.BbsPostDO" />
	<typeAlias alias="bbsPostType" type="com.ast.ast1949.domain.bbs.BbsPostType" />

	<resultMap id="simplePostResult" class="bbsPostDO">
		<result property="id" column="id" />
		<result property="account" column="account" />
		<result property="companyId" column="company_id" />
		<result property="bbsUserProfilerId" column="bbs_user_profiler_id" />
		<result property="bbsPostCategoryId" column="bbs_post_category_id" />
		<result property="title" column="title" />
		<result property="visitedCount" column="visited_count" />
		<result property="replyCount" column="reply_count" />
		<result property="postTime" column="post_time" />
		<result property="replyTime" column="reply_time" />
		<result property="integral" column="integral" />
		<result property="checkStatus" column="check_status" />
		<result property="postType" column="post_type" />
		<result property="checkTime" column="check_time" />
		<result property="isDel" column="is_del" />
		<result property="content" column="content" />
	</resultMap>

	<typeAlias alias="profiler"
		type="com.ast.ast1949.domain.bbs.BbsUserProfilerDO" />
	<typeAlias alias="postDto" type="com.ast.ast1949.dto.bbs.PostDto" />

	<resultMap id="profilerResult" class="profiler">
		<result property="id" column="profiler_id" />
		<result property="nickname" column="nickname" />
		<result property="realName" column="real_name" />
		<result property="integral" column="integral" />
		<result property="postNumber" column="post_number" />
		<result property="replyNumber" column="reply_number" />
		<result property="essenceNumber" column="essence_number" />
	</resultMap>

	<resultMap id="postDtoResult" class="postDto">
		<result property="post" resultMap="bbsPost.simplePostResult" />
		<result property="profiler" resultMap="bbsPost.profilerResult" />
	</resultMap>

	<sql id="dynmicPostByCategory">
		where p.is_del='0' and (p.check_status='1' or
		p.check_status='2')
		<isNotNull prepend="and" property="categoryId">
			p.bbs_post_category_id=#categoryId#
		</isNotNull>
	</sql>

	<sql id="simplePostColumn">
		p.id,p.account,p.company_id,p.bbs_user_profiler_id,p.bbs_post_category_id,
		p.title,p.visited_count,p.reply_count,p.post_time,p.content,
		p.reply_time,p.integral,p.check_status,p.post_type,p.check_time,p.is_del
	</sql>

	<sql id="simpleProfilerColumn">
		pf.id as profiler_id,
		pf.nickname,pf.real_name,pf.integral,pf.post_number,
		pf.reply_number,pf.essence_number
	</sql>

	<select id="queryPostByCategory" parameterClass="java.util.HashMap"
		resultMap="postDtoResult">
		select
		<include refid="bbsPost.simplePostColumn" />
		,
		<include refid="bbsPost.simpleProfilerColumn" />
		from bbs_post p
		left join bbs_user_profiler pf on p.account=pf.account
		<include refid="bbsPost.dynmicPostByCategory" />
		<include refid="common.pageOrderBy" />
		<include refid="common.pageLimit" />
	</select>

	<select id="queryPostByCategoryCount" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		select count(*)
		from bbs_post p
		<include refid="bbsPost.dynmicPostByCategory" />
	</select>

	<resultMap id="postDtoWithContentResult" class="postDto">
		<result property="post" resultMap="bbsPost.simplePostWithContentResult" />
		<result property="profiler" resultMap="bbsPost.profilerResult" />
	</resultMap>

	<resultMap id="simplePostWithContentResult" class="bbsPostDO">
		<result property="id" column="id" />
		<result property="companyId" column="company_id" />
		<result property="account" column="account" />
		<result property="content" column="content" />
		<result property="bbsUserProfilerId" column="bbs_user_profiler_id" />
		<result property="bbsPostCategoryId" column="bbs_post_category_id" />
		<result property="title" column="title" />
		<result property="frontCategoryId" column="front_category_id" />
		<result property="visitedCount" column="visited_count" />
		<result property="replyCount" column="reply_count" />
		<result property="postTime" column="post_time" />
		<result property="replyTime" column="reply_time" />
		<result property="integral" column="integral" />
	</resultMap>

	<resultMap id="simplePostWithOutContentResult" class="bbsPostDO">
		<result property="id" column="id" />
		<result property="companyId" column="company_id" />
		<result property="account" column="account" />
		<result property="bbsUserProfilerId" column="bbs_user_profiler_id" />
		<result property="bbsPostCategoryId" column="bbs_post_category_id" />
		<result property="title" column="title" />
		<result property="frontCategoryId" column="front_category_id" />
		<result property="visitedCount" column="visited_count" />
		<result property="replyCount" column="reply_count" />
		<result property="postTime" column="post_time" />
		<result property="replyTime" column="reply_time" />
		<result property="integral" column="integral" />
	</resultMap>

	<sql id="dynmicPostBySearch">
		where p.is_del='0' and (p.check_status='1' or
		p.check_status='2')
		and
		(p.title like concat('%',#keywords#,'%')
		or p.content like concat('%',#keywords#,'%'))
	</sql>

	<sql id="simplePostColumnWithContent">
		p.id,p.account,p.company_id,p.bbs_user_profiler_id,p.bbs_post_category_id,
		p.title,p.front_category_id,p.visited_count,p.reply_count,p.post_time,
		p.reply_time,p.integral,p.content
	</sql>

	<sql id="simplePostColumnWithOutContent">
		p.id,p.account,p.company_id,p.bbs_user_profiler_id,p.bbs_post_category_id,
		p.title,p.front_category_id,p.visited_count,p.reply_count,p.post_time,
		p.reply_time,p.integral
	</sql>

	<select id="queryPostBySearch" parameterClass="java.util.HashMap"
		resultMap="postDtoWithContentResult">
		select
		<include refid="bbsPost.simplePostColumnWithContent" />
		,
		<include refid="bbsPost.simpleProfilerColumn" />
		from bbs_post p
		left join bbs_user_profiler pf on p.account=pf.account
		<include refid="bbsPost.dynmicPostBySearch" />
		<include refid="common.pageOrderBy" />
		<include refid="common.pageLimit" />
	</select>

	<!-- 最新话题查询 -->
	<select id="querytheNewsPost" parameterClass="java.util.HashMap"
		resultMap="simplePostWithContentResult">
		select
		<include refid="bbsPost.simplePostColumnWithContent" />
		from bbs_post p
		where
		p.is_del='0' and (p.check_status='1' or
		p.check_status='2')
		<dynamic>
			<isNotEmpty property="account" prepend="and">
				p.account=#account#
			</isNotEmpty>
		</dynamic>
		order by p.post_time desc
		limit #maxSize#
	</select>
	<!-- - -->

	<select id="queryPostBySearchCount" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		select count(*)
		from bbs_post p
		<include refid="bbsPost.dynmicPostBySearch" />
	</select>

	<select id="querySimplePostByCategory" resultMap="simplePostWithOutContentResult"
		parameterClass="java.util.HashMap">
		select
		<include refid="bbsPost.simplePostColumnWithOutContent" />
		from bbs_post p
		<include refid="bbsPost.dynmicPostByCategory" />
		order by post_time desc
		limit #max#
	</select>

	<sql id="dynmicPostByAdmin">
		<dynamic prepend="where">
			<isNotEmpty prepend="and" property="post.checkStatus">
				p.check_status=#post.checkStatus#
			</isNotEmpty>
			<isEqual prepend="and" property="post.companyId"
				compareValue="0">
				p.company_id=0
			</isEqual>
			<isEqual prepend="and" property="post.companyId"
				compareValue="-1">
				p.company_id!=0
			</isEqual>
			<isGreaterEqual prepend="and" property="post.companyId"
				compareValue="1">
				p.company_id=#post.companyId#
			</isGreaterEqual>
			<isNotEmpty prepend="and" property="post.isDel">
				p.is_del=#post.isDel#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="post.postType">
				p.post_type=#post.postType#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="post.bbsPostCategoryId">
				p.bbs_post_category_id>=#post.bbsPostCategoryId#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="post.title">
				p.title like
				concat(#post.title#,"%")
			</isNotEmpty>
			<isNotEmpty prepend="and" property="post.account">
				p.account=#post.account#
			</isNotEmpty>
		</dynamic>
	</sql>

	<select id="queryPostByAdmin" parameterClass="java.util.HashMap"
		resultMap="simplePostResult">
		select
		<include refid="bbsPost.simplePostColumn" />
		from bbs_post p
		<include refid="bbsPost.dynmicPostByAdmin" />
		<include refid="common.pageOrderBy" />
		<include refid="common.pageLimit" />
	</select>

	<select id="queryPostByAdminCount" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		select count(*)
		from bbs_post p
		<include refid="bbsPost.dynmicPostByAdmin" />
	</select>

	<update id="updateCheckStatus" parameterClass="java.util.HashMap">
		update bbs_post
		set check_status=#checkStatus#,
		gmt_modified=now(),
		check_time=now()
		where id=#id#
	</update>

	<update id="updateCheckStatusForFront" parameterClass="java.util.HashMap">
		update bbs_post
		set check_status=#checkStatus#,
		gmt_modified=now(),
		post_time=now()
		where id=#id#
	</update>
	
	<update id="updateIsDel" parameterClass="java.util.HashMap">
		update bbs_post
		set is_del=#isDel#,
		gmt_modified=now()
		where id=#id#
	</update>

	<delete id="deleteBbsPost" parameterClass="java.lang.Integer">
		delete from bbs_post where id=#value#
	</delete>

	<resultMap class="bbsPostDO" id="fullColumnResult">
		<result property="id" column="id" />
		<result property="companyId" column="company_id" />
		<result property="account" column="account" />
		<result property="bbsUserProfilerId" column="bbs_user_profiler_id" />
		<result property="bbsPostCategoryId" column="bbs_post_category_id" />
		<result property="title" column="title" />
		<result property="content" column="content" />
		<result property="isDel" column="is_del" />
		<result property="checkPerson" column="check_person" />
		<result property="checkStatus" column="check_status" />
		<result property="checkTime" column="check_time" />
		<result property="unpassReason" column="unpass_reason" />
		<result property="uncheckedCheckStatus" column="unchecked_check_status" />
		<result property="postType" column="post_type" />
		<result property="visitedCount" column="visited_count" />
		<result property="replyCount" column="reply_count" />
		<result property="postTime" column="post_time" />
		<result property="replyTime" column="reply_time" />
		<result property="integral" column="integral" />
		<result property="tags" column="tags" />
		<result property="gmtCreated" column="gmt_created" />
		<result property="gmtModified" column="gmt_modified" />
	</resultMap>

	<sql id="fullColumn">
		bp.`id`,
		bp.`company_id`,
		bp.`account`,
		bp.`bbs_user_profiler_id`,
		bp.`bbs_post_category_id`,
		bp.`title`,
		bp.`content`,
		bp.`is_del`,
		bp.`check_person`,
		bp.`check_status`,
		bp.`check_time`,
		bp.`unpass_reason`,
		bp.`unchecked_check_status`,
		bp.`post_type`,
		bp.`visited_count`,
		bp.`reply_count`,
		bp.`post_time`,
		bp.`reply_time`,
		bp.`integral`,
		bp.`tags`,
		bp.`gmt_created`,
		bp.`gmt_modified`
	</sql>

	<insert id="insertPost" parameterClass="bbsPostDO">
		insert into `bbs_post`
		(
		`company_id`,
		`account`,
		`bbs_user_profiler_id`,
		`bbs_post_category_id`,
		`title`,
		`content`,
		`is_del`,
		`check_person`,
		`check_status`,
		`check_time`,
		`unpass_reason`,
		`unchecked_check_status`,
		`post_type`,
		`visited_count`,
		`reply_count`,
		`post_time`,
		`reply_time`,
		`integral`,
		`tags`,
		`gmt_created`,
		`gmt_modified`
		)
		values
		(

		#companyId#,
		#account#,
		#bbsUserProfilerId#,
		#bbsPostCategoryId#,
		#title#,
		#content#,
		#isDel#,
		#checkPerson#,
		#checkStatus#,
		#checkTime#,
		#unpassReason#,
		#uncheckedCheckStatus#,
		#postType#,
		#visitedCount#,
		#replyCount#,
		#postTime#,
		#replyTime#,
		#integral#,
		#tags#,
		now(),
		now()
		)
		<selectKey keyProperty="id" resultClass="java.lang.Integer">
			select
			last_insert_id()
		</selectKey>
	</insert>

	<select id="queryPostById" parameterClass="java.lang.Integer"
		resultMap="fullColumnResult">
		select
		<include refid="bbsPost.fullColumn" />
		from `bbs_post` bp
		where bp.id=#value#
	</select>
	
	<select id="queryOnBbsPostById" parameterClass="java.lang.Integer"
		resultMap="fullColumnResult">
		select
		<include refid="bbsPost.fullColumn" />
		from `bbs_post` bp
		<dynamic prepend="where">
		<![CDATA[ bp.id>#id# ]]>
		</dynamic>
		and bp.check_status = 1
		and bp.post_type in (select post_type from bbs_post
		where id=#id#)
		order by id
		asc
		limit 0,1
	</select>
	
	<select id="queryDownBbsPostById" parameterClass="java.lang.Integer"
		resultMap="fullColumnResult">
		select
		<include refid="bbsPost.fullColumn" />
		from `bbs_post` bp
		<dynamic prepend="where">
		<![CDATA[ bp.id<#id# ]]>
		</dynamic>
		and bp.check_status = 1
		and bp.post_type in (select post_type from bbs_post
		where id=#id#)
		order by id
		desc
		limit 0,1
	</select>

	<update id="updatePostByAdmin" parameterClass="bbsPostDO">
		update `bbs_post`
		set
		`title` = #title#,
		`bbs_post_category_id` = #bbsPostCategoryId#,
		`post_type` = #postType#,
		`integral` = #integral#,
		`tags` = #tags#,
		`visited_count` = #visitedCount#,
		`reply_count` = #replyCount#,
		`post_time` = #postTime#,
		`reply_time` = #replyTime#,
		`gmt_modified` =
		now()
		where id=#id#
	</update>

	<select id="queryRecentByAccount" parameterClass="java.util.HashMap"
		resultMap="simplePostResult">
		select
		<include refid="bbsPost.simplePostColumn" />
		from bbs_post p
		where
		p.is_del='0' and (p.check_status='1' or
		p.check_status='2')
		<dynamic>
			<isNotEmpty property="account" prepend="and">
				p.account=#account#
			</isNotEmpty>
		</dynamic>
		order by p.post_time desc
		limit #maxSize#
	</select>

	<resultMap id="postByTypeResult" class="bbsPostDO">
		<result property="id" column="id" />
		<result property="account" column="account" />
		<result property="companyId" column="company_id" />
		<result property="bbsUserProfilerId" column="bbs_user_profiler_id" />
		<result property="bbsPostCategoryId" column="bbs_post_category_id" />
		<result property="title" column="title" />
		<result property="content" column="content" />
		<result property="visitedCount" column="visited_count" />
		<result property="replyCount" column="reply_count" />
		<result property="postTime" column="post_time" />
		<result property="replyTime" column="reply_time" />
		<result property="integral" column="integral" />
		<result property="checkStatus" column="check_status" />
		<result property="postType" column="post_type" />
		<result property="checkTime" column="check_time" />
		<result property="isDel" column="is_del" />
	</resultMap>

	<select id="queryPostWithContentByType" parameterClass="java.util.HashMap"
		resultMap="postByTypeResult">
		select
		<include refid="bbsPost.simplePostColumn" />
		,p.content
		from bbs_post p
		where p.post_type=#postType#
		and p.is_del='0'
		and (p.check_status='1' or p.check_status='2')
		order by p.post_time
		desc
		limit #size#
	</select>

	<select id="queryPostByType" parameterClass="java.util.HashMap"
		resultMap="postDtoResult">
		select
		<include refid="bbsPost.simplePostColumn" />
		,
		<include refid="bbsPost.simpleProfilerColumn" />
		from bbs_post p
		left join bbs_user_profiler pf on p.account=pf.account
		where p.post_type=#postType#
		and p.is_del='0' and (p.check_status='1'
		or p.check_status='2')
		order by p.post_time desc
		limit #size#
	</select>

	<!--	ge duo -->
	<!-- 互助周刊等类别页面数据-->
	
	<sql id="queryByPostTypeDynamic">
		<dynamic>
			where
			p.is_del='0' and (p.check_status='1' or p.check_status='2')
			<isNotEmpty prepend="and" property="postType">
				p.post_type=#postType#
			</isNotEmpty>
		</dynamic>
	</sql>

	<select id="queryMorePostByType" parameterClass="java.util.HashMap"
		resultMap="postDtoWithContentResult">
		select
		<include refid="bbsPost.simplePostColumnWithContent" />
		,
		<include refid="bbsPost.simpleProfilerColumn" />
		from bbs_post p
		left join bbs_user_profiler pf on p.account=pf.account
		<include refid="queryByPostTypeDynamic" />
		<include refid="common.pageOrderBy" />
		<include refid="common.pageLimit" />
	</select>

	<select id="queryMorePostByTypeCount" parameterClass="java.util.Map"
		resultClass="java.lang.Integer">
		select
		count(*)
		from bbs_post p
		left join bbs_user_profiler pf on p.account=pf.account
		<include refid="queryByPostTypeDynamic" />
	</select>

	<select id="queryPostOrderBy" parameterClass="java.util.HashMap"
		resultMap="simplePostResult">
		select
		<include refid="bbsPost.simplePostColumn" />
		from bbs_post p
		where
		p.is_del='0' and (p.check_status='1' or
		p.check_status='2')
		order by $sort$ $dir$
		limit #size#
	</select>

	<select id="queryPostByViewLog" parameterClass="java.util.HashMap"
		resultMap="simplePostResult">
		select
		<include refid="bbsPost.simplePostColumn" />
		from bbs_post p
		inner join bbs_view_log bvl on p.id=bvl.bbs_post_id
		where bvl.gmt_target=#gmtTarget#
		order by num desc
		limit #size#
	</select>
	
	<sql id="dynamicByUser">
		where p.account=#account#
		<dynamic>
			<isNotEmpty prepend="and" property="checkStatus">
				p.check_status=#checkStatus#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="isDel">
				p.is_del=#isDel#
			</isNotEmpty>
		</dynamic>
	</sql>
	<select id="queryPostByUser" parameterClass="java.util.HashMap"
		resultMap="simplePostResult">
		select
		<include refid="bbsPost.simplePostColumn" />
		from bbs_post p
		<include refid="bbsPost.dynamicByUser" />
		<include refid="common.pageOrderBy" />
		<include refid="common.pageLimit" />
	</select>

	<select id="queryPostByUserCount" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		select
		count(*)
		from bbs_post p
		<include refid="bbsPost.dynamicByUser" />
	</select>

	<update id="updatePostByUser" parameterClass="bbsPostDO">
		update
		`bbs_post`
		set
		`title` = #title#,
		`content` = #content#,
		`bbs_post_category_id` = #bbsPostCategoryId#,
		`tags` = #tags#,
		`gmt_modified` = now()
		where id=#id#
	</update>

	<select id="queryPostWithProfileById" parameterClass="java.lang.Integer"
		resultMap="postDtoWithContentResult">
		select
		<include refid="bbsPost.simplePostColumnWithContent" />
		,
		<include refid="bbsPost.simpleProfilerColumn" />
		from bbs_post p
		left join bbs_user_profiler pf on p.account=pf.account
		where p.id=#value#
		limit 1
	</select>

	<select id="queryPostOrderVisitCount" parameterClass="java.util.HashMap"
		resultMap="simplePostResult">
		select
		<include refid="bbsPost.simplePostColumn" />
		from bbs_post p
		where
		p.is_del='0' and (p.check_status='1' or
		p.check_status='2')
		<dynamic>
			<isNotEmpty property="account" prepend="and">
				p.account=#account#
			</isNotEmpty>
		</dynamic>
		order by p.visited_count desc
		limit #size#
	</select>

	<select id="queryContent" parameterClass="java.lang.Integer"
		resultClass="java.lang.String">
		select content from bbs_post where id=#value# limit 1
	</select>

	<update id="updateContent" parameterClass="java.util.HashMap">
		update bbs_post
		set content=#content#,gmt_modified=now()
		where id=#id#
	</update>

	<resultMap id="postTypeResult" class="bbsPostType">
		<result property="id" column="id" />
		<result property="code" column="code" />
		<result property="name" column="name" />
	</resultMap>

	<select id="queryPostTypeChild" parameterClass="java.lang.String"
		resultMap="postTypeResult">
		select id,code,name
		from bbs_post_type
		where code like
		concat(#value#,'____')
	</select>

	<select id="queryPostTypeChildCount" parameterClass="java.lang.String"
		resultClass="java.lang.Integer">
		select count(*)
		from bbs_post_type
		where code like
		concat(#value#,'____')
	</select>

	<select id="queryPostTypeName" parameterClass="java.lang.Integer"
		resultClass="java.lang.String">
		select name from bbs_post_type where
		id=#value#
	</select>

	<!-- 根据关键字查询，再生地图使用 -->
	<resultMap class="bbsPostDO" id="simpleMap4Map">
		<result property="id" column="id" />
		<result property="title" column="title" />
		<result property="postTime" column="post_time" />
	</resultMap>
	<select id="queryPostByKey" parameterClass="java.util.HashMap"
		resultMap="simpleMap4Map">
		select
		id,title,post_time
		from bbs_post
		where
		is_del='0' and (check_status='1' or check_status='2')
		and title like concat('%',#title#,'%')
		order by post_time desc
		limit #size#
	</select>
	
	<select id="query24HourHot" parameterClass="java.util.HashMap"
		resultMap="simplePostResult">
		select
		<include refid="bbsPost.simplePostColumn" />
		from bbs_post p
		where p.is_del='0' and (p.check_status='1' or
		p.check_status='2') and p.post_time>=#gmtTarget#
		order by p.visited_count desc
		limit #size#
	</select>
	
	<select id="queryMostViewedPost" parameterClass="java.util.HashMap"
		resultMap="simplePostResult">
		select
		<include refid="bbsPost.simplePostColumn" />
		from bbs_post p
		where p.is_del='0' and (p.check_status='1' or
		p.check_status='2') and p.post_time>=#gmtTarget#
		order by p.reply_count desc
		limit #size#
	</select>
</sqlMap>