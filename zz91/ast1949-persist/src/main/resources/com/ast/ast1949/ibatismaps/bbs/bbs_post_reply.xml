<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bbsPostReply">
	<typeAlias alias="reply" type="com.ast.ast1949.domain.bbs.BbsPostReplyDO" />
	<typeAlias alias="profiler" type="com.ast.ast1949.domain.bbs.BbsUserProfilerDO" />
	<typeAlias alias="replyDto" type="com.ast.ast1949.dto.bbs.BbsPostReplyDto" />
	<typeAlias alias="post" type="com.ast.ast1949.domain.bbs.BbsPostDO" />
	
	<resultMap id="profilerResult" class="profiler">
		<result property="id" column="profiler_id" />
		<result property="nickname" column="nickname" />
		<result property="realName" column="real_name" />
		<result property="integral" column="integral" />
		<result property="postNumber" column="post_number" />
		<result property="replyNumber" column="reply_number" />
		<result property="essenceNumber" column="essence_number" />
	</resultMap>
	
	<resultMap id="replyResult" class="reply" >
		<result property="id" column="id" />
		<result property="companyId" column="company_id" />
		<result property="account" column="account" />
		<result property="bbsPostId" column="bbs_post_id" />
		<result property="title" column="title" />
		<result property="content" column="content" />
		<result property="isDel" column="is_del" />
		<result property="gmtCreated" column="gmt_created" />
		<result property="gmtModified" column="gmt_modified" />
	</resultMap>
	
	<resultMap id="replyDtoResult" class="replyDto" >
		<result property="reply" resultMap="bbsPostReply.replyResult" />
		<result property="profiler" resultMap="bbsPostReply.profilerResult" />
	</resultMap>
	
	<resultMap class="reply" id="fullColumnResult">
		<result property="id" column="id" />
		<result property="companyId" column="company_id" />
		<result property="account" column="account" />
		<result property="bbsPostId" column="bbs_post_id" />
		<result property="title" column="title" />
		<result property="content" column="content" />
		<result property="isDel" column="is_del" />
		<result property="checkPerson" column="check_person"/>
		<result property="checkStatus" column="check_status"/>
		<result property="checkTime" column="check_time"/>
		<result property="unpassReason" column="unpass_reason"/>
		<result property="uncheckedCheckStatus" column="unchecked_check_status"/>
		<result property="gmtCreated" column="gmt_created" />
		<result property="gmtModified" column="gmt_modified" />
	</resultMap>
	
	<sql id="fullColumn">
		bpr.`id`,
		bpr.`company_id`,
		bpr.`account`,
		bpr.`bbs_post_id`,
		bpr.`title`,
		bpr.`content`,
		bpr.`is_del`,
		bpr.`check_person`,
		bpr.`check_status`,
		bpr.`check_time`,
		bpr.`unpass_reason`,
		bpr.`unchecked_check_status`,
		bpr.`gmt_created`,
		bpr.`gmt_modified`
	</sql>
	
	<insert id="createReplyByAdmin" parameterClass="reply">
		insert into `bbs_post_reply`
		(
		`bbs_post_id`,
		`account`,
		`title`,
		`content`,
		`is_del`,
		`check_status`,
		`gmt_created`,
		`gmt_modified`
		)
		values
		(
		#bbsPostId#,
		#account#,
		#title#,
		#content#,
		#isDel#,
		#checkStatus#,
		now(),
		now()
		)
		<selectKey keyProperty="id" resultClass="java.lang.Integer">
			select last_insert_id()
		</selectKey>
	</insert>
	
	<delete id="deleteByAdmin" parameterClass="java.lang.Integer">
		delete from `bbs_post_reply` 
		where id=#value# 
	</delete>
	
	<update id="updateCheckStatus" parameterClass="java.util.HashMap">
		update `bbs_post_reply`
		set
		`check_person` = #admin#,
		`check_status` = #checkStatus#,
		`check_time` = now(),
		`gmt_modified` = now()
		where id=#id#
	</update>
	
	<update id="updateReplyByAdmin" parameterClass="reply">
		update `bbs_post_reply`
		set
		content=#content#,
		gmt_modified=now()
		where id=#id#
	</update>
	
	<sql id="dynamicByAdmin">
		<dynamic prepend="where">
			<isNotEmpty property="reply.checkStatus" prepend="and">
			 bpr.check_status=#reply.checkStatus#
			</isNotEmpty>
			<isNotEmpty property="reply.bbsPostId" prepend="and">
			 bpr.bbs_post_id=#reply.bbsPostId#
			</isNotEmpty>
			<isNotEmpty property="reply.title" prepend="and">
			 bpr.title like concat(#reply.title#,'%')
			</isNotEmpty>
			<isNotEmpty property="reply.account" prepend="and">
			 bpr.account=#reply.account#
			</isNotEmpty>
		</dynamic>
	</sql>
	
	<select id="queryReplyByAdmin" parameterClass="java.util.HashMap" resultMap="fullColumnResult">
		select
		<include refid="bbsPostReply.fullColumn"/>
		from `bbs_post_reply` bpr
		<include refid="bbsPostReply.dynamicByAdmin"/>
		<include refid="common.pageOrderBy" />
		<include refid="common.pageLimit" />
	</select>
	
	<select id="queryReplyByAdminCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select count(*)
		from `bbs_post_reply` bpr
		<include refid="bbsPostReply.dynamicByAdmin"/>
	</select>
	
	<sql id="dynamicReplyOfPost">
		where
		r.is_del='0' and (r.check_status='1' or r.check_status='2')
		and r.bbs_post_id=#postId#
	</sql>
	
	<select id="queryReplyOfPost" parameterClass="java.util.HashMap" resultMap="replyDtoResult">
		select 
			r.id,r.company_id,r.account,r.bbs_post_id,r.title,r.content,r.is_del,r.gmt_created,r.gmt_modified
			,
			p.nickname,p.real_name,p.integral,p.post_number,p.reply_number,p.essence_number,p.id as profiler_id
		from bbs_post_reply r
			left join bbs_user_profiler p on r.account=p.account
			<include refid="bbsPostReply.dynamicReplyOfPost"/>
			order by r.gmt_created asc
			<include refid="common.pageLimit" />
	</select>
	
	<select id="queryReplyOfPostCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select 
			count(*)
		from bbs_post_reply r
			<include refid="bbsPostReply.dynamicReplyOfPost"/>
	</select>
	
	<select id="queryBbsPostByReplyId" parameterClass="java.lang.Integer" resultClass="java.lang.Integer">
		select bbs_post_id from bbs_post_reply where id=#id#
	</select>
	
	<!-- bad result --> 
	<resultMap class="post" id="simplePostResult">
		<result property="id" column="id"/>
		<result property="title" column="title"/>
		<result property="bbsPostCategoryId" column="bbs_post_category_id"/>
		<result property="checkStatus" column="check_status"/>
		<result property="gmtCreated" column="gmt_created"/>
	</resultMap>
	
	<select id="queryReplyByUser" parameterClass="java.util.HashMap" resultMap="simplePostResult">
		select 
			p.id ,p.title,p.bbs_post_category_id,r.gmt_created,r.check_status
		from bbs_post_reply r
		inner join bbs_post p on r.bbs_post_id = p.id
		where r.account=#account#
		<dynamic>
			<isNotEmpty property="checkStatus" prepend="and">
				r.check_status=#checkStatus#
			</isNotEmpty>
		</dynamic>
		<include refid="common.pageOrderBy" />
		<include refid="common.pageLimit" />
	</select>
	
	<select id="queryReplyByUserCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select 
			count(*)
		from bbs_post_reply r
		inner join bbs_post p on r.bbs_post_id = p.id
		where r.account=#account#
		<dynamic>
			<isNotEmpty property="checkStatus" prepend="and">
				r.check_status=#checkStatus#
			</isNotEmpty>
		</dynamic>
	</select>
</sqlMap>