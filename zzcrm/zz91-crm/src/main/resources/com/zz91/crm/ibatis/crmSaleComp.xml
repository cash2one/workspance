<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="crmSaleComp">
	<typeAlias alias="crmSaleComp" type="com.zz91.crm.domain.CrmSaleComp"/>
	<typeAlias alias="crmSaleDataDto" type="com.zz91.crm.dto.CrmSaleDataDto"/>
	<typeAlias alias="crmContactStatistics" type="com.zz91.crm.domain.CrmContactStatistics"/>
	<typeAlias alias="crmSaleStatistics" type="com.zz91.crm.domain.CrmSaleStatistics"/>
	<typeAlias alias="crmContactStatisticsDto" type="com.zz91.crm.dto.CrmContactStatisticsDto"/>
	<typeAlias alias="crmSaleStatisticsDto" type="com.zz91.crm.dto.CrmSaleStatisticsDto"/>
	<typeAlias alias="crmLog" type="com.zz91.crm.domain.CrmLog"/>
	<typeAlias alias="crmStatistics" type="com.zz91.crm.domain.CrmStatistics"/>
	<typeAlias alias="crmTurnStarStatistics" type="com.zz91.crm.domain.CrmTurnStarStatistics"/>
	
	<resultMap class="crmSaleComp" id="fullCrmSaleCompResult">
		<result property="id" column="id"/>
		<result property="cid" column="cid"/>
		<result property="status" column="status"/>
		<result property="saleType" column="sale_type"/>
		<result property="saleDept" column="sale_dept"/>
		<result property="saleAccount" column="sale_account"/>
		<result property="saleName" column="sale_name"/>
		<result property="companyType" column="company_type"/>
		<result property="logId" column="log_id"/>
		<result property="autoBlock" column="auto_block"/>
		<result property="gmtBlock" column="gmt_block"/>
		<result property="gmtContact" column="gmt_contact"/>
		<result property="gmtNextContact" column="gmt_next_contact"/>
		<result property="contactCount" column="contact_count"/>
		<result property="contactAbleCount" column="contact_able_count"/>
		<result property="contactDisableCount" column="contact_disable_count"/>
		<result property="disableStatus" column="disable_status"/>
		<result property="successStatus" column="success_status"/>
		<result property="dragOrderCount" column="drag_order_count"/>
		<result property="destroyOrderCount" column="destroy_order_count"/>
		<result property="gmtModified" column="gmt_modified"/>
		<result property="gmtCreated" column="gmt_created"/>
	</resultMap>
	
	<resultMap class="crmContactStatistics" id="crmContactStatisticsMap">
		<result property="id" column="id"/>
		<result property="star1Able" column="star1_able"/>
		<result property="star1Disable" column="star1_disable"/>
		<result property="star2Able" column="star2_able"/>
		<result property="star2Disable" column="star2_disable"/>
		<result property="star3Able" column="star3_able"/>
		<result property="star3Disable" column="star3_disable"/>
		<result property="star4Able" column="star4_able"/>
		<result property="star4Disable" column="star4_disable"/>
		<result property="star5Able" column="star5_able"/>
		<result property="star5Disable" column="star5_disable"/>
		<result property="dragOrderCount" column="drag_order_count"/>
		<result property="destroyOrderCount" column="destroy_order_count"/>
		<result property="seoCount" column="seo_count"/>
		<result property="addRenewCount" column="add_renew_count"/>
		<result property="saleAccount" column="sale_account"/>
		<result property="saleDept" column="sale_dept"/>
		<result property="saleName" column="sale_name"/>
		<result property="gmtTarget" column="gmt_target"/>
		<result property="gmtCreated" column="gmt_created"/>
		<result property="gmtModified" column="gmt_modified"/>
	</resultMap>
	
	<resultMap class="crmContactStatisticsDto" id="statisticsDtoResultMap">
		<result property="statistics" resultMap="crmSaleComp.crmContactStatisticsMap"/>
	</resultMap>
	
	<resultMap class="crmSaleStatistics" id="crmSaleStatisticsMap">
		<result property="id" column="id"/>
		<result property="gmtTarget" column="gmt_target"/>
		<result property="zhejiang" column="zhejiang"/>
		<result property="jiangsu" column="jiangsu"/>
		<result property="shanghai" column="shanghai"/>
		<result property="guangdong" column="guangdong"/>
		<result property="shandong" column="shandong"/>
		<result property="beijing" column="beijing"/>
		<result property="hebei" column="hebei"/>
		<result property="other" column="other"/>
		<result property="gmtCreated" column="gmt_created"/>
		<result property="gmtModified" column="gmt_modified"/>
	</resultMap>
	
	<resultMap class="crmSaleStatisticsDto" id="crmSalestatisticsDtoResultMap">
		<result property="crmSaleStatistics" resultMap="crmSaleComp.crmSaleStatisticsMap"/>
	</resultMap>
	
	<resultMap class="crmSaleDataDto" id="crmSaleDataDtoMap">
		<result property="star" column="star"/>
		<result property="count" column="count"/>
	</resultMap>
	
	<resultMap class="crmSaleDataDto" id="querySalesMap">
		<result property="saleAccount" column="sale_account"/>
		<result property="saleDept" column="sale_dept"/>
		<result property="saleName" column="sale_name"/>
	</resultMap>
	
	<resultMap class="crmLog" id="simpCrmLogResult">
		<result property="id" column="id"/>
		<result property="cid" column="cid"/>
		<result property="starOld" column="star_old"/>
		<result property="star" column="star"/>
		<result property="situation" column="situation"/>
		<result property="saleAccount" column="sale_account"/>
		<result property="saleDept" column="sale_dept"/>
		<result property="saleName" column="sale_name"/>
		<result property="contactType" column="contact_type"/>
	</resultMap>
	
	<resultMap class="crmStatistics" id="CrmStatisticsResultMap">
		<result property="id" column="id"/>
		<result property="totals" column="totals"/>
		<result property="seaCount" column="sea_count"/>
		<result property="noActiveCount" column="no_active_count"/>
		<result property="selfCount" column="self_count"/>
		<result property="wasteCount" column="waste_count"/>
		<result property="repeatCount" column="repeat_count"/>
		<result property="todayAssignCount" column="today_assign_count"/>
		<result property="todayChooseCount" column="today_choose_count"/>
		<result property="todayPutCount" column="today_put_count"/>
		<result property="gmtTarget" column="gmt_target"/>
		<result property="gmtCreated" column="gmt_created"/>
		<result property="gmtModified" column="gmt_modified"/>
	</resultMap>
	
	<resultMap class="crmSaleDataDto" id="simplyDataDtoMap">
		<result property="count" column="count"/>
		<result property="ctype" column="ctype"/>
	</resultMap>
	
	<sql id="fullColumn">
		`id`,
		`cid`,
		`status`,
		`sale_type`,
		`sale_dept`,
		`sale_account`,
		`sale_name`,
		`company_type`,
		`log_id`,
		`auto_block`,
		`gmt_block`,
		`gmt_contact`,
		`gmt_next_contact`,
		`contact_count`,
		`contact_able_count`,
		`contact_disable_count`,
		`disable_status`,
		`success_status`,
		`drag_order_count`,
		`destroy_order_count`,
		`gmt_modified`,
		`gmt_created`
	</sql>
	
	<insert id="createCrmSaleComp" parameterClass="crmSaleComp">
		insert into `crm_sale_comp`
		(
		`cid`,
		`status`,
		`sale_type`,
		`sale_dept`,
		`sale_account`,
		`sale_name`,
		`company_type`,
		`gmt_contact`,
		`gmt_next_contact`,
		`gmt_modified`,
		`gmt_created`)
		values
		(
		#cid#,
		#status#,
		#saleType#,
		#saleDept#,
		#saleAccount#,
		#saleName#,
		#companyType#,
		#gmtContact#,
		#gmtNextContact#,
		now(),
		now()
		)
		<selectKey keyProperty="id" resultClass="java.lang.Integer">
			select last_insert_id()
		</selectKey>
	</insert>
	
	<update id="updateStatus" parameterClass="java.util.HashMap">
		update crm_sale_comp
		set
		<isNotNull property="type">
			<isEqual property="type" compareValue="0">
				auto_block=0,
				gmt_block=now(),
				sale_account='',
				sale_name='',
				sale_dept='',
			</isEqual>
		</isNotNull>
		status = 0,
		gmt_modified=now()
		where cid=#cid# and status=1
	</update>
	
	<update id="updateCompanyType" parameterClass="java.util.HashMap">
		update crm_sale_comp
		set
		company_type=#type#,
		gmt_modified=now()
		where id=#id# and status=1
	</update>
	
	<update id="updateDisableStatus" parameterClass="java.util.HashMap">
		update crm_sale_comp
		set
		disable_status=#status#,
		gmt_modified=now()
		where cid=#cid# and status=1
	</update>
	
	<update id="updateOrderCountById" parameterClass="java.util.HashMap">
		update crm_sale_comp set
		<isEqual property="flag" compareValue="0">
			drag_order_count = drag_order_count + 1,
		</isEqual>
		<isEqual property="flag" compareValue="1">
			destroy_order_count = destroy_order_count + 1,
		</isEqual>
		gmt_modified=now()
		where cid=#id# and status=1
	</update>
	
	<update id="updateContactCount" parameterClass="java.util.HashMap">
		update crm_sale_comp
		set 
		contact_count=contact_count+1
		<isEqual property="situation" compareValue="0">
		,contact_able_count=contact_able_count + 1
		</isEqual>
		<isNotEqual property="situation" compareValue="0">
		,contact_disable_count=contact_disable_count + 1
		</isNotEqual>
		,log_id=#logId#,
		gmt_next_contact=#gmtNextContact#,
		gmt_contact=now()
		where cid=#cid# and status=1 and sale_account=#saleAccount# and sale_dept=#saleDept#
	</update>
	
	<select id="queryCountByCidAndStatus" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select count(*)
		from crm_sale_comp
		where cid=#cid# and status=#status#
	</select>
	
	<select id="queryCrmSaleCompByCid" parameterClass="java.lang.Integer" resultMap="fullCrmSaleCompResult">
		select
		<include refid="crmSaleComp.fullColumn"/>
		from `crm_sale_comp`
		where cid=#cid#
	</select>
	
	<select id="queryContactData" parameterClass="java.util.Map" resultMap="statisticsDtoResultMap">
		select 
		    id,
		    sum(star1_able) as star1_able,
		    sum(star1_disable) as star1_disable,
		    sum(star2_able) as star2_able,
		    sum(star2_disable) as star2_disable,
		    sum(star3_able) as star3_able,
		    sum(star3_disable) as star3_disable,
		    sum(star4_able) as star4_able,
		    sum(star4_disable) as star4_disable,
		    sum(star5_able) as star5_able,
		    sum(star5_disable) as star5_disable,
		    sum(drag_order_count) as drag_order_count,
		    sum(destroy_order_count) as destroy_order_count,
		    sum(seo_count) as seo_count,
		    sum(add_renew_count) as add_renew_count,
		    sale_account,
		    sale_dept,
		    sale_name,
		    gmt_target,
		    gmt_created,
		    gmt_modified
		from crm_contact_statistics
		<dynamic prepend="where">
			<isNotEmpty property="account" prepend="and">
				sale_account = #account#
			</isNotEmpty>
			<isNotEmpty property="deptCode" prepend="and">
				sale_dept like concat(#deptCode#,'%') 
			</isNotEmpty>
			<isNotEmpty property="start" prepend="and">
				gmt_target >= #start#
				<isNotEmpty property="end" prepend="and">
					#end# > gmt_target
				</isNotEmpty>
			</isNotEmpty>
		</dynamic>
		group by sale_dept,sale_account
		<isNotEqual property="group" compareValue="1">
			,gmt_target
		</isNotEqual>
		order by gmt_target desc
	</select>
	<select id="queryRegisterData" parameterClass="java.util.Map" resultMap="crmSalestatisticsDtoResultMap">
		SELECT
			id,
			gmt_target,
			sum(zhejiang) as zhejiang,
			sum(jiangsu) as jiangsu,
			sum(shanghai) as shanghai,
			sum(guangdong) as guangdong,
			sum(shandong) as shandong,
			sum(beijing) as beijing,
			sum(hebei) as hebei,
			sum(other) as other,
			gmt_created,
			gmt_modified
		FROM crm_sale_statistics
		<dynamic prepend="where">
			<isNotEmpty property="start" prepend="and">
				gmt_target >= #start#
				<isNotEmpty property="end" prepend="and">
					#end# > gmt_target
				</isNotEmpty>
			</isNotEmpty>
		</dynamic>
		<isNotEqual property="group" compareValue="1">
			group by gmt_target
		</isNotEqual>
		order by gmt_target desc
	</select>
	
	<select id="querySales" parameterClass="java.util.Map" resultMap="querySalesMap">
		SELECT
			sale_dept,
			sale_account,
			sale_name
		FROM crm_sale_comp 
		WHERE sale_type=0 and status=1 
		<isNotEmpty property="account" >
			and sale_account = #account#
		</isNotEmpty>
		<isNotEmpty property="deptCode" >
			and sale_dept like concat(#deptCode#,'%')
		</isNotEmpty>
		GROUP BY sale_dept,sale_account
	</select>
	
	<select id="querySaleCompanyData" parameterClass="java.util.Map" resultMap="crmSaleDataDtoMap">
		SELECT
		IFNULL(cc.star,0) as star,
		count(distinct cc.id) as count
		FROM  crm_company cc
		inner join crm_sale_comp csc on csc.cid=cc.id
		where csc.sale_type=0 and csc.status=1
		and csc.sale_account = #account#
		and csc.sale_dept = #deptCode#
		and cc.repeat_id=0
		and cc.regist_status=1
		group by cc.star
	</select>

	<select id="queryTomContact" parameterClass="java.util.Map" resultClass="java.lang.Integer">
		SELECT count(distinct cid) 
		FROM crm_sale_comp 
		WHERE sale_type=0 
			and status=1 
			and date_format(gmt_next_contact,'%Y-%m-%d') = date_format(date_add(now(), interval 1 day),'%Y-%m-%d')
			and sale_account = #account#
			and sale_dept = #deptCode#
	</select>
	<select id="queryTodContact" parameterClass="java.util.Map" resultClass="java.lang.Integer">
		SELECT count(distinct cid) 
		FROM crm_sale_comp 
		WHERE sale_type=0 
			and status=1 
			and date_format(gmt_next_contact,'%Y-%m-%d') = date_format(now(),'%Y-%m-%d')
			and sale_account = #account#
			and sale_dept = #deptCode#
	</select>
	
	<select id="queryContactDataByToday" parameterClass="java.util.Map" resultMap="simpCrmLogResult">
		select * from (select id,cid,star_old,star,situation,sale_account,sale_name,sale_dept,contact_type from crm_log
		where date_format(gmt_created,'%Y-%m-%d') = date_format(now(),'%Y-%m-%d')
		<isNotEmpty property="account" prepend="and">
			sale_account = #account#
		</isNotEmpty>
		<isNotEmpty property="deptCode" prepend="and">
			sale_dept like concat(#deptCode#,'%')
		</isNotEmpty>
		order by gmt_created desc) tmp group by cid
	</select>
	
	<select id="queryCrmStatistics" parameterClass="java.util.HashMap" resultMap="CrmStatisticsResultMap">
		select
		`id`,`totals`,`sea_count`,`no_active_count`,`self_count`,`waste_count`,`repeat_count`,
		`today_assign_count`,`today_choose_count`,`today_put_count`,`gmt_target`,`gmt_created`,`gmt_modified`
		from `crm_statistics`
		<include refid="common.pageOrderBy"/>
		<include refid="common.pageLimit"/>
	</select>
	
	<select id="queryCrmStatisticsCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select count(*) from crm_statistics
	</select>
	
	<select id="queryGmtTarget" resultClass="java.util.Date">
		select gmt_target from crm_statistics
	</select>
	
	<select id="queryCrmCount" resultMap="simplyDataDtoMap">
		select count(*) as count,ctype 
		from crm_company group by ctype	
	</select>
	
	<select id="queryTodaySeaCount" resultClass="java.lang.Integer">
		select count(*) as count from crm_sale_comp 
		where status=0 and disable_status=0 
		and date_format(gmt_modified,'%Y-%m-%d') = date_format(now(),'%Y-%m-%d')
	</select>
	
	<select id="queryTodayChooseSeaCount">
		select count(*) as count from crm_sale_comp 
		where date_format(gmt_created,'%Y-%m-%d') = date_format(now(),'%Y-%m-%d')
	</select>
	
	<select id="queryTodayAssignCount">
		select count(*) as count from crm_sale_comp csc,crm_company cc 
		where date_format(csc.gmt_created,'%Y-%m-%d') = date_format(now(),'%Y-%m-%d') 
		and cc.block_count = 0 and csc.status = 1 and csc.cid = cc.id
	</select>
	
	<select id="queryTodayRepeatCount">
		select count(*) as count from crm_company where repeat_id != 0
	</select>
	
	<resultMap class="crmTurnStarStatistics" id="CrmTurnStarStatisticsResultMap">
		<result property="id" column="id"/>
		<result property="saleDept" column="sale_dept"/>
		<result property="saleName" column="sale_name"/>
		<result property="saleAccount" column="sale_account"/>
		<result property="star4" column="star4"/>
		<result property="star5" column="star5"/>
		<result property="gmtTarget" column="gmt_target"/>
	</resultMap>
	
	<select id="queryFourOrFiveStar" parameterClass="java.util.HashMap" resultMap="CrmTurnStarStatisticsResultMap">
		select 
		id,
		sale_dept,
		sale_name,
		sale_account,
		star4,
		star5,
		gmt_target
		from crm_turn_star_statistics
		<dynamic prepend="where">
			<isNotEmpty property="start" prepend="and">
					gmt_target >= #start#
				<isNotEmpty property="end" prepend="and">
					#end# > gmt_target
				</isNotEmpty>				
			</isNotEmpty>
		</dynamic>
		order by gmt_target desc
	</select>
	
	<select id="queryFourOrFiveStarCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select 
		count(*)
		from crm_turn_star_statistics
		<dynamic prepend="where">
			<isNotEmpty property="start" prepend="and">
				gmt_target >= #start#
			</isNotEmpty>
			<isNotEmpty property="end" prepend="and">
				#end# > gmt_target
			</isNotEmpty>	
		</dynamic>
	</select>
	
	<select id="querySaleNameAndSaleDeptAccount" parameterClass="java.lang.String" resultMap="querySalesMap">
		select sale_name,sale_account,sale_dept 
		from crm_sale_comp 
		where sale_account=#account# and status=1
		limit 1 
	</select>
	
	<update id="updateSaleDeptByAccountAndDept" parameterClass="java.util.HashMap">
		update crm_sale_comp
		set
		sale_dept=#newDept#,
		gmt_modified=now()
		where sale_account=#account# and sale_dept=#oldDept# and status=1
	</update>
	
</sqlMap>