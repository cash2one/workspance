<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="crmCompany">

    <typeAlias alias="crmCompany" type="com.zz91.crm.domain.CrmCompany" />
    <typeAlias alias="saleCompanyDto" type="com.zz91.crm.dto.SaleCompanyDto" />
    <typeAlias alias="commCompanyDto" type="com.zz91.crm.dto.CommCompanyDto" />
    
    <resultMap class="crmCompany" id="fullResultMap">
        <result property="id" column="id"/>
        <result property="cid" column="cid"/>
        <result property="ctype" column="ctype"/>
        <result property="registStatus" column="regist_status"/>
        <result property="saleCompId" column="sale_comp_id"/>
        <result property="repeatId" column="repeat_id"/>
        <result property="cname" column="cname"/>
        <result property="uid" column="uid"/>
        <result property="account" column="account"/>
        <result property="email" column="email"/>
        <result property="name" column="name"/>
        <result property="sex" column="sex"/>
        <result property="mobile" column="mobile"/>
        <result property="phoneCountry" column="phone_country"/>
        <result property="phoneArea" column="phone_area"/>
        <result property="phone" column="phone"/>
        <result property="faxCountry" column="fax_country"/>
        <result property="faxArea" column="fax_area"/>
        <result property="fax" column="fax"/>
        <result property="address" column="address"/>
        <result property="addressZip" column="address_zip"/>
        <result property="details" column="details"/>
        <result property="industryCode" column="industry_code"/>
        <result property="memberCode" column="member_code"/>
        <result property="registerCode" column="register_code"/>
        <result property="businessCode" column="business_code"/>
        <result property="provinceCode" column="province_code"/>
        <result property="areaCode" column="area_code"/>
        <result property="areaName" column="area_name"/>
        <result property="mainBuy" column="main_buy"/>
        <result property="mainProductBuy" column="main_product_buy"/>
        <result property="mainSupply" column="main_supply"/>
        <result property="mainProductSupply" column="main_product_supply"/>
        <result property="loginCount" column="login_count"/>
        <result property="gmtLogin" column="gmt_login"/>
        <result property="gmtRegister" column="gmt_register"/>
        <result property="gmtInput" column="gmt_input"/>
        <result property="sysStar" column="sys_star"/>
        <result property="disableContact" column="disable_contact"/>
        <result property="saleAccount" column="sale_account"/>
        <result property="saleName" column="sale_name"/>
        <result property="gmtCreated" column="gmt_created"/>
        <result property="gmtModified" column="gmt_modified"/>
        <result property="position" column="position"/>
        <result property="contact" column="contact"/>
        <result property="match" column="match"/>
        <result property="matchDegree" column="match_degree"/>
        <result property="kp" column="kp"/>
    </resultMap>

    <resultMap class="saleCompanyDto" id="CompanyResultMap">
        <result property="id" column="id"/>
        <result property="cid" column="cid"/>
        <result property="uid" column="uid"/>
        <result property="account" column="account"/>
        <result property="email" column="email"/>
        <result property="name" column="name"/>
        <result property="cname" column="cname"/>
        <result property="mobile" column="mobile"/>
        <result property="registerName" column="register_name"/>
        <result property="phoneArea" column="phone_area"/>
        <result property="phone" column="phone"/>
        <result property="loginCount" column="login_count"/>
        <result property="gmtLogin" column="gmt_login"/>
        <result property="saleCompId" column="sale_comp_id"/>
        <result property="companyType" column="company_type"/>
        <result property="disableStatus" column="disable_status"/>
        <result property="contactAbleCount" column="contact_able_count"/>
        <result property="gmtContact" column="gmt_contact"/>
        <result property="gmtNextContact" column="gmt_next_contact"/>
        <result property="saleAccount" column="sale_account"/>
        <result property="saleName" column="sale_name"/>
        <result property="sysStar" column="sys_star"/>
        <result property="address" column="address"/>
        <result property="industryName" column="industry_name"/>
        <result property="provinceCode" column="province_code"/>
        <result property="areaCode" column="area_code"/>
        <result property="gmtRegister" column="gmt_register"/>
        <result property="registStatus" column="regist_status"/>
        <result property="gmtBlock" column="gmt_block"/>
        <result property="star" column="star"/>
        <result property="gmtCreated" column="gmt_created"/>
        <result property="contactCount" column="contact_count"/>
        <result property="match" column="match"/>
        <result property="receiveTime" column="receive_time"/>
        <result property="sendTime" column="send_time"/>
        <result property="ctype" column="ctype"/>
        <result property="memberCode" column="member_code"/>
    </resultMap>
	
	<resultMap class="crmCompany" id="simplyResult">
		<result property="ctype" column="ctype"/>
		<result property="cname" column="cname"/>
		<result property="name" column="name"/>
		<result property="mobile" column="mobile"/>
		<result property="phone" column="phone"/>
		<result property="address" column="address"/>
		<result property="repeatId" column="repeat_id"/>
		<result property="saleStatus" column="sale_status"/>
	</resultMap>
	
    <resultMap class="commCompanyDto" id="commCompanyResultMap" extends="CompanyResultMap">
    </resultMap>
    
    <resultMap class="crmCompany" id="simpleMap">
    	<result property="id" column="id"/>
    	<result property="star" column="star"/>
    	<result property="serviceStar" column="service_star"/>
    	<result property="source" column="source"/>
    	<result property="maturity" column="maturity"/>
    	<result property="promote" column="promote"/>
    	<result property="kp" column="kp"/>
    </resultMap>

	<resultMap class="crmCompany" id="simpleColumnMap">
		<result property="id" column="id"/>
		<result property="cname" column="cname"/>
		<result property="email" column="email"/>
		<result property="star" column="star"/>
		<result property="gmtLogin" column="gmt_login"/>
		<result property="loginCount" column="login_count"/>
		<result property="gmtRegister" column="gmt_register"/>
	</resultMap>
	
    <sql id="saleCompanyColumn">
        cc.id,
        cc.cid,
        cc.uid,
        cc.account,
        cc.email,
        p1.name as register_name,
        cc.name,
        cc.cname,
        cc.mobile,
        cc.phone_area,
        cc.phone,
        cc.login_count,
        cc.gmt_login,
        cc.gmt_register,
        cc.sys_star,
        cc.address,
        p2.name as industry_name,
        csc.id as sale_comp_id,
        csc.company_type,
        csc.disable_status,
        cc.receive_time,
        cc.send_time,
        csc.contact_count,
        csc.contact_able_count,
        csc.gmt_contact,
        csc.gmt_next_contact,
        csc.gmt_created,
        cc.regist_status,
        csc.gmt_block,
        cc.star,
        cc.province_code,
        cc.area_code,
        cc.match,
        cc.ctype,
        cc.member_code
    </sql>

    <sql id="fullColumn" >
        cc.id,
        cc.cid,
        cc.ctype,
        cc.regist_status,
        cc.sale_comp_id,
        cc.repeat_id,
        cc.cname,
        cc.uid,
        cc.account,
        cc.email,
        cc.name,
        cc.sex,
        cc.mobile,
        cc.phone_country,
        cc.phone_area,
        cc.phone,
        cc.fax_country,
        cc.fax_area,
        cc.fax,
        cc.address,
        cc.address_zip,
        cc.details,
        cc.industry_code,
        cc.member_code,
        cc.register_code,
        cc.business_code,
        cc.province_code,
        cc.area_code,
        sa.name area_name,
        cc.main_buy,
        cc.main_product_buy,
        cc.main_supply,
        cc.main_product_supply,
        cc.login_count,
        cc.gmt_login,
        cc.gmt_register,
        cc.gmt_input,
        cc.sys_star,
        cc.disable_contact,
        cc.sale_account,
        cc.sale_name,
        cc.gmt_created,
        cc.gmt_modified,
        cc.position,
        cc.contact,
        cc.match,
        cc.match_degree,
        cc.kp
    </sql>

    <resultMap class="crmCompany" id="simpleResultMap">
        <result property="id" column="id"/>
        <result property="cid" column="cid"/>
        <result property="ctype" column="ctype"/>
        <result property="cname" column="cname"/>
        <result property="uid" column="uid"/>
        <result property="account" column="account"/>
        <result property="email" column="email"/>
        <result property="name" column="name"/>
        <result property="sex" column="sex"/>
        <result property="mobile" column="mobile"/>
        <result property="phoneCountry" column="phone_country"/>
        <result property="phoneArea" column="phone_area"/>
        <result property="phone" column="phone"/>
        <result property="gmtRegister" column="gmt_register"/>
        <result property="inputAccount" column="input_account"/>
        <result property="fax" column="fax"/>
    </resultMap>
    
    <resultMap class="saleCompanyDto" id="simplySaleCompanyDtoResultMap">
    	<result property="id" column="id"/>
        <result property="registerName" column="register_name"/>
        <result property="cid" column="cid"/>
        <result property="cname" column="cname"/>
        <result property="mobile" column="mobile"/>
        <result property="phone" column="phone"/>
        <result property="phoneCountry" column="phone_country"/>
        <result property="phoneArea" column="phone_area"/>
        <result property="email" column="email"/>
        <result property="gmtContact" column="gmt_contact"/>
        <result property="gmtRegister" column="gmt_register"/>
        <result property="saleName" column="sale_name"/>
        <result property="repeatId" column="repeat_id"/>
    </resultMap>
	
	<resultMap class="crmCompany" id="contactMap">
		<result property="mobile" column="mobile"/>
        <result property="phone" column="phone"/>
	</resultMap>
	
    <sql id="simpleColumn">
        cc.id,
        cc.cid,
        cc.ctype,
        cc.cname,
        cc.uid,
        cc.account,
        cc.email,
        cc.name,
        cc.sex,
        cc.mobile,
        cc.phone_country,
        cc.phone_area,
        cc.phone,
        cc.gmt_register,
        cc.input_account,
        cc.fax
    </sql>

    <select id="queryCommCompanyByConditions" parameterClass="java.util.Map" resultMap="simpleResultMap">
        select 
        <include refid="simpleColumn"/>
        from crm_company cc
        <dynamic prepend="where">
            <isNotEmpty property="cname" prepend="and">
                cc.cname like concat('%',#cname#,'%')
            </isNotEmpty>
            <isNotEmpty property="name" prepend="and">
                cc.name like concat('%',#name#,'%')
            </isNotEmpty>
            <isNotEmpty property="email" prepend="and">
                cc.email like concat(#email#,'%')
            </isNotEmpty>
            <isNotEmpty property="mobile" prepend="and">
                cc.mobile like concat(#mobile#,'%')
            </isNotEmpty>
            <isNotEmpty property="phone" prepend="and">
                cc.phone like concat(#phone#,'%')
            </isNotEmpty>
            <isNotEmpty property="fax" prepend="and">
                cc.fax like concat(#fax#,'%')
            </isNotEmpty>
        </dynamic>
        limit #limit#
    </select>

    <select id="queryCommCompanyByContact" parameterClass="java.util.Map" resultMap="simplySaleCompanyDtoResultMap">
        select 
        cc.id,p.name as register_name,cc.cid,cc.cname,cc.mobile,cc.phone,cc.phone_country,cc.phone_area,
        cc.email,csc.gmt_contact,cc.gmt_register,csc.sale_name as sale_name,cc.repeat_id
        from crm_company cc 
        left join crm_sale_comp csc on cc.id=csc.cid and csc.sale_type=0
        left join param p on p.value=cc.register_code and types='register_type'
        where
          cc.id != #id# and cc.ctype!=4
          <isNotEmpty property="mobile" prepend="and">
              (cc.mobile like concat('%',#mobile#)
	          <isNotEmpty property="phone" prepend="or">
	              cc.phone like concat('%',#phone#)
	          </isNotEmpty>)
          </isNotEmpty>
          <isEmpty property="mobile">
	          <isNotEmpty property="phone" prepend="and">
	              cc.phone like concat('%',#phone#)
	          </isNotEmpty>
          </isEmpty>
        limit #limit#
    </select>

    <select id="queryCompanyById" parameterClass="java.util.Map" resultMap="fullResultMap">
        select 
            <include refid="fullColumn"/>
        from crm_company cc
        left join sys_area sa on sa.code=cc.area_code
        where cc.id = #id#
        <isNotEmpty property="ctype">
            and ctype = #ctype#
        </isNotEmpty>
    </select>

    <select id="queryIdByCid" parameterClass="java.lang.Integer" resultClass="java.lang.Integer">
        select id from crm_company where cid=#cid#
    </select>
    
    <sql id="dynamicQueryMyCompany">
        <dynamic prepend="where">
            <isNotNull property="search.status" prepend="and">
                csc.status = #search.status#
            </isNotNull>
            <isNotNull property="search.registStatus" prepend="and">
                cc.regist_status = #search.registStatus#
            </isNotNull>
            <isNotNull property="search.ctype">
            	<isNotEqual compareValue="-1" property="search.ctype" prepend="and">
                	cc.ctype = #search.ctype#
            	</isNotEqual>
            </isNotNull>
            <isNotEmpty property="search.saleDept" prepend="and">
                csc.sale_dept like concat(#search.saleDept#,'%')
            </isNotEmpty>
            <isNotEmpty property="search.saleAccount" prepend="and">
                csc.sale_account = #search.saleAccount#
            </isNotEmpty>
            <isNotEmpty property="search.saleName" prepend="and">
                csc.sale_name like concat('%',#search.saleName#,'%')
            </isNotEmpty>
            <isNotEmpty property="search.clSaleName" prepend="and">
                cl.sale_name like concat('%',#search.clSaleName#,'%')
            </isNotEmpty>
            <isNotNull property="search.saleType" prepend="and">
                csc.sale_type = #search.saleType#
            </isNotNull>
            <isNotEmpty property="search.cname" prepend="and">
                cc.cname like concat('%',#search.cname#,'%')
            </isNotEmpty>
            <isNotEmpty property="search.industryCode" prepend="and">
                cc.industry_code = #search.industryCode#
            </isNotEmpty>
            <isNotEmpty property="search.address" prepend="and">
                cc.address like concat('%',#search.address#,'%')
            </isNotEmpty>
            <isNotEmpty property="search.name" prepend="and">
                cc.name like concat('%',#search.name#,'%')
            </isNotEmpty>
            <isNotEmpty property="search.contact" prepend="and">
                (cc.mobile like concat('%',#search.contact#,'%')
                or cc.phone like concat('%',#search.contact#,'%'))
            </isNotEmpty>
            <isNotEmpty property="search.email" prepend="and">
                cc.email like concat('%',#search.email#,'%')
            </isNotEmpty>
            <isNotEmpty property="search.businessCode" prepend="and">
                cc.business_code = #search.businessCode#
            </isNotEmpty>
            <isNotNull property="search.sysStar" prepend="and">
                cc.sys_star = #search.sysStar#
            </isNotNull>
            <isNotEmpty property="search.mainProduct" prepend="and">
                (cc.main_product_buy like concat('%',#search.mainProduct#,'%')
                or cc.main_product_supply like concat('%',#search.mainProduct#,'%'))
            </isNotEmpty>
            <isNotEmpty property="search.provinceCode" prepend="and">
                cc.province_code = #search.provinceCode#
            </isNotEmpty>
            <isNotEmpty property="search.areaCode" prepend="and">
                cc.area_code = #search.areaCode#
            </isNotEmpty>
            <isNotEmpty property="search.gmtNextContactStart" prepend="and">
                csc.gmt_next_contact >= #search.gmtNextContactStart#
                <isNotEmpty property="search.gmtNextContactEnd" prepend="and">
                    #search.gmtNextContactEnd# > csc.gmt_next_contact
                </isNotEmpty>
            </isNotEmpty>
            <isEmpty property="search.gmtNextContactStart">
                <isNotEmpty property="search.gmtNextContactEnd" prepend="and">
                    #search.gmtNextContactEnd# > csc.gmt_next_contact
                </isNotEmpty>
            </isEmpty>
            <isNotEmpty property="search.gmtLastContactStart" prepend="and">
                csc.gmt_contact >= #search.gmtLastContactStart#
                <isNotEmpty property="search.gmtLastContactEnd" prepend="and">
                    #search.gmtLastContactEnd# > csc.gmt_contact
                </isNotEmpty>
            </isNotEmpty>
            <isEmpty property="search.gmtLastContactStart">
                <isNotEmpty property="search.gmtLastContactEnd" prepend="and">
                    #search.gmtLastContactEnd# > csc.gmt_contact
                </isNotEmpty>
            </isEmpty>
            <isNotEmpty property="search.gmtRegisterStart" prepend="and">
                cc.gmt_register >= #search.gmtRegisterStart#
                <isNotEmpty property="search.gmtRegisterEnd" prepend="and">
                    #search.gmtRegisterEnd# > cc.gmt_register
                </isNotEmpty>
            </isNotEmpty>
            <isEmpty property="search.gmtRegisterStart">
                <isNotEmpty property="search.gmtRegisterEnd" prepend="and">
                     #search.gmtRegisterEnd# > cc.gmt_register
                </isNotEmpty>
            </isEmpty>
            <isNotEmpty property="search.gmtLoginStart" prepend="and">
                cc.gmt_login >= #search.gmtLoginStart#
                <isNotEmpty property="search.gmtLoginEnd" prepend="and">
                     #search.gmtLoginEnd# > cc.gmt_login
                </isNotEmpty>
            </isNotEmpty>
            <isEmpty property="search.gmtLoginStart">
                <isNotEmpty property="search.gmtLoginEnd" prepend="and">
                    #search.gmtLoginEnd# > cc.gmt_login
                </isNotEmpty>
            </isEmpty>
            <isEqual property="search.contactStatus" compareValue="1">
                <isEqual property="search.contactFlag" compareValue="0" prepend="and">
                    csc.contact_count = #search.contactCount#
                </isEqual>
                <isEqual property="search.contactFlag" compareValue="1" prepend="and">
                    csc.contact_count > #search.contactCount#
                </isEqual>
                <isEqual property="search.contactFlag" compareValue="2" prepend="and">
                    #search.contactCount# > csc.contact_count
                </isEqual>
            </isEqual>
            <isEqual property="search.contactStatus" compareValue="2">
                <isEqual property="search.contactFlag" compareValue="0" prepend="and">
                    csc.contact_able_count = #search.contactCount#
                </isEqual>
                <isEqual property="search.contactFlag" compareValue="1" prepend="and">
                    csc.contact_able_count > #search.contactCount#
                </isEqual>
                <isEqual property="search.contactFlag" compareValue="2" prepend="and">
                    #search.contactCount# > csc.contact_able_count
                </isEqual>
            </isEqual>
            <isEqual property="search.contactStatus" compareValue="3">
                <isEqual property="search.contactFlag" compareValue="0" prepend="and">
                    csc.contact_disable_count = #search.contactCount#
                </isEqual>
                <isEqual property="search.contactFlag" compareValue="1" prepend="and">
                    csc.contact_disable_count > #search.contactCount#
                </isEqual>
                <isEqual property="search.contactFlag" compareValue="2" prepend="and">
                    #search.contactCount# > csc.contact_disable_count
                </isEqual>
            </isEqual>
            <isNotNull property="search.registerCode" prepend="and">
                cc.register_code = #search.registerCode#
            </isNotNull>
            <isNotNull property="search.companyType" prepend="and">
                csc.company_type = #search.companyType#
            </isNotNull>
            <isNotNull property="search.disableStatus" prepend="and">
                csc.disable_status = #search.disableStatus#
            </isNotNull>
            <isNotNull property="search.successStatus" prepend="and">
                csc.success_status = #search.successStatus#
            </isNotNull>
            <isNotNull property="search.disableContact" prepend="and">
                cc.disable_contact = #search.disableContact#
            </isNotNull>
            <isNotNull property="search.createAccount" prepend="and">
                cc.sale_ccount = #search.createAccount#
            </isNotNull>
            <isNotNull property="search.repeatId">
                 <isEqual property="search.repeatId" compareValue="0" prepend="and">
                 	cc.repeat_id = #search.repeatId#
                 </isEqual>
                 <isEqual property="search.repeatId" compareValue="1" prepend="and">
                 	cc.repeat_id > 0
                 </isEqual>
            </isNotNull>
            <isNotNull property="search.dragDestryStatus">
	            <isEqual property="search.dragDestryStatus" compareValue="0" prepend="and">
	                csc.drag_order_count > 0
	            </isEqual>
	            <isEqual property="search.dragDestryStatus" compareValue="1" prepend="and">
	                csc.destroy_order_count > 0
	            </isEqual>
	            <isEqual property="search.dragDestryStatus" compareValue="2" prepend="and">
	                (csc.drag_order_count > 0 or csc.destroy_order_count > 0)
	            </isEqual>
	        </isNotNull>
	        <isNotEmpty property="search.gmtCreated" prepend="and">
	        	date_format(csc.gmt_created,'%Y-%m-%d') = #search.gmtCreated#
	        </isNotEmpty>
	        <isNotEmpty property="search.autoBlock" prepend="and">
	        	csc.auto_block=#search.autoBlock#
	        </isNotEmpty>
	        <isNotEmpty property="search.loginCount" prepend="and">
	        	cc.login_count=#search.loginCount#
	        </isNotEmpty>
	        <isNotNull property="search.blockCount">
		        <isEqual property="search.blockCount" compareValue="0" prepend="and">
		        	cc.block_count=#search.blockCount#
		        </isEqual>
		        <isNotEqual property="search.blockCount" compareValue="0" prepend="and">
		        	cc.block_count>0
		        </isNotEqual>
	        </isNotNull>
	        <isNotEmpty property="search.saleStatus" prepend="and">
	        	cc.sale_status=#search.saleStatus#
	        </isNotEmpty>
	        <isNotNull property="search.star">
	        	<isEqual property="search.star" compareValue="6" prepend="and">
	        		((cl.star_old=4 and cl.star!=4) or (cl.star_old=5 and cl.star!=5))
	        	</isEqual>
	        	<isNotEqual property="search.star" compareValue="6" prepend="and">
	            	cc.star = #search.star#
	        	</isNotEqual>
            </isNotNull>
            <isNotEmpty property="search.source" prepend="and">
            	cc.source=#search.source#
            </isNotEmpty>
            <isNotEmpty property="search.maturity" prepend="and">
            	cc.maturity=#search.maturity#
            </isNotEmpty>
            <isNotEmpty property="search.promote" prepend="and">
            	cc.promote=#search.promote#
            </isNotEmpty>
            <isNotEmpty property="search.match" prepend="and">
            	cc.match=#search.match#
            </isNotEmpty>
            <isNotEmpty property="search.matchDegree" prepend="and">
            	cc.match_degree = #search.matchDegree#
            </isNotEmpty>
            <isNotEmpty property="search.mainBuy" prepend="and">
            	cc.main_buy=#search.mainBuy#
            </isNotEmpty>
            <isNotEmpty property="search.kp" prepend="and">
            	cc.kp=#search.kp#
            </isNotEmpty>
            <isNotEmpty property="search.mainSupply" prepend="and">
            	cc.main_supply=#search.mainSupply#
            </isNotEmpty>
            <isNotNull property="search.afterLogin">
            	<isEqual property="search.afterLogin" compareValue="1" prepend="and">
            		cc.gmt_login > csc.gmt_contact
            	</isEqual>
            </isNotNull>
            <isNotEmpty property="search.messageTime">
				<isEqual property="search.messageTime" compareValue="0" prepend="and">
					cc.receive_time is not null
				</isEqual>
				<isEqual property="search.messageTime" compareValue="1" prepend="and">
					cc.send_time is not null
				</isEqual>
			</isNotEmpty>
        </dynamic>
    </sql>

    <select id="queryMyCompany" parameterClass="java.util.Map" resultMap="CompanyResultMap">
        select 
            <include refid="saleCompanyColumn"/>
             ,csc.sale_account,csc.sale_name
        from crm_sale_comp csc
        inner join crm_company cc on cc.id=csc.cid
        left join param p1 on p1.value=cc.register_code and p1.types='register_type'
        left join param p2 on p2.value=cc.industry_code and p2.types='comp_industry'
        <!-- 
        left join param p3 on p3.value=cc.business_code and p3.types='company_industry_code'
         -->
        <include refid="dynamicQueryMyCompany"/>
        <include refid="common.pageOrderBy"/>
        <include refid="common.pageLimit"/>
    </select>
    <select id="queryMyCompanyCount" parameterClass="java.util.Map" resultClass="java.lang.Integer">
        select count(*)
        from crm_sale_comp csc
        inner join crm_company cc on cc.id=csc.cid
        <include refid="dynamicQueryMyCompany"/>
    </select>
    
    <select id="queryCommCompany" parameterClass="java.util.Map" resultMap="commCompanyResultMap">
        select 
            <include refid="saleCompanyColumn"/>
             ,csc.sale_account,csc.sale_name
        from crm_company cc
        left join crm_sale_comp csc on csc.id=cc.sale_comp_id and cc.id=csc.cid
        <isNotEmpty property="search.clSaleName">
        inner join crm_log cl on cl.cid=cc.id
        </isNotEmpty>
        left join param p1 on p1.value=cc.register_code and p1.types='register_type'
        left join param p2 on p2.value=cc.industry_code and p2.types='comp_industry'
         <include refid="dynamicQueryMyCompany"/>
        <include refid="common.pageOrderBy"/>
        <include refid="common.pageLimit"/>
    </select>
    
    <select id="queryCommCompanyCount" parameterClass="java.util.Map" resultClass="java.lang.Integer">
        select count(distinct cc.id)
        from crm_company cc
        left join crm_sale_comp csc on csc.id=cc.sale_comp_id and cc.id=csc.cid
        <isNotEmpty property="search.clSaleName">
        inner join crm_log cl on cl.cid=cc.id
        </isNotEmpty>
        <include refid="dynamicQueryMyCompany"/>
    </select>
    
    <insert id="createCompany" parameterClass="crmCompany">
       INSERT INTO crm_company (
           regist_status,
           cname,
           ctype,
           email,
           name,
           sex,
           mobile,
           phone_country,
           phone_area,
           phone,
           fax_country,
           fax_area,
           fax,
           member_code,
           address,
           address_zip,
           details,
           industry_code,
           business_code,
           province_code,
           area_code,
           main_buy,
           main_product_buy,
           main_supply,
           main_product_supply,
           gmt_login,
           gmt_register,
           gmt_input,
           sale_account,
           sale_name,
           gmt_created,
           gmt_modified,
           input_account)
       VALUES (
           #registStatus#,
           #cname#,
           #ctype#,
           #email#,
           #name#,
           #sex#,
           #mobile#,
           #phoneCountry#,
           #phoneArea#,
           #phone#,
           #faxCountry#,
           #faxArea#,
           #fax#,
           #memberCode#,
           #address#,
           #addressZip#,
           #details#,
           #industryCode#,
           #businessCode#,
           #provinceCode#,
           #areaCode#,
           #mainBuy#,
           #mainProductBuy#,
           #mainSupply#,
           #mainProductSupply#,
           now(),
           now(),
           now(),
           #saleAccount#,
           #saleName#,
           now(),
           now(),
           #inputAccount#
           )
       <selectKey keyProperty="id" resultClass="java.lang.Integer">
           select LAST_INSERT_ID()
       </selectKey>
    </insert>
    <update id="updateRepeatId" parameterClass="java.util.Map">
        update crm_company 
        set 
        repeat_id = #newId#,
        gmt_modified=now()
        where id=#id#
    </update>
    <update id="updateRegistStatus" parameterClass="java.util.Map">
        update crm_company 
        set
        <isNotEmpty property="memberCode">
	        <isEqual compareValue="10011001" property="memberCode">
	        	ctype=3,
	        </isEqual>
        </isNotEmpty>
        regist_status = #status#,
        gmt_modified=now()
        where id=#id#
    </update>
    <update id="updateCompany" parameterClass="crmCompany">
        update crm_company
        set
        <isNotEmpty property="cname">
            cname = #cname#,
        </isNotEmpty>
        <isNotEmpty property="memberCode">
        	member_code=#memberCode#,
        </isNotEmpty>
        <isNotEmpty property="email">
            email = #email#,
        </isNotEmpty>
        <isNotEmpty property="name">
            name = #name#,
        </isNotEmpty>
        <isNotEmpty property="sex">
            sex = #sex#,
        </isNotEmpty>
        <isNotEmpty property="mobile">
            mobile = #mobile#,
        </isNotEmpty>
        <isNotEmpty property="phoneCountry">
            phone_country = #phoneCountry#,
        </isNotEmpty>
        <isNotEmpty property="phoneArea">
            phone_area = #phoneArea#,
        </isNotEmpty>
        <isNotEmpty property="phone">
            phone = #phone#,
        </isNotEmpty>
        <isNotEmpty property="faxCountry">
            fax_country = #faxCountry#,
        </isNotEmpty>
        <isNotEmpty property="faxArea">
            fax_area = #faxArea#,
        </isNotEmpty>
        <isNotEmpty property="fax">
            fax = #fax#,
        </isNotEmpty>
        <isNotEmpty property="address">
            address = #address#,
        </isNotEmpty>
        <isNotEmpty property="addressZip">
            address_zip = #addressZip#,
        </isNotEmpty>
        <isNotEmpty property="details">
            details = #details#,
        </isNotEmpty>
        <isNotEmpty property="industryCode">
            industry_code = #industryCode#,
        </isNotEmpty>
        <isNotEmpty property="businessCode">
            business_code = #businessCode#,
        </isNotEmpty>
        <isNotEmpty property="provinceCode">
            province_code = #provinceCode#,
        </isNotEmpty>
        <isNotEmpty property="areaCode">
            area_code = #areaCode#,
        </isNotEmpty>
        <isNotEmpty property="mainBuy">
            main_buy = #mainBuy#,
        </isNotEmpty>
        <isNotEmpty property="mainProductBuy">
            main_product_buy = #mainProductBuy#,
        </isNotEmpty>
        <isNotEmpty property="mainSupply">
            main_supply = #mainSupply#,
        </isNotEmpty>
        <isNotEmpty property="mainProductSupply">
            main_product_supply = #mainProductSupply#,
        </isNotEmpty>
        <isNotEmpty property="match">
            `match` = #match#,
        </isNotEmpty>
        <isNotEmpty property="matchDegree">
        	match_degree = #matchDegree#,
        </isNotEmpty>
        gmt_modified = now()
        where id=#id#
    </update>

    <update id="updateCtypeByid" parameterClass="java.util.Map">
        update crm_company 
        set 
        ctype=#newType#,
        <isEqual property="newType" compareValue="2">
          block_count=block_count+1,
        </isEqual>
        sale_status=0,
        gmt_modified=now()
        where id=#id#
    </update>

    <update id="updateDisableContactByid" parameterClass="java.util.Map">
        update crm_company 
        set 
        disable_contact=#status#,
        gmt_modified=now() 
        where id=#id#
    </update>
    
    <update id="updateSaleCompIdById" parameterClass="java.util.HashMap">
    	update crm_company 
    	set 
    	sale_comp_id=#saleCompId#,
    	gmt_modified=now()
    	where id=#cid#
    </update>
    
    <select id="queryContactById" parameterClass="java.lang.Integer" resultMap="contactMap">
    	select mobile,phone
    	from crm_company 
    	where id=#cid#
    </select>
    
    <select id="queryCountByMobileAndEmail" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
    	select count(*)
    	from crm_company
    	where mobile=#mobile# or email=#email#
    </select>
    
    <select id="queryCountById" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
    	select count(*) 
    	from crm_company 
    	where id=#id# and ctype=#ctype#
    </select>
    
    <select id="queryCompById" parameterClass="java.lang.Integer" resultMap="simplyResult">
    	select ctype,cname,name,mobile,phone,address,repeat_id,sale_status
    	from crm_company
    	where id=#id#
    </select>
    
    <update id="updateStarByCid" parameterClass="java.util.HashMap">
    	update crm_company 
    	set 
    	<isNotEmpty property="callType">
	   		<isEqual property="callType" compareValue="0">
			    star=#newStar#,
	   		</isEqual>
	   		<isEqual property="callType" compareValue="1">
	 			service_star=#newStar#,
	   		</isEqual>
    	</isNotEmpty>
    	source=#source#,
    	maturity=#maturity#,
    	promote=#promote#,
    	sale_account=#saleAccount#,
        sale_name=#saleName#,
        kp=#kp#,
    	gmt_modified=now()
    	where id=#id#
    </update>
    
    <select id="queryStarById" parameterClass="java.lang.Integer" resultMap="simpleMap">
		select id,star,service_star,source,maturity,promote,kp from crm_company where id=#id#
	</select>
	
	<update id="updateSaleStatusById" parameterClass="java.util.HashMap">
		update crm_company 
		set 
    	sale_status=#saleStatus#,
    	gmt_modified=now()
    	where id=#id#
	</update>
	
	<select id="queryOnceFourOrFive" parameterClass="java.util.HashMap" resultMap="commCompanyResultMap">
		select 
		<include refid="saleCompanyColumn"/>
		 ,cc.sale_account,cc.sale_name
		from crm_log cl 
		inner join crm_company cc on cc.id=cl.cid
		left join crm_sale_comp csc on csc.cid=cc.id
		left join param p1 on p1.value=cc.register_code and p1.types='register_type'
        left join param p2 on p2.value=cc.industry_code and p2.types='comp_industry'
        <include refid="dynamicQueryMyCompany"/>
         <isNotNull property="search.star">
        	<isEqual property="search.star" compareValue="6">
        		group by cc.id
        	</isEqual>
          </isNotNull>
        <include refid="common.pageOrderBy"/>
        <include refid="common.pageLimit"/>
	</select>
	
	<select id="queryOnceFourOrFiveCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select 
		count(distinct cc.id)
		from crm_log cl 
		inner join crm_company cc on cc.id=cl.cid
		left join crm_sale_comp csc on csc.cid=cc.id
        <include refid="dynamicQueryMyCompany"/>
	</select>
	
	<select id="querySimplyCompById" parameterClass="java.lang.Integer" resultMap="simpleColumnMap">
		select id,cname,email,star,gmt_login,login_count,gmt_register
		from crm_company where id=#value#
	</select>
	
	
	<!-- crm数据导出 start -->
	<typeAlias alias="crmCompanyDto" type="com.zz91.crm.dto.CrmCompanyDto"/>
	
	<resultMap class="crmCompanyDto" id="simplyCompMap">
		<result property="cid" column="cid"/>
		<result property="account" column="account"/>
		<result property="cname" column="cname"/>
		<result property="industryName" column="industry_name"/>
		<result property="name" column="name"/>
		<result property="phone" column="phone"/>
		<result property="mobile" column="mobile"/>
		<result property="fax" column="fax"/>
		<result property="address" column="address"/>
		<result property="loginCount" column="login_count"/>
		<result property="gmtLogin" column="gmt_login"/>
		<result property="gmtRegister" column="gmt_register"/>
		<result property="star" column="star"/>
		<result property="ctype" column="ctype"/>
		<result property="saleName" column="sale_name"/>
	</resultMap>
	
	<select id="querySimplyComp" resultMap="simplyCompMap">
		select cc.cid,account,cname,p.name as industry_name,cc.name,phone,mobile,fax,
		address,login_count,gmt_login,gmt_register,star,ctype,csc.sale_name
		from crm_company cc
		left join crm_sale_comp csc on csc.cid=cc.id
		left join param p on p.value=cc.industry_code and p.types='comp_industry'
		where login_count>=1 and ctype!=4 and sale_status=0 
	</select>
	
	<!-- crm数据导出 end -->
	
	<select id="queryCnameById" parameterClass="java.lang.Integer" resultClass="java.lang.String">
		select cname from crm_company where id=#value#
	</select>
	
	<resultMap class="saleCompanyDto" id="baseCompResultMap">
		<result property="id" column="id"/>
		<result property="cid" column="cid"/>
		<result property="uid" column="uid"/>
		<result property="saleCompId" column="sale_comp_id"/>
		<result property="account" column="account"/>
		<result property="email" column="email"/>
		<result property="sysStar" column="sys_star"/>
		<result property="star" column="star"/>
		<result property="name" column="name"/>
		<result property="cname" column="cname"/>
		<result property="mobile" column="mobile"/>
		<result property="phoneArea" column="phone_area"/>
		<result property="phone" column="phone"/>
		<result property="saleAccount" column="sale_account"/>
		<result property="saleName" column="sale_name"/>
		<result property="gmtLogin" column="gmt_login"/>
		<result property="gmtRegister" column="gmt_register"/>
		<result property="address" column="address"/>
		<result property="registStatus" column="regist_status"/>
		<result property="memberCode" column="member_code"/>
		<result property="provinceCode" column="province_code"/>
		<result property="areaCode" column="area_code"/>
		<result property="registerName" column="register_name"/>
		<result property="industryName" column="industry_name"/>
		<result property="inputAccount" column="input_account"/>
		<result property="ctype" column="ctype"/>
		<result property="fax" column="fax"/>
	</resultMap>
	
	<sql id="hunmaDynamicWhereSearch">
		where cc.sale_comp_id=0 and (cc.ctype=1 or cc.ctype=3)
		<isNotEmpty property="company.cname" prepend="and">
			cc.cname like concat(#company.cname#,'%')
		</isNotEmpty>
		<isNotEmpty property="company.fax" prepend="and">
			cc.fax like concat(#company.fax#,'%')
		</isNotEmpty>
		<isNotEmpty property="company.name" prepend="and">
			cc.name like concat (#company.name#,'%')
		</isNotEmpty>
		<isNotEmpty property="company.inputAccount" prepend="and">
			cc.input_account like concat(#company.inputAccount#,'%')
		</isNotEmpty>
		<isNotEmpty property="company.phone" prepend="and">
			(cc.mobile like concat('%',#company.phone#,'%')
			or cc.phone like concat('%',#company.phone#,'%'))
		</isNotEmpty>
		<isNotEmpty property="company.memberCode" prepend="and">
			cc.member_code = #company.memberCode#
		</isNotEmpty>
	</sql>
	
	<select id="queryBaseComp" parameterClass="java.util.HashMap" resultMap="baseCompResultMap">
		select cc.id,cc.cid,cc.uid,cc.sale_comp_id,cc.account,cc.email,cc.sys_star,cc.star,cc.name,
		cc.cname,cc.mobile,cc.phone_area,cc.phone,cc.sale_account,cc.sale_name,cc.gmt_login,
		cc.gmt_register,cc.address,cc.regist_status,cc.member_code,cc.area_code,cc.province_code,
		p1.name as register_name,p2.name as industry_name,cc.input_account,cc.ctype,cc.fax
		from crm_company cc
		left join param p1 on p1.value=cc.register_code and p1.types='register_type'
		left join param p2 on p2.value=cc.industry_code and p2.types='comp_industry'
		<include refid="crmCompany.hunmaDynamicWhereSearch"/>
		<include refid="common.pageOrderBy"/>
		<include refid="common.pageLimit"/>
	</select>
	
	<select id="queryBaseCompCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select count(id) from crm_company cc
		<include refid="crmCompany.hunmaDynamicWhereSearch"/>
	</select>
</sqlMap>