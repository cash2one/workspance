<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <link rel='stylesheet' type='text/css' href='../css/bootstrap.min.css' />
</head>
<body>
<div class="container-fluid">
    <div class="page-header"><h2>ipaynow</h2><small>请到网站控制台云编译体验</small></div>
    <div class="row">
        <div class="col-xs-12">
            <div class="row">
                <div class="col-xs-12 btn-group btn-group-justified diy-btn-group-test">
                    <div class="btn-group">
                        <button  tapmode="" type="button" onclick="generatePresignMessage()" class="btn btn-primary">
                            现在支付
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="main">
    <label id='interstitialstatuslab'></label>
</div>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript">
    function generatePresignMessage(){
        Date.prototype.format = function(format)
        {
            var o = {
                "M+" : this.getMonth()+1, //month
                "d+" : this.getDate(),    //day
                "H+" : this.getHours(),   //hour
                "m+" : this.getMinutes(), //minute
                "s+" : this.getSeconds(), //second
                "q+" : Math.floor((this.getMonth()+3)/3),  //quarter
                "S" : this.getMilliseconds() //millisecond
            }
            if(/(y+)/.test(format))
            {
                format=format.replace(RegExp.$1,(this.getFullYear()+"").substr(4 - RegExp.$1.length));
            }

            for(var k in o)
            {
                if(new RegExp("("+ k +")").test(format))
                {
                    format = format.replace(RegExp.$1,RegExp.$1.length==1 ? o[k] : ("00"+ o[k]).substr((""+ o[k]).length));
                }
            }
            return format;
        }

        var da = (new Date()).format("yyyyMMddHHmmss");
        var demo = api.require("ipaynow");
        var param = {appId:"1408709961320306",mhtCharset:"UTF-8",mhtCurrencyType:"156",mhtOrderAmt:"10",mhtOrderDetail:"关于订单验证接口的测试",mhtOrderName:"IOS插件测试用例",mhtOrderNo:da,mhtorderStartTime:da,mhtOrderType:"01",notifyUrl:"http://localhost:10802/"};
        demo.generatePresignMessage(param, doSignature);
    }

    function doSignature(ret, err){
        var originStr=ret.preSignStr;
        var url="http://yuyangnews.ipaynow.cn/ZyPluginPaymentTest_PAY/api/pay2.php";

        var demo = api.require('ipaynow');
        var param = {preSignStr:originStr,post_content:"paydata="+originStr,post_url:url};
        demo.doSignature(param, pay);
        /* $api.post('http://yuyangnews.ipaynow.cn/ZyPluginPaymentTest_PAY/api/pay2.php',
         "paydata="+originStr
         ,function(ret){
         pay(originStr+"&"+ret);
         },'text');
         */
    }

    function pay(ret, err){
        if(ret.result=="fail"){
            alert("签名失败");
        }
        var paydata=ret.preSignStr+"&"+ret.resultStr;
        var demo = api.require('ipaynow');
        var param = {data:paydata,urlSchema:"UZApp"};
        demo.pay(param, callBack);

    }

    function callBack(ret, err){
        alert(ret.result);
    }

    apiready = function(){

    };


</script>
</html>