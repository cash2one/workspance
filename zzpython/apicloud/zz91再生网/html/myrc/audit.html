<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>我的供求-已审核</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/common.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/myrc/audit.css"/>
</head>
<body>
<ul class="look-list">
	<!-- <li>
		<div class="look-title"><i></i>供应PP再生料</div>
		<div class="look-time">发布时间：2015-03-12  17:36
			<span class="alter">修改</span>
			<span class="newinfo">刷新</span>
		</div>
	</li> -->
</ul>
</body>
<script id="info-list" type="text/html">
	<li>
		<div class="look-title"><i></i>{{ d.protitle }}</div>
		<div class="look-time">发布时间：{{ d.real_time }}
			<span class="alter">修改</span>
			<span class="newinfo" proid="{{ d.proid }}">刷新</span>
		</div>
	</li>
</script>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/zepto.min.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/laytpl.js"></script>
<script type="text/javascript">
	var currPage = 1;
	apiready= function() {
		// alert(api.frameName)
		api.showProgress({title:'加载中',modal:false});
		ajaxInfo();
		//加载更多
		api.addEventListener({
			name : 'scrolltobottom'
		}, function(ret, err) {
			currPage += 1;
			if($(".mui-spinner").length==0){
				$("body").append("<div class='mui-spinner' style='text-align:center;height:50px;line-height:50px;font-size:16px;'>更多加载中...</div>");
			}
			
			setTimeout(function(){
				ajaxInfo();
			},1000)
		});
		//页面刷新
		api.setRefreshHeaderInfo({
			visible : true,
			// bgColor: '#F2F2F2',
			bgColor : '#E6E6E6',
			textColor : '#000000',
			textDown : '下拉刷新',
			textUp : '释放刷新',
		}, function(ret, err) {
			currPage = 1;
			ajaxInfo();
			api.refreshHeaderLoadDone();
			api.hideProgress();
			api.toast({
				msg : '数据已是最新！',
				duration : 3000,
				location : 'bottom'
			});
		});
		$(".look-list").on("click",".look-title",function(){
			if($(this).hasClass("look-title-gou")){
				$(this).removeClass("look-title-gou")
			}else{
				$(this).addClass("look-title-gou")
			}
		})
		//打开底部按钮栏
		openfoot();
	}
	function ajaxInfo(){
		var company_id =  UserInfo.memberID();
		var usertoken = UserInfo.token();
		api.ajax({
		    url : hosturl + 'myrc_products/?company_id='+ company_id +'&usertoken='+ usertoken +'&checkStatus=1&appsystem='+ api.systemType +'&datatype=json&page='+ currPage,
		    method : 'get',
		    timeout : 30,
		    dataType : 'json',
		    returnAll : false
		}, function(ret, err) {
		    if (ret) {
		    	// alert(JSON.stringify(ret))
		        var pageHtml = "";
		        $.each(ret.qlistall.list, function(index, item) {
			        var getTpl = $api.html($api.byId("info-list"));
			        laytpl(getTpl).render(item, function(html) {
			            pageHtml = pageHtml + html;
			        });
		        })
		        if(currPage == 1){
		        	if(ret.qlistall.list.length == 0){
		    			pageHtml = "<li style='text-align:center'>暂无数据</li>"
		    		}
		        	$(".look-list").html(pageHtml);
					var numberList = JSON.stringify(ret.count)
		        	api.execScript({
					    name: 'buyinout',
					    frameName:'buyinout_',
					    script: "getInfoNumber("+ numberList +")"
					});
		        }else{
		        	$(".look-list").append(pageHtml)
		        }
		        api.hideProgress();
		        $(".mui-spinner").remove();
		    } else {
		    	api.hideProgress();
		    };
		});
	}
	function openfoot(){
		// alert(api.frameName)
		var oHeight = $(window).height()+38;
		var systemType = api.systemType;
		if(systemType!="ios"){
			oHeight = oHeight-10;
		}
		api.openFrame({
		    name: 'audit-foot',
		    url: './audit-foot.html',
		    rect:{
		        x:0,
		        y:oHeight,
		        w:"auto"
		    },
		    pageParam: {name:'audit-foot'},
		    bounces: false,
		 });
	}
	function allinfo(){
		var data = {
			company_id:UserInfo.memberID(),
			usertoken:UserInfo.token()
		}
		api.ajax({
		    url : hosturl + 'products_refreshall/',
		    method : 'post',
		    timeout : 30,
		    dataType : 'json',
		    returnAll : false,
		    data:{
		    	values:data
		    }
		}, function(ret, err) {
		    if (ret) {
		    	if(ret.err =="true"){
		    		api.alert({
					    title: '发布失败',
					    msg: ret.errkey,
					    buttons:['确定']
					},function(ret,err){
					})
		    	}else{
		    		currPage = 1;
					ajaxInfo();
		    	}
		    } else {
		    };
		});
	}
	//点击刷新单条数据
	$(".look-list").on("click",".newinfo",function(){
		var proid = $(this).attr("proid");
		bitInfo(proid)
	})
	function moreInfo(){
		var proid=[];
		$(".look-title-gou").each(function(i,item){
			proid[i] = $(this).parent().find(".newinfo").attr("proid")
		})
		if(proid.length == 0){
			api.alert({
			    title: '刷新操作',
			    msg: "请选择一条供求刷新",
			    buttons:['确定']
			},function(ret,err){
			})
			return;
		}
		proid = proid.join(",")
		bitInfo(proid);
	}
	//刷新操作
	function bitInfo(proid){
		var data = {
			proid:proid,
			company_id:UserInfo.memberID(),
			usertoken:UserInfo.token()
		}
		api.ajax({
		    url : hosturl + 'products_refresh/',
		    method : 'post',
		    timeout : 30,
		    dataType : 'json',
		    returnAll : false,
		    data:{
		    	values:data
		    }
		}, function(ret, err) {
		    if (ret) {
		    	if(ret.err =="true"){
		    		api.alert({
					    title: '发布失败',
					    msg: ret.errkey,
					    buttons:['确定']
					},function(ret,err){
					})
		    	}else{
		    		currPage = 1;
					ajaxInfo();
		    	}
		    } else {
		    };
		});
	}
	//暂不发布炒作
	function notOut(){
		var proid=[];
		$(".look-title-gou").each(function(i,item){
			proid[i] = $(this).parent().find(".newinfo").attr("proid")
		})
		if(proid.length == 0){
			api.alert({
			    title: '刷新操作',
			    msg: "请选择一条供求赞不发布",
			    buttons:['确定']
			},function(ret,err){
			})
			return;
		}
		proid = proid.join(",")
		var data = {
			proid:proid,
			company_id:UserInfo.memberID(),
			usertoken:UserInfo.token()
		}
		api.ajax({
		    url : hosturl + 'products_stop/',
		    method : 'post',
		    timeout : 30,
		    dataType : 'json',
		    returnAll : false,
		    data:{
		    	values:data
		    }
		}, function(ret, err) {
		    if (ret) {
		    	if(ret.err =="true"){
		    		api.alert({
					    title: '暂不发布',
					    msg: ret.errkey,
					    buttons:['确定']
					},function(ret,err){
					})
		    	}else{
		    		currPage = 1;
					ajaxInfo();
		    	}
		    } else {
		    };
		});
	}
</script>
</html>