<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>列表页</title>
		<link rel="stylesheet" type="text/css" href="../../css/api.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/common.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/trade/trade-list.css"/>
	</head>
	<body>
		<div class="nodata">暂无相关数据</div>
		<ul class="hq-list">
			<!-- <li>
			<img src="../../image/infoimage.png" class="hq-list-img">
			<div class="hq-list-tg">亚洲PPPPPPPPPPPPPPPPP</div>
			<div class="hq-list-mo"><span>无锡</span><span class="hq-list-ringht">58500.0元</span></div>
			<div class="hq-list-mo"><span>2015/09/21</span><span class="hq-list-ringht">75%接听率</span></div>
			</li> -->
		</ul>
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../script/zepto.min.js"></script>
	<script type="text/javascript" src="../../script/common.js"></script>
	<script type="text/javascript" src="../../script/laytpl.js"></script>
	<script id="info-list" type="text/html">
		<li class="change-bgcolor" id="{{ d.pdt_id }}">
		<img src="{{ d.pdt_images }}" class="hq-list-img">
		<div class="hq-list-tg">{{ d.pdt_detail }}</div>
		<div class="hq-list-mo"><span>{{ d.com_province }}</span><span class="hq-list-ringht">{{ d.pdt_price }}</span></div>
		<div class="hq-list-mo"><span>{{ d.pdt_time_en }}</span><span class="hq-list-ringht" style="display:{{ d.phone_display }}">{{ d.phone_rate }}%接听率</span></div>
		</li>
	</script>
	<script type="text/javascript">
		var currPage = 1;
		var tradetype = "0";
		var timearg = "";
		var province = "";
		var keywords = "";
		apiready = function() {
			$(".hq-list").on("click", "li", function() {
				var id = $(this).attr("id");
				var pageParam = {
					wintitle : "供求详情",
					type : "infomation-heart",
					id : id,
					nav_list : [{
						"typename" : "供求详情",
						"id" : 1
					}, {
						"typename" : "公司简介",
						"id" : 2
					}], //头部划动标题
					frame_url : ["../trade/firm-detail.html", "../trade/firm.html"], //打开frame组的页面集合
					topnumber : 2,
					bounces : false
				};
				openWin("infomation-heart", "infomation-heart.html", pageParam);
			})
			//页面刷新
			api.setRefreshHeaderInfo({
				visible : true,
				// bgColor: '#F2F2F2',
				bgColor : '#E6E6E6',
				textColor : '#000000',
				textDown : '下拉刷新',
				textUp : '释放刷新',
			}, function(ret, err) {
				currPage = 1;
				ajaxInfo();
				api.refreshHeaderLoadDone();
				api.hideProgress();
				api.toast({
					msg : '数据已是最新！',
					duration : 3000,
					location : 'bottom'
				});
			});
			//底部加载更多
			api.addEventListener({
				name : 'scrolltobottom'
			}, function(ret, err) {
				if ($(".mui-spinner").length == 0) {
					$("body").append("<div class='mui-spinner' style='text-align:center;height:50px;line-height:50px;font-size:14px;color:#999'>更多加载中...</div>");
				}
				setTimeout(function() {
					ajaxInfo();
				}, 10)
			});
			//获取数据
			api.showProgress({
				title : '加载中',
				modal : false
			});
			keywords = api.pageParam.label_hex;
			ajaxInfo();
		}
		function changsearche(trade_type) {
			currPage = 1;
			api.showProgress({
				title : '加载中',
				modal : false
			});
			tradetype = trade_type;
			ajaxInfo()
		}

		//筛选供求
		function choicesearch(timearg1, province1) {
			currPage = 1;
			timearg = timearg1;
			if (province1) {
				province = province1.substr(0, province1.length - 1);
			}
			provincetext = ""
			if (province) {
				var provincearr = province.split("|");
				if (provincearr) {
					for ( i = 0; i <= provincearr.length; i++) {
						if (provincearr[i] != "" && provincearr[i]) {
							provincetext = provincetext + provincearr[i] + "|"
						}
					}
				}
			}
			province = provincetext.substr(0, provincetext.length - 1);
			api.showProgress({
				title : '加载中',
				modal : false
			});
			ajaxInfo()
		}

		//筛选点击
		function choicechick() {
			var pageParam = {
				wintitle : "筛选",
				type : "choice",
				module : "确定",
				province : province,
				timearg : timearg
			};
			openWin("choice", "../trade/choice.html", pageParam);
		}

		//关键字搜索
		function keywordssearch(keywordstext) {
			currPage = 1;
			keywords = keywordstext;
			api.showProgress({
				title : '加载中',
				modal : false
			});
			ajaxInfo();
		}

		var dataload = true;
		function ajaxInfo() {
			if (dataload == true) {
				dataload = false;
				api.ajax({
					url : hosturl + 'offerlist/?keywords=' + keywords + '&ptype=' + tradetype + '&timearg=' + timearg + '&province=' + province + '&datatype=json&page=' + currPage,
					method : 'get',
					timeout : 30,
					dataType : 'json',
					returnAll : false
				}, function(ret, err) {
					//alert(hosturl + 'offerlist/?keywords=' + keywords + '&ptype=' + tradetype + '&timearg=' + timearg + '&province=' + province + '&datatype=json&page=' + currPage)
					if (ret) {
						var pageHtml = "";
						var productList = ret.productList;
						if (currPage != 1) {
							productList = ret;
						}
						
						$.each(productList, function(index, item) {
							if (item.phone_rate == 0 || item.phone_rate == null) {
								item.phone_display = "none"
							} else {
								item.phone_display = ""
							}
							var getTpl = $api.html($api.byId("info-list"));
							laytpl(getTpl).render(item, function(html) {
								pageHtml = pageHtml + html;
							});
						})
						//如果是刷新页面，数据替换，如果不是插上新数据在底部，currPage == 1为刷新数据
						if (currPage == 1) {
							if (pageHtml==""){
		                		$(".nodata").show();
		                	}else{
		                		$(".nodata").hide();
		                    }
							api.pageUp({
								'top' : true
							});
							$(".hq-list").html(pageHtml);
						} else {
							$(".hq-list").append(pageHtml);
						}
						$(".mui-spinner").remove();
						api.hideProgress();
						currPage += 1;
					} else {
					};
					dataload = true;
				});
			}
		}
	</script>
</html>