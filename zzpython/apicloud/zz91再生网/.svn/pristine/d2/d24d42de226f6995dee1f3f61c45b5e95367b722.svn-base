<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<title>供求详情</title>
		<link rel="stylesheet" type="text/css" href="../../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../../css/aui.css" />
		<link rel="stylesheet" type="text/css" href="../../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../../css/trade/firm-detail.css" />
	</head>
	<body>
		<div class="box">
			<div class="aui-loading">
				<div class="aui-loading-1"></div><div class="aui-loading-2"></div>
			</div>
			<script id="info-list" type="text/html">
				<div class="firm-img" style="display:{{ d.display }}">
				<img src="{{ d.piclist[0].images_big }}" width="100%">
				<div class="firm-imgtext">{{ d.lenpiclist }}张</div>
				</div>
				<div style="background-color: #fff;margin-bottom: 10px;">
				<!--<div style="display:{{ d.display }};color: #666;font-size: 12px;text-align: center;">共{{ d.lenpiclist }}张，点击查看大图</div>-->
				<h2 class="firm-name">{{ d.title }}</h2>
				<div class="member-type">
				<span class="color-green">所&nbsp;&nbsp;在&nbsp;&nbsp;地：</span>{{ d.address }}
				</div>
				<div class="member-type">
				<span class="color-green">发布日期：</span>{{ d.refresh_time }}
				</div>
				<div class="member-type">
				<span class="color-green">有&nbsp;&nbsp;效&nbsp;&nbsp;期：</span>{{ d.expire_time }}
				</div>
				<div class="member-type">
				<span class="color-green">价&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;格：</span>{{ d.min_price }}~{{ d.max_price }}{{ d.price_unit }}
				</div>
				<div class="member-type">
				<span class="color-green">数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;量：</span>{{ d.quantity }}{{ d.quantity_unit }}
				</div>
				</div>
				<div style="background-color: #fff;margin-bottom: 10px;">
				<div class="member-type">
				{{ d.details }}
				</div>
				<div style="clear: both;"></div>
				</div>
				<div style="clear: both;"></div>
				<div style="background-color: #fff;">
				<div class="member-type"><span class="color-green">公司名称：</span>{{ d.compname }}</div>
				<div class="member-type"><span class="color-green">联&nbsp;&nbsp;系&nbsp;&nbsp;人：</span>{{ d.contact }}</div>
				<div class="member-type"><span class="color-green">地&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;址：</span>{{ d.address }}</div>
				<!--<div class="member-type color-red">
				<span class="color-green">联系方式：</span><span class="tell-num"><i></i>{{ d.mobile }}</span>
				</div>-->
				<div style="clear: both;"></div>
				</div>
				<!--<div class="firm-do clear">
				<span class="shouc"><i></i>收藏信息</span><span class="liuy"><i></i>给我留言</span>
				</div>-->
			</script>
		</div>
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../script/jquery.js"></script>
	<script type="text/javascript" src="../../script/zepto.min.js"></script>
	<script type="text/javascript" src="../../script/common.js"></script>
	<script type="text/javascript" src="../../script/laytpl.js"></script>
	<script type="text/javascript" src="../../script/aui-alert.js" ></script>
	<script type="text/javascript">
		var imgList = [];
		var shouchangdata;
		var leaveworddata;
		var phonedata;
		//所有数据列
		var detailsdata;
		apiready = function() {
			$(".box").on("click", ".firm-img", function() {
				api.openWin({
					name : 'imglist',
					url : '../trade/imglist.html',
					pageParam : {
						name : 'imglist',
						imglist : imgList
					}
				});
			});
			api.parseTapmode();
			ajaxInfo();
		}
		//收藏
		function shoucFun() {
			loadingshow();
			if (shouchangdata) {
				shoucInfo(shouchangdata);
			}
		}

		//留言
		function leavewordFun() {
			if (leaveworddata) {
				openWin("huifu", "../trade/huifu.html", leaveworddata);
			}
		}

		//打电话
		function phoneFun() {
			if (phonedata == "") {
				//未登录
				var login_sn = UserInfo.has_login();
				if　(!login_sn){
					var pageParam = {
				      wintitle:"登录再生网",
				      type:"frm-login"
				    };
				    openWin("frm-login","../myrc/frm-login.html",pageParam);
				    return false;
				}
				
				
				var html = "";
				html += '<p style="color: #000000;">查看此联系方式需<font color="#FF0000">5</font>元，确定付款？</p>'
				html += '<p style="color:#C4C4C4;margin-top:10px">如虚假信息、虚假号码等可举报申请退款</p>'
				$aui.alert({
					title : '提示',
					content : html,
					buttons : ['确定', '取消'],
					radius : 10,
					titleColor : '#333',
					contColor : '#333',
					btnColor : ''
				}, function(ret) {
					//处理回调函数
					if (ret) {
						if (ret == 0) {
							loadingshow();
							//判断余额是否够
							api.ajax({
								url : hosturl + 'viewcontact.html',
								method : 'post',
								timeout : 30,
								dataType : 'json',
								data : {
									values : {company_id:UserInfo.memberID(),forcompany_id:detailsdata.list.company_id,paytype:1,id:detailsdata.list.pdtid}
								},
								returnAll : false,
							}, function(ret, err) {
								//alert(JSON.stringify(ret))
								if (ret.err=="true" && ret.errkey=='余额不足'){
									yuebuzuFun();
								}else{
									if (ret.err=="false"){
										//alert(JSON.stringify(detailsdata))
										api.execScript({
											name : 'infomation-heart',
											frameName : 'infomation-heart_',
											script : "loadpostcontact('" + detailsdata.list.contact + "','" + detailsdata.list.mobile + "')"
										});
										phonedata=detailsdata.list.mobile;
									}else{
										api.toast({
										    msg: '系统错误，请重试',
										    duration: 2000,
										    location: 'bottom'
										});
									}
								}
								loadinghide();
							});
						}
					}
				});
			} else {
				$aui.alert({
					title : '',
					content : '<div style="text-align:center;font-size:16px">是否拨打电话 <br />' + phonedata.toString() + '</div>',
					buttons : ['拨打', '举报', '取消'],
					radius : 10,
					titleColor : '#333',
					contColor : '#333',
					btnColor : ''
				}, function(ret) {
					//处理回调函数
					if (ret) {
						if (ret == 0) {
							api.call({
								type : 'tel',
								number : phonedata
							});
							//保存电话记录
							savedata_noback("http://m.zz91.com/trade/telclicklog.html?tel=" + phonedata + "&pagefrom=apptrade&company_id=" + UserInfo.memberID())
						}
					}
				});
			}
		}
		//余额不足
		function yuebuzuFun(){
			var html = "";
				html += '<p style="color: #000000;">您的余额不足，是否充值？</p>'
				$aui.alert({
					title : '提示',
					content : html,
					buttons : ['充值', '取消'],
					radius : 10,
					titleColor : '#333',
					contColor : '#333',
					btnColor : ''
				}, function(ret) {
					//处理回调函数
					if (ret) {
						if (ret == 0) {
							var pageParam = {
					            wintitle:"我的再生钱包",
					            type:"call-moery",
					        };
					        openWin("call-moery","../myrc/call-moery.html",pageParam);
						}
					}
				});
		}
		function ajaxInfo() {
			var id = api.pageParam.id;
			api.ajax({
				url : hosturl + 'detail/?id=' + id + '&datatype=json&company_id='+UserInfo.memberID()+'&appsystem='+api.systemType+"&t=" + (new Date()).getTime().toString(),
				method : 'get',
				timeout : 30,
				dataType : 'json',
				returnAll : false
			}, function(ret, err) {
				// alert(JSON.stringify(ret))
				detailsdata=ret
				if (ret.list) {
					//判断是否有图片，没有图片对象中添加隐藏属性
					if (ret.list.piclist.length == 0) {
						ret.list.piclist[0] = "";
						ret.list.display = "none";
					} else {
						ret.list.display = "";
					}
					//展示获取的信息
					var getTpl = $api.html($api.byId("info-list"));
					laytpl(getTpl).render(ret.list, function(html) {
						$(".box").html(html)
					});
					//把图片数组对象的大图单独提取出来拿来做参数提取
					$.each(ret.list.piclist, function(index, item) {
						imgList[index] = item.images_big;
					})
					var Pid = ret.id, forcompany_id = ret.forcompany_id;
					var lvdata = {
						wintitle : "给我留言",
						type : "huifu",
						Pid : Pid,
						forcompany_id : forcompany_id,
						be_inquired_type : 0
					};
					leaveworddata = lvdata;
					var favorite_type_code = ret.list.products_type_code == 10331000 ? 10091000 : 10091001;
					var data = {
						company_id : UserInfo.memberID(),
						usertoken : UserInfo.token(),
						appsystem : api.systemType,
						datatype : "json",
						favorite_type_code : favorite_type_code,
						forcompany_id : ret.forcompany_id,
						content_id : ret.id,
						title : ret.list.title,
						pdtid : ret.list.pdtid,
						products_type_code : ret.list.products_type_code
					};
					shouchangdata = data;
					//判断是否来电宝
					//alert(JSON.stringify(ret.list.viptype.ldb))
					if (ret.list.viptype.ldb) {
						if (ret.list.viptype.ldb.ldbphone) {
							phonedata = ret.list.viptype.ldb.ldbphone
						}
					} else {
						phonedata = ret.list.mobile.toString();
						if (phonedata==""){
							phonedata = "无号码";
							ret['isseecompany']=1;
						}
						//alert(JSON.stringify(ret))
						if (ret.isseecompany) {
							phonedata = ret.list.mobile.toString();
							//用户错误
							if (phonedata==""){
								phonedata = "无号码"
							}
						} else {
							phonedata = "";
						}
					}
					api.execScript({
						name : 'infomation-heart',
						frameName : 'infomation-heart_',
						script : "loadpostcontact('" + ret.list.contact + "','" + phonedata + "')"
					});
					api.hideProgress();
				} else {
					api.hideProgress();
				};
			});
		}
	</script>
</html>