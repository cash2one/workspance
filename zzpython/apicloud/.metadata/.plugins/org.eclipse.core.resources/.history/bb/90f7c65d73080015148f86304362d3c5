<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>性情中人</title>
		<link rel="stylesheet" type="text/css" href="css/api.css"/>
		<link rel="stylesheet" type="text/css" href="css/common.css"/>
		<script type="text/javascript" src="script/api.js"></script>
		<style>
			/*
			 iscroll
			 */
	        .nav_active{
	        	border-bottom: solid 2px #CF2D28;
	        }
	        .nav_active a {
	            color: #DC282E;
	        }
			#wrapper {
				position: relative;
				z-index: 1;
				height: 37px;
				width: 90%;
				overflow: hidden;
			}
			#scroller {
				position: absolute;
				z-index: 1;
				-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
				height:35px;
				width:700%;
				/*-webkit-transform: translateZ(0);
				 transform: translateZ(0);*/
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				-webkit-text-size-adjust: none;
			}
			#scroller ul {
				list-style: none;
				padding: 0;
				margin: 0;
				display: -webkit-box
			}
			#scroller li {
				width:64px;
				line-height: 35px;
				font-size: 14px;
				overflow: hidden;
				text-align: center;
				padding-left:5px;
				padding-right:5px; 
			}
			/*
			 iscroll
			 */
			
			nav {
				width: 100%;
				display: -webkit-box;
				background-color: #F6F6F6;
			}
			.arrow_down {
				display: block;
				background-size: 15px;
				background-repeat: no-repeat;
				background-position: center;
				padding: 15px;
				background-image: url('image/channel_nav_arrow@2x.png');
				-webkit-box-flex: 1;
				-webkit-transform: rotate(180deg);
				-webkit-transition: All .5s ease;
			}
			.arrow_up {
				-webkit-transform: rotate(0deg);
				-webkit-transition: All .5s ease;
			}
			.switchNav {
				position: relative;
				width: 90%;
				line-height: 35px;
				text-indent: 10px;
			}
			.navTips {
				width: 70px;
				height: 15px;
				position: absolute;
				right: 0;
				bottom: 10px;
				font-size: 12px;
				line-height: 16px;
				color: #DE0000;
				margin-top: 2px;
				border: 1px solid;
				border-radius: 10px;
			}
			.cover {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				z-index: 999;
			}
			#footer {
				width: 100%;
				text-align: center;
				height: 56px;
				line-height: 55px;
				background-color: #f2f2f2;
				position: fixed;
				bottom:0px;
			}
			.cloud {
				background-image: url(image/bottombtn0101.png);
			}
			.client {
				background-image: url(image/bottombtn0201.png);
			}
			.dev {
				background-image: url(image/bottombtn0301.png);
			}
			.doc {
				background-image: url(image/bottombtn0401.png);
			}
			#footer li {
				-webkit-box-flex: 1;
				-webkit-flex: 1;
				flex: 1;
				height: 55px;
			}
			#footer ul {
	
	            display: -webkit-box;
	            display: -webkit-flex;
	            display: flex;
	        }
			.bottom_btn {
				background-position-y: 4px;
				padding-top: 16px;
				font-size: 12px;
				color: #323237;
				width: 99%;
				height: 39px;
				background-repeat: no-repeat no-repeat;
				background-position-x: center;
				background-size: 30px;
			}
			.active .cloud {
				background-image: url(image/bottombtn0102.png);
			}
			.active .client {
				background-image: url(image/bottombtn0202.png);
			}
			.active .dev {
				background-image: url(image/bottombtn0302.png);
			}
			.active .doc {
				background-image: url(image/bottombtn0402.png);
			}
			.active .bottom_btn {
				color: #6ab494;
				background-size: 30px;
			}
			.activebar {
	            display: block;
	        }
		</style>
	</head>
	<body tapmode="" onclick="clearFilter()">
		<header>
			<div class=" header index-header">
				<div class="title">
					<div class="btn logo " tapmode="">
						两性知识
					</div>
				</div>
				<div class="btn user" tapmode="" onclick="openUser()"></div>
			</div>
		</header>
		<nav>
			<div id="wrapper">
				<div id="scroller">
					<ul><li></li></ul>
				</div>
			</div>
			<div class="switchNav hidden">
				切换栏目
			</div>
			<div class="arrow_down" onclick="openNav()" tapmode=""></div>
		</nav>
		<div class="cover hidden" tapmode=""></div>
		
		<div id="footer">
			<ul>
				<li tapmode="active" class="active" onclick="randomSwitchBtn(this,'cloud',0)">
					<a class="bottom_btn cloud">最新</a>
				</li>
				<li tapmode="active" onclick="randomSwitchBtn(this,'client',1)">
					<a class="bottom_btn client ">订阅</a>
				</li>
				<li tapmode="active" onclick="randomSwitchBtn(this,'dev',2)">
					<a class="bottom_btn dev ">我的</a>
				</li>
				<li tapmode="active" onclick="randomSwitchBtn(this,'dev',2)">
					<a class="bottom_btn dev ">我的</a>
				</li>
			</ul>
		</div>
		<script type="text/javascript" src="script/zepto.min.js"></script>
		<script type="text/javascript" src="script/iscroll.js"></script>
		<script>
			var myScroll, menuOpened = false;
			var navwidth=0,navliwidth=0;
			var typelist=[];
			//顶部滑动栏目
			function loaded() {
				try {
					myScroll = new IScroll('#wrapper', {
						eventPassthrough : true,
						scrollX : true,
						scrollY : false,
						preventDefault : false
					});
					
				} catch (e) {
					//alert(e)
				}
			}

			//获得栏目地址
			function getNavlist() {
				api.showProgress();
				api.ajax({
					url : 'http://app.zjfriend.com/sex/navlist.html',
					method : 'get',
					timeout : 30,
					pageParam : {
						t : (new Date()).getTime().toString()
					},
					dataType : 'text',
					returnAll : false
				}, function(ret, err) {
					
					if (ret) {
						ret=eval(ret)
						var navHtml = '', frames = [];
						for (var i in ret) {
                            var active = i == 0 ? 'nav_active' : '', frame = {};
                            navHtml += '<li data-index="' + i + '" id="' + ret[i].id + '" class="' + active + '" tapmode="" onclick="openFrame('+ret[i].id+','+i+')">' + ret[i].typename + '</li>';
                            frame.name = 'frame_' + i;
                            frame.url = i == 0 ? 'html/sexmain.html?typeid='+ret[i].typeid.toString() : 'html/sexmain.html?typeid='+ret[i].typeid.toString();
                            frame.pageParam = {typeid: ret[i].typeid,index:ret[i].numb};
                            frames.push(frame);
                            typelist.push(ret[i].id);
                        }
                        $("#scroller").find('ul').html(navHtml);
                        
						liwidth=ret.length;
						navliwidth=$("#scroller").find('li').width();
						navwidth=(liwidth*navliwidth+$("body").width()/2-30).toString();
						$("#scroller").css("width",navwidth.toString()+"px");
						loaded();
						openfooter(frames);
						api.hideProgress();
					} else {
						api.toast({msg: err.msg, location: 'middle'})
					};
				});
			}
			

			apiready = function() {
				try {
					getNavlist();
					fixIos7Bar($(".header"));
				} catch (e) {
				}
			}
			//加载栏目内容
			function openFrame(tid,m) {
				try {
				alert(tid)
					api.setFrameGroupIndex({
		                name: 'sexgroup',
		                index: m,
		                scroll: true
		            });
					//api.execScript({
						//frameName : 'frame_'+m.toString(),
						//script : 'changesexmain(' + tid.toString() + ')'
					//});
					if (m>=3){
						//myScroll.scrollTo(-navliwidth * (m - 4), 0, 1000);
					}else{
						myScroll.scrollTo(0,0,1000)
					}
					$("#scroller").find('li').removeClass('nav_active');
					$("#scroller").find('li').removeClass('nav_active').eq(m).addClass('nav_active');
					//var obj=document.getElementById("topnav"+m.toString())
					//obj.className="nav_active";
				} catch (e) {
					alert(e)
				}
			}
			

			function openfooter(frames) {
				var $header = $api.dom('header');
		        $api.fixIos7Bar($header);
				var $body = $api.dom('body');
				var $footer = $api.byId('footer');
				var header_h = $("header").height() + $("nav").height();
				var body_h = $api.offset($body).h;
				var footer_h = $api.offset($footer).h;
				var rect_h = body_h - header_h - footer_h;
				api.openFrameGroup({
					name : 'sexgroup',
					scrollEnabled : true,
					rect : {
						x : 0,
						y : header_h,
						w : 'auto',
						h : rect_h
					},
					index : 0,
					frames : frames
				}, function(ret, err) {
					if (ret.index >= 3) {
		                //yScroll.scrollTo(-$("li").width() * (ret.index - 4), 0, 1000);
		                myScroll.scrollTo(-navliwidth * (ret.index - 2), 0, 1000);
		            }
		            //openFrame(typelist[ret.index],ret.index,'')
		            $("#scroller").find('li').removeClass('nav_active').eq(ret.index).addClass('nav_active');
				});
			}

			function openNav() {
				var $arrow_down = $('.arrow_down');
				if ($arrow_down.hasClass('arrow_up')) {
					$arrow_down.removeClass('arrow_up');
					$(".switchNav").addClass('hidden');
					$("#wrapper").removeClass('hidden');
					_closeNav()
				} else {
					$(".switchNav").removeClass('hidden');
					$("#wrapper").addClass('hidden');
					$arrow_down.addClass('arrow_up');
					_openNav();
				}
			}

			function _openNav() {
				api.openFrame({
					name : 'frm_nav',
					url : 'html/frm_nav.html',
					rect : {
						x : 0,
						y : $("header").height() + $("nav").height(),
						w : $("body").width(),
						h : 'auto'
					},
					bounces : false
				});
			}

			function _closeNav() {
				api.closeFrame({
					name : 'frm_nav'
				});
				api.closeFrame({
					name : 'frm_more_nav'
				})
			}

			function openMenu() {
				if ($('.arrow_down').hasClass('arrow_up')) {
					$('.arrow_down').removeClass('arrow_up');
					$(".switchNav").addClass('hidden');
					$("#wrapper").removeClass('hidden');
					_closeNav()
				} else {
					/*if (!menuOpened) {
					api.openFrame({
					name: 'menu',
					url: 'html/frm_menu.html',
					bounces: false,
					rect: {
					x: -($("body").width()),// -($("body").width() * .25),
					y: 0,
					w: $("body").width(),
					h: $("body").height()
					}
					});
					menuOpened = true;
					}*/
					//_animation(api.winWidth * 0.75, addFilter);
				}
			}

			function addFilter() {
				$(".cover").removeClass('hidden');
				$("body").addClass('filter');
				api.execScript({
					frameName : 'topLine',
					script : 'addFilter()'
				});
			}

			function _animation(x, callBack) {
				api.animation({
					name : 'menu',
					duration : 200,
					curve : 'easeIn',
					translation : {
						x : x,
						y : 0,
						z : 0
					}
				}, function() {
					if (callBack) {
						callBack();
					}
				});
			}

			function closeMenu() {
				_animation(-api.winWidth * 0.75, function() {
					api.execScript({
						frameName : 'topLine',
						script : '_clearFilter()'
					});
					$("body").removeClass('filter');
					$(".cover").addClass('hidden');
				});
			}

			function openUser() {
				api.openWin({
					name : 'user',
					url : 'html/win_user.html'
				})
			}

			function clearFilter() {
				if ($("body").hasClass('filter')) {
					closeMenu();
				}
			}
		</script>
	</body>
</html>