<!doctype html>
<html lang="chs">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0,user-scalable=0">
    <title>APP3CMAP</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/common.css" />
    <style>
    	.op{
			display:-webkit-box;
		   -webkit-box-orient: horizontal;
			margin:10px;
			border-bottom:1px solid;
		}
		#loadarea{
			border:1px solid;
		}
		hr{
			border-bottom:1px solid;
			margin:5px;
		}
    	.btn {
		    background-color: #EEEEEE;
		    background-image: -webkit-linear-gradient(top, #EEEEEE, #CCCCCC);
		    border-color: #CCCCCC #CCCCCC #BBBBBB;
		    -webkit-border-radius: 4px;
		    border-style: solid;
		    border-width: 1px;
		    color: #333333;
		    font: bold 18px;
		    padding: 8px 0;
		    text-align: center;
		    text-shadow: 0 1px 0 #EEEEEE;
		    width: 180px;
		    margin-top:15px;
		}
		
		.btn-small {
		    background-color: #EEEEEE;
		    background-image: -webkit-linear-gradient(top, #EEEEEE, #CCCCCC);
		    border-color: #CCCCCC #CCCCCC #BBBBBB;
		    -webkit-border-radius: 4px;
		    border-style: solid;
		    border-width: 1px;
		    color: #333333;
		    font-size:0.8em;
		    padding: 8px 0;
		    display:-webkit-box;
		  	-webkit-box-flex:1;
		  	-webkit-box-pack:center;
		  	-webkit-box-align:center;
		    width: 60px;
		    margin-top:15px;
		    margin-left:10px;
		}

		.active {
		    background-color: #CCCCCC;
		    background-image: -webkit-linear-gradient(top, #CCCCCC, #DDDDDD);
		    border-color: #CCCCCC #CCCCCC #BBBBBB;
		}
		
		.item{
			font-size:0.8em;
		}
    
    </style>
    <script type="text/javascript">
    
		function closeManagerView(){

			dmg.closeManagerView();
		}

		var dmg = null;
		
        apiready = function() {
        	dmg = api.require('downloadManager');
        }
        
        function openview(){
        	dmg.openManagerView(onItemClick);
        }
        
        function startdown(){
        	var url = "http://117.78.7.24:3000/case_res/mov.mp4";
        	var icon = "http://117.78.7.24:3000/case_res/mp4Preview.png";
        	dmg.enqueue({url:url, iconPath:icon}, function(ret, err){
        		alert(ret.id);
        	});
        }
        
        function startdown1(){
        	var url = "http://117.78.7.24:3000/case_res/time.mp3";
        	var icon = "http://117.78.7.24:3000/case_res/mp3Preview.png";
        	dmg.enqueue({url:url, iconPath:icon}, function(ret, err){
        		alert(ret.id);
        	});
        }
        
        function startdown2(){
        	var url = "http://117.78.7.24:3000/case_res/qsbk.apk";
        	var icon = "http://117.78.7.24:3000/case_res/apkPreview.png";
        	dmg.enqueue({url:url, iconPath:icon}, function(ret, err){
        		alert(ret.id);
        	});
        }
        
        var list = null;
        function query(){
        	dmg.query(function(ret, err){
        		if(ret && ret.data){
        			list = ret.data;
        			var len = list.length;
					if(0 == len){
						document.getElementById('list').innerHTML = "";
						alert('没有任何下载数据');
						return;
					}
		        	var inner = "";
		        	for (var i in list) {
		        		var ons = list[i];
						var id = ons.id;
						var status = ons.status;
						var title = ons.title;
						var totalSize = ons.totalSize;
						var finishSize = ons.finishSize;
						var mimeType = ons.mimeType;
						var reason = ons.reason;
						var savePath = ons.savePath;
						var url = ons.url;
						if(status == 0){
							status = '等待下载';
							reason = '无错误';
						}else if(status == 1){
							status = '正在下载';
							reason = '无错误';
						}else if(status == 2){
							status = '暂停中..';
							reason = '无错误';
						}else if(status == 3){
							status = '下载成功';
							reason = '无错误';
						}else{
							status = '下载发生错误';
							if(reason == 1000){
								reason = '未知错误';
							}else if(reason == 1001){
								reason = 'I/O错误，存储已满，下载文件已存在等';
							}else if(reason == 1002){
								reason = '未发现存储设备';
							}else if(reason == 1003){
								reason = '目标资源发生了重定向';
							}else if(reason == 1004){
								reason = '网络资源错误，如不存在等';
							}else{
								reason = '无';
							}
						}
						var p = finishSize / totalSize;
						p = (Math.round(p * 100) / 100) * 100 + '%';
			          	var item = "<li class='item'> " + 
									"<div id='id'>id：" + id + "</div> " +    
					              	"<div id='status'>下载状态：" + status + "</div> " + 
					              	"<div id='title'>标题：" + title + "</div> " + 
					              	"<div id='percent'>文件大小：" + totalSize + "</div> " + 
					              	"<div id='percent'>完成大小：" + finishSize + "</div> " +
					              	"<div id='percent'>完成进度：" + p + "</div> " + 
					              	"<div id='mimeType'>文件类型：" + mimeType + "</div> " + 
					              	"<div id='reason'>失败原因：" + reason + "</div> " + 
					              	"<div id='savePath'>本地保存路径：" + sub(savePath) + "</div> " + 
					              	"<div id='url'>下载路径：" + sub(url) + "</div> " + 
					              	"<div class='op'> " + 
					              		"<div class='btn-small' tapmode='active' onclick='pause(" + id + ")'>暂停</div> " + 
					              		"<div class='btn-small' tapmode='active' onclick='resume(" + id + ")'>继续</div> " + 
					              		"<div class='btn-small' tapmode='active' onclick='removeDownload(" + id + ")'>删除</div> " +
					              		"<div class='btn-small' tapmode='active' onclick='openApp(" + id + ")'>打开</div> " +
					              	"</div> " + 
			        			"</li> <br><br>";
			          	
			          	inner += item;
		        	}
		        	document.getElementById('list').innerHTML = inner;
		        }else{
		        	document.getElementById('list').innerHTML = "";
					alert('没有任何下载数据');
		        }
		     });
        }
        
        function isFinish(did){
        	if(!list){
        		return false;
        	}
        	for(var i in list){
        		var ons = list[i];
        		if(ons.id == did){
        			if(3 == ons.status){
        				return true;
        			}
        		}
        	}
        	return false;
        }
        
        function sub(str){
        	
        	return str.substring(0, 15);
        }
        
        function pause(did){
        	dmg.pause({id:did}, function(ret, err){
        		if(ret && !ret.status){
        			alert('操作失败：' + ret.msg);
        		}
        		query();
        	});
        }
        
        function resume(did){
        	dmg.resume({id:did}, function(ret, err){
        		if(ret && !ret.status){
        			alert('操作失败：' + ret.msg);
        		}
        		query();
        	});
        }
        
        function removeDownload(did){
        	var ids = [did];
        	dmg.remove({ids:ids}, function(ret, err){
        		if(ret){
        			var number = ret.number;
        			if(number > 0){
        				alert('删除成功');
        			}else{
        				alert('删除失败，该下载不存在');
        			}
        		}
        		query();
        	});
        }
        
        function openApp(did){
        	if(!isFinish(did)){
        		alert('文件还在下载');
        		return;
        	}
        	dmg.openDownloadedFile({id:did}, function(ret, err){
        		//query();
        	});
        }

		function onItemClick(ret, err){
        	if(ret){
				var did = ret.id;
        		dmg.openDownloadedFile({id:did});
        	}
        }
        
	</script>
</head>
<body>
    <div >
        <div id="main"> 
            <div  >
            	<p>Download Manager</p><hr>
            	<div class="btn" tapmode="active" onclick="openview()" >打开下载界面</div> <hr>
            	<div class="btn" tapmode="active" onclick="startdown()">开始下载一个MP4</div>
            	<div class="btn" tapmode="active" onclick="startdown1()">开始下载一个MP3</div>
            	<div class="btn" tapmode="active" onclick="startdown2()">开始下载一个应用程序包</div> <hr>
            	<div class="btn" tapmode="active" onclick="query()">查询下载</div>
            </div><br>
            <div id='loadarea'>
            	<ul id="list">
					<!-- <li class='item'>
						<div id='id'>id：20</div>   
		              	<div id='status'>状态：下载中</div>
		              	<div id='title'>标题：《来自星星的你》</div>
		              	<div id='percent'>下载情况：1222/10000 - 11.2%</div>
		              	<div id='mimeType'>文件类型：video/mp4</div>
		              	<div id='reason'>失败原因：</div>
		              	<div id='savePath'>本地保存路径：file://xx</div>
		              	<div id='url'>下载路径：http://xxx</div>
		              	<div class='op'><div class='btn-small' tapmode='active' onclick='openApp()'>暂停</div>
		              	<div class='btn-small' tapmode='active' onclick='openApp()'>继续</div>
		              	<div class='btn-small' tapmode='active' onclick='openApp()'>删除</div>
		              	<div class='btn-small' tapmode='active' onclick='openApp()'>打开</div></div>
        			</li><br><br> -->
    			</ul>
            </div>
        </div>   
    </div>
</body>
</html>