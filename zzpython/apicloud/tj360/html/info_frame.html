<!DOCTYPE html>
<html>
<head>
<title>资源信息</title>
<meta charset="utf-8">
<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
<meta name="copyright" content="www.thundersoft.com" />
<meta name="format-detection" content="telephone=no" />
<meta name="format-detection" content="address=no" />
<link rel="stylesheet" href="../css/base.css">
<script src="../script/api.js"></script>
<script src="../script/common.js"></script>
<style>
	html, body{
		width: 100%;
		height: 100%;
	}
	body{
		background-color: #FAFAFA;
	}
	#main{
		overflow: hidden;
	}
	nav{
		display: -webkit-box;
		text-align: center;
		background-color: #FAFAFA;
	}
	nav a{
		width: 50%;	
		/*color: #00b8ff;	*/
		color: #fff;
		font-size: 16px;
		font-weight: bold;
		padding: 8px 0;
		background-color:  #00b8ff;
	}
	nav a:nth-child(2){	
		border-right: 1px solid #FAFAFA;
		border-bottom: 1px solid #FAFAFA;
		border-bottom-right-radius: 4px;
		background-color: #00b8ff;
	}
	nav a:nth-child(1){	
		border-left: 1px solid #FAFAFA;
		border-bottom: 1px solid #FAFAFA;
		border-bottom-left-radius: 4px;
		background-color: #00b8ff;
	}
	.current{
		border:0px !important;
		color: #00b8ff;
		background-color: #fff !important;
		/*color: #FAFAFA !important;
		border:0px !important;
		background-color: #00b8ff !important;*/
	}
	#list section{
		display: -webkit-box;
		padding-left: 8px;
		padding-right: 8px;
	}
	#list section:nth-child(odd){
		padding-top: 12px;
	}
	#list section:nth-child(even){
		padding-bottom: 12px;
		border-bottom: 1px solid #CCCCCC;
	}
	#list section:nth-child(even) div{
		font-size: 14px;
		line-height: 18px;
		-webkit-box-flex: 1;
		word-wrap: break-word;
		word-break: break-all;
	}
	#list .imgwrap img{
		margin-right: 10px;
		border: 1px solid #B3B3B3;
		border-radius: 4px;
	}
	#list .contentwrap{
		padding-top: 7px;
		padding-bottom: 7px;
		-webkit-box-flex: 1;
	}
	.title{
		font-weight: bold;
		/*color: #00b8ff;*/
		color: rgb(50. 50. 50);
		text-overflow:ellipsis;
		overflow:hidden;
		white-space:nowrap;
		-webkit-box-flex: 1;
		margin-bottom: 7px;
	}
	.content, .telnumwrap, .telnum{
		font-size: 14px;
		line-height: 18px;
	}
	.content {
		overflow: hidden;
		/*text-overflow: ellipsis;*/
		/* white-space: nowrap; */
		/*-webkit-line-clamp: 2;*/
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		color: #808080;
	}
	.telnumwrap{
		margin-bottom: 5px;
	}
	.telnum{
		color: #00b8ff !important;
		text-decoration: underline;
	}
	.telnumActivity{
		color: #00b8ff !important;
	}
	.nodata{
		display: -webkit-box;
		-webkit-box-align: center;
		-webkit-box-pack: center;
		background-color: #FAFAFA;
		-webkit-box-flex: 1;
		font-size: 14px;
		padding-top: 40px;
	}
	.loadmore {height: 40px; line-height: 40px; text-align: center; font-size: 14px;border-top: 1px solid #e0e0e0;display: none;}
</style>
</head>

<body>
	<div id="main">
		<header id="subheader">
			<nav>
				<!-- <a id="listnav" class="current"  style="display:none;" tapmode="">列表显示</a>
				<a id="mapnav" tapmode="" style="display:none;">地图显示</a> -->
				<a id="listnav" class="current"  tapmode="" onclick="changeNav(0)">列表显示</a>
				<a id="mapnav" tapmode="" onclick="changeNav(1)">地图显示</a>
			</nav>
		</header>
		<div id="list">

			<!-- <section><div class="imgwrap"><img src="../image/default.png" width="75px" height="75px"/></div>
			<div class="contentwrap">
			<div class="title">北京向日葵伙伴自闭症康复研究中心</div>
			<div class="telnumwrap">电话:<span tapmode="telnumActivity" class="telnum" onclick="">1515151</label></div>
			<div class="content">北京向日葵伙伴自闭症康复研究中心北京向日葵伙伴自闭症康复研究中心北京向日葵伙伴自闭症康复研究中心北京向日葵伙伴自闭症康复研究中心北京向日葵伙伴自闭症康复研究中心北京向日葵伙伴自闭症康复研究中心北京向日葵伙伴自闭症康复研究中心北京向日葵伙伴自闭症康复研究中心</div>
			</div></section>
		
			<section><div class="imgwrap"><img src="../image/default.png" width="75px" height="75px"/></div>
			<div class="contentwrap">
			<div class="title">北京向日葵伙伴自闭症康复研究中心</div>
			<div class="telnumwrap">电话:<span tapmode="telnumActivity" class="telnum" onclick="">1515151</label></div>
			<div class="content">北京向日葵伙伴自闭症康复研究中心北京向日葵伙伴自闭症康复研究中心北京向日葵伙伴自闭症康复研究中心北京向日葵伙伴自闭症康复研究中心北京向日葵伙伴自闭症康复研究中心北京向日葵伙伴自闭症康复研究中心北京向日葵伙伴自闭症康复研究中心北京向日葵伙伴自闭症康复研究中心</div>
			</div></section> -->

			
		</div>
		<div class="loadmore">
			加载更多
		</div>
	</div>
</body>
<script>
	var headH = '0';
	
	var pageIndex = 0;
	var inLoading = false;
	var needLoadMore = false;
	
	var annoArray = [];
	var bubbleMap = {};
	var map = '';
	
	var model;
	var query;
	var isReload_;
	var jsonList    = [];
	var totalcount      = 0;
	var alreadyshow     = 0;
	var limitItemNum	= 10;

	apiready = function() {
		map = api.require('baiduMap');
		
		var pageParam = api.pageParam;
		headH = pageParam.headH;

		model = api.require('model');
        query = api.require('query');
          

        model.config({appId:'A6961693132912',appKey:'727724FF-FD26-C97B-B317-366723CA78A2',host: 'https://d.apicloud.com'});

		api.showProgress({modal: false});

		//下拉到页面底部，加载更多
		api.addEventListener({name:'scrolltobottom'}, function(){
			var loadmore = $api.dom('.loadmore');

			if (alreadyshow <= totalcount ) {
				loadmore.style.display = 'block';
				api.showProgress({modal: true });
				loadData(false);
			}
			else {
				loadmore.style.display = 'none';
			}

	        // if (needLoadMore) {
	        //     loadData(false);
	        // }
	    });

	    //下拉刷新
	    api.setRefreshHeaderInfo({
	    	visible:true, 
	    	bgColor: '#F2F2F2', 
	    	textColor: '#000000',
	    	textDown: '下拉刷新',
	    	textUp: '释放刷新'
	    },function(ret,err){
	        loadData(true);
	    });

	    // 获得总条目
		getTotalNum ();

		loadData(true);
	};

	function setAllcount (ret, err) {
		if (ret) {
			totalcount = ret.count
		}
		else{
		}
	}

	// 获取全部表中全部条目
	function getTotalNum () {
		query.createQuery(function(ret, err) {
			if (ret && ret.qid) {
				var queryId = ret.qid;
				model.count({
					class: "resource",
					qid: queryId
				}, setAllcount);
			}
		});
	}

	function ajaxBack(ret,err){
    	inLoading = false;
    	if(ret){
    		if(ret.length > 0){ 
    			// var list = ret;
    			// var html = createContent(list);	    							
    			// 获得返回值，解析内容
    			jsonList = jsonList.concat(ret);
    			var html = createContent();

    			pageIndex++;

    			alreadyshow += limitItemNum;
    			$api.append($api.byId('list'), html);
				api.hideProgress();
				api.refreshHeaderLoadDone();

				// 显示气泡
				annoArray = [];
				bubbleMap = {};
				getArray(jsonList, jsonList.length);//将要设置的气泡位置放入数组
				// alert(JSON.stringify(annoArray[0]));

				// if(isReload_){//如果是刷新
				// 	$api.html($api.byId('list'), html);
				// 	annoArray = [];//重新初始化
				// 	bubbleMap = {};
				// 	getArray(ret, ret.length);//将要设置的气泡位置放入数组
					
				// 	api.refreshHeaderLoadDone();
				// 	setTimeout(function(){api.hideProgress();}, 300);
				// }else{
				// 	$api.html($api.byId('list'), html);
				// 	annoArray = [];//重新初始化
				// 	bubbleMap = {};
				// 	getArray(ret, ret.length);//将要设置的气泡位置放入数组
					
				// 	api.refreshHeaderLoadDone();
				// 	setTimeout(function(){api.hideProgress();}, 300);
				//如果是加载更多
					//$api.append($api.byId('list'), html);
					//api.toast({msg: '已加载更多', location: 'bottom'});
					//getArray(ret, ret.length);//将要设置的气泡位置放入数组
				// }
				api.parseTapmode();
    		}else if(ret.length == 0){
    			api.refreshHeaderLoadDone();
    			api.hideProgress();
    			if(isReload_){//如果是刷新
					var html = '<div class="nodata">暂无信息</div>';
					$api.html($api.byId('list'), html);
				}
    		}
    		
    		if(pageIndex < ret.pages){
    			needLoadMore = true;
    		}else{
    			needLoadMore = true;
    		}
    	}else{
    		api.refreshHeaderLoadDone();
    		api.hideProgress();
    		if(ret){
    			api.toast({msg: ret.msg, location: 'middle'});
    		}else if(err){
    			api.toast({msg: err.msg, location: 'middle'});
    		}else{
    			api.toast({msg: '数据错误', location: 'middle'});
    		}
    		var html = '<div class="nodata">数据错误，请下拉刷新重试！</div>';
    		$api.html($api.byId('list'), html);
    	}
    }

	function loadData(isReload_){
		if (inLoading) {//如果还在加载中，不执行操作
	        return;
	    }
	    inLoading = true;
	    if (isReload_) {//下拉刷新，即重新载入,pageIndex为0
	        pageIndex = 0;
	    }
	    
	    query.createQuery(function (ret, err) {
            if (ret && ret.qid) {
                var queryId = ret.qid;

                // 设置limit
				query.skip({qid: queryId, value:parseInt(alreadyshow)+''});
				query.limit({qid: queryId, value:limitItemNum+''});
				
                model.findAll({class: "resource", qid: queryId}, ajaxBack);
            }

        });
  
	}
	
	function createContent(list){
		var html = '';
		// for(var i=0; i<list.length; i++){
		for(var i=alreadyshow; i<jsonList.length; i++){
			var src = '../image/default.png';
			if(jsonList[i].ciricon){
				src = jsonList[i].ciricon;
			}
			var description = jsonList[i].description ? jsonList[i].description : '';
			
			html += '<section><div class="imgwrap"><img src="' + src + '" width="75px" height="75px"/></div>';
			html += '<div class="contentwrap">';
			html += '<div class="title">' + jsonList[i].cirname + '</div>';
			html += '<div class="telnumwrap">电话:<span tapmode="telnumActivity" class="telnum" onclick="callFn(\'' + jsonList[i].contacts + '\')">' + jsonList[i].contacts + '</label></div>';
			html += '<div class="content">' + jsonList[i].caddress + '</div>';
			html += '</div></section>';
			html += '<section><div>' + description + '</div></section>';
		}
		return html;
	}
	
	//把要设置气泡的位置放入数组annoArray,把气泡的图片和id放入数组bubbleMap
	//base的值为(pageIndex - 1)*20，这样做是因为如果不止20条数据，会分页加载(分页显示为每页20条)，如果直接id为i，则重复
	function getArray(list, base){
		for(var i=0; i<list.length; i++){
			var obj = {
				id: i,
				lon:list[i].longitude,
				lat:list[i].latitude,
				title:list[i].cirname,
				subTitle:'电话:' + list[i].contacts + '\n' + '地址:' + list[i].caddress
			};
			annoArray.push(obj);
			// alert(JSON.stringify(annoArray));
			// bubbleMap[i] = list[i].ciricon ? (list[i].ciricon) : '../image/default.png';
		}
	}
	
	function mapDisplay(){
		var lastKey = 'EkbItWgiHNnap3qvzfiqwGkS';
		var subheader = $api.byId('subheader');
		var subheaderPos = $api.offset(subheader);
		var bodyH = window.innerHeight;
			
		map.open({
			apiKey: lastKey,
			x: 0,
			y: (subheaderPos.h + headH),
			width: subheaderPos.w,
			height: parseInt(bodyH - subheaderPos.h)
		});
			
		//获取位置信息
		map.startLocation(function(ret, err){
	    	//设置地图中心
			map.setCenter({
				lon: ret.longitude,
				lat:ret.latitude,
			});
	    });

	    //设置显示用户位置
	    map.showUserLocation({isShow: true, trackingMode: 'none'});		    

// alert(JSON.stringify(annoArray));

		map.addAnnotations({
			annoArray: annoArray
			// annoArray:[{id:0,lon:116.297,lat:40.109,title:'第一个',subTitle:'子标题'},
   //          {id:1,lon:116.29,lat:40.109,title:'第二个',subTitle:'子标题'},
   //          {id:2,lon:116.298,lat:40.11,title:'第三个',subTitle:'子标题'}]
		}, function(ret,err){
			var id = ret.bubbleID;
			try{
			map.setBubbleStyle({
				bubbleBgImg:'widget://res/bubble_bg.png',
				imgPath: 'widget://res/bubble_head.png',
				id: id
			});
			}catch(e){
				alert('error:' + e.message);
			}
		});
		$api.setStorage('openmap', 'opened');
	}
	
	function changeNav(index){
		var mapnav = $api.byId('mapnav');
		var listnav = $api.byId('listnav');
		if(index == '1'){
			mapDisplay();//地图显示
			hasNoClsAddIt(mapnav, 'current');
			$api.removeAttr(mapnav, 'onclick');
			hasClsRemoveIt(listnav, 'current');
			// $api.attr(listnav, 'onclick', 'changeNav("0")');
		}else{
			closeBaiduMap();
			hasNoClsAddIt(listnav, 'current');
			$api.removeAttr(listnav, 'onclick');
			hasClsRemoveIt(mapnav, 'current');
			// $api.attr(mapnav, 'onclick', 'changeNav("1")');
		}
	}
	
	function closeBaiduMap(){
		map.close();
		$api.rmStorage('openmap');
	}
	
	function callFn(num){
		api.confirm({
			title: '确认',
			msg: '确认要拨打电话吗？',
			buttons: ['确认','取消']
		}, function(ret, err){
			if(ret.buttonIndex == 1){				
				api.call({
		            type: 'tel_prompt',
		            number: num
		        });
			}
		});
	}
</script>
</html>
