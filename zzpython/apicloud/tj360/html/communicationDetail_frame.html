<!DOCTYPE html>
<html>
<head>
<title>详情</title>
<meta charset="utf-8">
<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
<meta name="copyright" content="www.thundersoft.com" />
<link rel="stylesheet" href="../css/base.css">
<script src="../script/api.js"></script>
<script src="../script/common.js"></script>
<style>
	html, body{
		height: 100%;
		width: 100%;
	}
	body{
		background-color: #FAFAFA;
	}
	#title{
		padding: 10px;
		line-height: 25px;
		border-bottom:1px solid #999999;
	}
	#title li:nth-child(2){
		padding-left: 10px;
		padding-top: 10px;
		font-size: 14px;
		color: #999999;
	}
	#title li:nth-child(2) label{
		display: inline;
		color: #00b8ff;
	}
	.list ul{
		border-bottom:1px solid #CCCCCC;
		background-color: #FAFAFA;
		padding: 10px;
		font-size: 14px;
		line-height: 20px;
	}
	.list ul li:nth-child(1){
		display:-webkit-box;
	}
	.list ul li:nth-child(2){
		color: #999999;
		padding-left: 10px;
		padding-top: 10px;
	}
	.name{
		-webkit-box-flex:1;
		width:50%;
		display:-webkit-box;
		color: #00b8ff;
	}
	.date{
		text-align: right;
		color: #999999;
	}
	#nodata{
		display: -webkit-box;
		-webkit-box-align: center;
		-webkit-box-pack: center;
		background-color: #FAFAFA;
		-webkit-box-flex: 1;
		font-size: 14px;
		padding-top: 40px;
	}
</style>
</head>

<body>
	<div id="main">
		<section id="title">
		</section>
		<section class="list" id="list">
		</section>
	</div>
</body>
<script>
	var oeid = '';
	var bid = '';
	var pageIndex = 0;
	var inLoading = false;
	var needLoadMore = false;
	
	apiready = function() {
		oeid = api.pageParam.item._id;
		bid = api.pageParam.bid;
		var oqContent = api.pageParam.item.oqContent;
		var oestatus = api.pageParam.item.oestatus;
		var reply = api.pageParam.item.reply;
		var titleHtml = '<ul><li>' + oqContent + '</li>';
		if(oestatus && reply){
			titleHtml += '<li><label>管理员回复: </label>' + reply + '</li>';
		}
		titleHtml += '</ul>';
		$api.html($api.byId('title'), titleHtml);

		api.showProgress({modal: false});
		
		//下拉到页面底部，加载更多
		api.addEventListener({name:'scrolltobottom'}, function(){
	        if (needLoadMore) {
	            loadData(false);
	        }
	    });
	    //下拉刷新
	    api.setRefreshHeaderInfo({
	    	visible:true, 
	    	bgColor: '#F2F2F2', 
	    	textColor: '#000000',
	    	textDown: '下拉刷新',
	    	textUp: '释放刷新',
	    },function(ret,err){
	        loadData(true);
	    });
	    loadData(true);
	};

	function loadData(isReload_){
		if (inLoading) {//如果还在加载中，不执行操作
	        return;
	    }
	    inLoading = true;
	    if (isReload_) {//下拉刷新，即重新载入,pageIndex为0
	        pageIndex = 0;
	    }
	    
	    function ajaxBack(ret,err){
	    	inLoading = false;
	    	if(ret && ret.status){
	    		if(ret.body.list.length > 0){ 
	    			var list = ret.body.list;
	    			var html = createContent(list);	    									
	    			pageIndex++;
					if(isReload_){//如果是刷新
						$api.html($api.byId('list'), html);
						
						api.refreshHeaderLoadDone();
						setTimeout(function(){api.hideProgress();}, 300);
					}else{//如果是加载更多
						$api.append($api.byId('list'), html);
						api.toast({msg: '已加载更多', location: 'bottom'});
					}
					api.parseTapmode();
	    		}else if(ret.body.list.length == 0){
	    			api.refreshHeaderLoadDone();
	    			api.hideProgress();
	    			if(isReload_){//如果是刷新
	    				var html = '<div id="nodata">暂无回复</div>';
	    				$api.html($api.byId('list'), html);
	    			}
	    		}
	    		
	    		if(pageIndex < ret.pages){
	    			needLoadMore = true;
	    		}else{
	    			needLoadMore = false;
	    		}
	    	}else{
	    		api.refreshHeaderLoadDone();
	    		api.hideProgress();
	    		if(ret){
	    			api.toast({msg: ret.msg, location: 'middle'});
	    		}else if(err){
	    			api.toast({msg: err.msg, location: 'middle'});
	    		}else{
	    			api.toast({msg: '数据错误', location: 'middle'});
	    		}
	    		var html = '<div class="nodata">数据错误，请下拉刷新重试！</div>';
	    		$api.html($api.byId('list'), html);
	    	}
	    }
	    
    	api.ajax({
	    	url: serverUrl + '/user/OnlineExchangeReply?oeid=' + oeid + '&pageIndex='+ pageIndex,
		    method:'get',
		    cache:false,
		    timeout:15,
		    dataType:'json'
	    }, ajaxBack);
	}
	
	function createContent(list){
		var html = '';
		for(var i=0; i<list.length; i++){
			html += '<ul><li>';
			html += '<span class="name">' + list[i].createUser + '</span>';
			html += '<span class="date">' + convertDate(list[i].createDate) + '</span>';
			html += '</li><li>' + list[i].replyContent + '</li></ul>';
		}
		return html;
	}
	
	function addReply(content){		
		var usr = $api.getStorage('usr');
		if(content.length > 100){
			content = content.substr(0, 100);
		}
		var values = {
			account: $api.getStorage('usr').account,
			uid: $api.getStorage('usr').uid,
			fid: $api.getStorage('usr').fid,
			bid: bid,
			oeid: oeid,
			replyContent: content
		};
		api.ajax({
	    	url: serverUrl + '/user/SubmitOnlineExchangeReply',
		    method:'post',
		    cache:false,
		    timeout:15,
		    dataType:'json',
		    data: {'values': values}
	    }, function(ret, err){
	    	if(ret && ret.status){
	    		api.toast({msg: '提交成功', location: 'middle'});
				loadData(true);
				api.execScript({name: 'communicationItem', frameName: 'communicationItem_frame', script: 'loadData(true)'});
	    	}else{
	    		if(ret){
	    			api.toast({msg: ret.msg, location: 'middle'});
	    			if(ret.body.isLocked){//isLocked为false,包含铭感词汇,但未达到三次
	    				logout();
	    			}
	    		}else if(err){
	    			api.toast({msg: err.msg, location: 'middle'});
	    		}else{
	    			api.toast({msg: '数据错误', location: 'middle'});
	    		}
	    	}
	    });
	}
	
	function logout(){		
		$api.rmStorage('logined');
		api.openWin({name:'login', url:'login.html'});
		api.execScript({name: 'root', script: 'updateHeader()'});
		api.ajax({
	    	url: serverUrl + '/user/LoginOut?uid=' + $api.getStorage('usr').uid,
		    method:'get',
		    cache:false,
		    timeout:15,
		    dataType:'json'
	    }, function(ret, err){
	    	setTimeout(function(){
				api.closeWin({name:'communication'});
				api.closeWin({name:'communicationItem'});
				api.closeWin({name:'communicationDetail'});
	    	}, 1000);
	    });
	}
</script>
</html>
