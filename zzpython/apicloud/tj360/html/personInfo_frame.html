<!DOCTYPE html>
<html>
<head>
<title>个人信息</title>
<meta charset="utf-8">
<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
<meta name="copyright" content="www.thundersoft.com" />
<link rel="stylesheet" href="../css/base.css">
<script src="../script/api.js"></script>
<script src="../script/convert.js"></script>
<script src="../script/common.js"></script>
<style>
	html, body{
		width: 100%;
		height: 100%;
	}
	body{
		background-color: #FAFAFA;
	}
	section{
		display: -webkit-box;
		padding: 10px;
		border-bottom: 1px solid #CCCCCC;
	}
	#iconwrap img{
		-webkit-border-radius: 9px;
	}
	.left{
		display: -webkit-box;
		-webkit-box-flex: 1;
		-webkit-box-align: center;
	}
	.middle{
		display: -webkit-box;
		-webkit-box-align: center;
		-webkit-box-pack: end;
		font-size: 14px;
		color: #666666;
	}
	.right{
		width: 25px;
		display: -webkit-box;
		background: url(../image/forward.png) no-repeat center;
		-webkit-background-size: 10px 17px;	
		-webkit-box-align: center;
	}
	.right2{
		width: 25px;
		display: -webkit-box;
		background: url(../image/forward.png) no-repeat center;
		-webkit-background-size: 10px 17px;	
		-webkit-box-align: center;
	}
	.sectionActive{
		background-color: #CCCCCC !important;
	}
	.hidden{
		display: none;
	}
</style>
</head>

<body>
	<div id="main">
		<section tapmode="sectionActive" onclick="updateHead()">
			<div class="left">
				头像
			</div>
			<div class="middle" id="iconwrap">
				<img src="../image/home/default.png" id="icon" width="55px" height="55px" />
			</div>
			<a class"right2"></a>
		</section>
		<section>
			<div class="left">
				ID
			</div>
			<div class="middle" id="uid">
				1123234
			</div>
		</section>
		<section id="validate" tapmode="sectionActive" onclick="updateValidateCode()">
			<div class="left">
				工厂名称
			</div>
			<div class="middle" id="validatecode">
				-
			</div>
		</section>
		<section tapmode="sectionActive" onclick="updateGender()">
			<div class="left">
				性别
			</div>
			<div class="middle" id="gender">
				-
			</div>
			<a class="right"></a>
		</section>
		<section tapmode="sectionActive" onclick="updateAge()">
			<div class="left">
				年龄
			</div>
			<div class="middle" id="age">
				-
			</div>
			<a class="right"></a>
		</section>
		<section tapmode="sectionActive" onclick="updateAddress()">
			<div class="left">
				籍贯
			</div>
			<div class="middle" id="caddress">
				-
			</div>
			<a class="right"></a>
		</section>
		<section tapmode="sectionActive" onclick="updatePhone()">
			<div class="left">
				手机号
			</div>
			<div class="middle" id="phone">
				-
			</div>
			<a class="right"></a>
		</section>
		<section tapmode="sectionActive" onclick="updateMarriage()">
			<div class="left">
				婚姻状况
			</div>
			<div class="middle" id="marriage">
				-
			</div>
			<a class="right"></a>
		</section>		
		<section tapmode="sectionActive" onclick="updateEducation()">
			<div class="left">
				教育状况
			</div>
			<div class="middle" id="education">
				-
			</div>
			<a class="right"></a>
		</section>		
		<section tapmode="sectionActive" onclick="updateFertility()">
			<div class="left">
				生育状况
			</div>
			<div class="middle" id="fertility">
				-
			</div>
			<a class="right"></a>
		</section>
		<section tapmode="sectionActive" onclick="updateAccommodation()">
			<div class="left">
				住宿状况
			</div>
			<div class="middle" id="accommodation">
				-
			</div>
			<a class="right"></a>
		</section>
		<section tapmode="sectionActive" onclick="updateInsurance()">
			<div class="left">
				保险情况
			</div>
			<div class="middle" id="insurance">
				-
			</div>
			<a class="right"></a>
		</section>
	</div>
</body>
<script>
	window.onload = function(){
		var usr = $api.getStorage('usr');
		
		//是否显示输入工厂名称的接口		
		var isAndroid = (/android/gi).test(navigator.appVersion);
		//当手机为Android设备时，隐藏
		//当手机为iOS设备，并且fid不是是guest的时候，隐藏
		//if(isAndroid || usr.fid != 'guest'){
		if(isAndroid){
			hasNoClsAddIt($api.byId('validate'), 'hidden');
		}
		
		//显示用户账号
		var account = usr.account;
		$api.html($api.byId('uid'), account);
		
		//用户头像
		var icon = usr.icon;
		if(icon){
			$api.attr($api.byId('icon'),'src',serverUrl + icon);
		}
		
		//用户所在的工厂
		var fname = usr.fname;
		if(fname){
			$api.html($api.byId('validatecode'), fname);
		}

		//性别
		$api.html($api.byId('gender'), convert.gender(usr.gender));
		
		//年龄
		var age = usr.age;
		if(age){
			$api.html($api.byId('age'), age);
		}

		//婚姻状况，教育状况，生育状况，住宿状况，保险情况
		$api.html($api.byId('marriage'), convert.marriageStatus(usr.marriageStatus));
		$api.html($api.byId('education'), convert.education(usr.education));
		$api.html($api.byId('fertility'), convert.fertilityStatus(usr.fertilityStatus));
		$api.html($api.byId('accommodation'), convert.accommodation(usr.accommodation));
		$api.html($api.byId('insurance'), convert.insurance(usr.insurance));

		//所在城市
		var caddress = usr.caddress;
		if(caddress){
			$api.html($api.byId('caddress'), caddress);
		}
		
		//电话号码
		var phone = usr.phone;
		if(phone){
			$api.html($api.byId('phone'), phone);
		}
	};
	
	//转换方法
	var convert = new Convert();
	
	apiready = function() {
		
	};
	
	//actionBtn的样式
	var style = {
		layerColor: 'rgba(0, 0, 0, 0.3)',
		itemNormalColor: '#F1F1F1',
		itemPressColor: '#007AFF',
		fontNormalColor: '#007AFF',
		fontPressColor: '#F1F1F1',
	};
	
	//更新头像
	function updateHead(){
		var buttons = ['拍照上传', '上传手机中的照片'];
		api.actionSheet({
			cancelTitle: '取消',
			buttons: buttons,
			style: style
		}, function(ret, err){			
			//buttonIndex从1开始，cancel btn的index是3
			if(ret.buttonIndex == 1){
				getPic('camera');
			}else if(ret.buttonIndex == 2){
				getPic('library');
			}
		});
	}

	function getPic(type){
        var tw = api.winWidth;
        var th = api.winHeight;
        var data = {//该设置下获取的图片资源质量较好且size适当，非常适合上传至服务器
            sourceType: type,
            encodingType: 'jpg',
            mediaValue: 'pic',
			destinationType: 'url',
			allowEdit: false,
            quality: 80,
            targetWidth: tw,
            targetHeight: tw
        };
        api.getPicture(data, onPicBack);
	}
	
	//选择照片或拍照后callback
	function onPicBack(ret, err){
		if(ret && ret.data){
			api.showProgress({'title':'上传中', modal: false});
			//上传头像
			api.ajax({
		    	url: serverUrl + '/user/UpdateUser',
			    method: 'post',
			    cache: false,
			    timeout: 15,
			    dataType: 'json',
			    data: {values: {uid: $api.getStorage('usr').uid, icon: $api.getStorage('usr').icon}, files:{icon: ret.data}}
		    }, function(ret2, err2){
		    	if(ret2 && ret2.status){
		    		if(ret2.body.icon){
		    			api.hideProgress();
			    		//更新缓存
						var usr = $api.getStorage('usr');
				    	usr.icon = ret2.body.icon;
				    	$api.setStorage('usr', usr);
		    		}
			    	//更新本页的头像
		    		$api.attr($api.byId('icon'),'src', ret.data);
		    		//更新主页的头像
		    		api.execScript({name: 'root', script: 'afterUpdateHead("' + ret.data + '");'});
		    	}else{		    		
		    		api.hideProgress();
		    		if(ret2){
		    			api.toast({msg: ret2.msg, location: 'middle'});
		    		}else if(err2){
		    			api.toast({msg: err2.msg, location: 'middle'});
		    		}else{
		    			api.toast({msg: '数据错误', location: 'middle'});
		    		}
		    	}
		    });
		}
	}
	
	//更新性别
	function updateGender(){
		var buttons = ['男', '女'];
		api.actionSheet({
			cancelTitle: '取消',
			buttons: buttons,
			style: style
		}, function(ret, err){			
			//buttonIndex从1开始
			var gender = '';
			if(ret.buttonIndex == 1){
				gender = '1';
			}else if(ret.buttonIndex == 2){
				gender = '0';
			}
			if(gender != ''){
				//更新server内容
				api.ajax({
			    	url: serverUrl + '/user/UpdateUser',
				    method: 'post',
				    cache: false,
				    timeout: 15,
				    dataType: 'json',
				    data: {'values': {'uid': $api.getStorage('usr').uid,'gender': gender}}
			    }, function(ret2, err2){
			    	if(ret2 && ret2.status){
			    		//更新缓存
						var usr = $api.getStorage('usr');
				    	usr.gender = gender;
				    	$api.setStorage('usr', usr);
						//更新页面内容
						$api.html($api.byId('gender'), convert.gender(gender));
				    }else{
				    	if(ret2){
			    			api.toast({msg: ret2.msg, location: 'middle'});
			    		}else if(err2){
			    			api.toast({msg: err2.msg, location: 'middle'});
			    		}else{
			    			api.toast({msg: '数据错误', location: 'middle'});
			    		}
				    }
			    });
			}
		});
	}
	
	//更新婚姻状况
	function updateMarriage(){
		var buttons = ['未婚', '已婚'];
		api.actionSheet({
			cancelTitle: '取消',
			buttons: buttons,
			style: style
		}, function(ret, err){
			var status = '';		
			//buttonIndex从1开始
			if(ret.buttonIndex == 1){
				status = '0';
			}else if(ret.buttonIndex == 2){
				status = '1';
			}
			if(status != ''){
				//更新server内容
				api.ajax({
			    	url: serverUrl + '/user/UpdateUser',
				    method: 'post',
				    cache: false,
				    timeout: 15,
				    dataType: 'json',
				    data: {'values': {'uid': $api.getStorage('usr').uid, 'marriageStatus': status}}
			    }, function(ret2, err2){
			    	if(ret2 && ret2.status){
			    		//更新缓存
						var usr = $api.getStorage('usr');
				    	usr.marriageStatus = status;
				    	$api.setStorage('usr', usr);
						//更新页面内容
						$api.html($api.byId('marriage'), convert.marriageStatus(status));
				    }else{
				    	if(ret2){
			    			api.toast({msg: ret2.msg, location: 'middle'});
			    		}else if(err2){
			    			api.toast({msg: err2.msg, location: 'middle'});
			    		}else{
			    			api.toast({msg: '数据错误', location: 'middle'});
			    		}
				    }
			    });
			}
		});
	}
	
	//更新教育状况
	function updateEducation(){
		var buttons = ['研究生', '本科', '大专', '高中', '初中'];
		api.actionSheet({
			cancelTitle: '取消',
			buttons: buttons,
			style: style
		}, function(ret, err){
			var status = '';
			//buttonIndex从1开始
			if(ret.buttonIndex == 1){
				status = '5';
			}else if(ret.buttonIndex == 2){
				status = '4';
			}else if(ret.buttonIndex == 3){
				status = '3';
			}else if(ret.buttonIndex == 4){
				status = '2';
			}else if(ret.buttonIndex == 5){
				status = '1';
			}
			if(status != ''){
				//更新server内容
				api.ajax({
			    	url: serverUrl + '/user/UpdateUser',
				    method: 'post',
				    cache: false,
				    timeout: 15,
				    dataType: 'json',
				    data: {'values': {'uid': $api.getStorage('usr').uid, 'education': status}}
			    }, function(ret2, err2){
			    	if(ret2 && ret2.status){
			    		//更新缓存
						var usr = $api.getStorage('usr');
				    	usr.education = status;
				    	$api.setStorage('usr', usr);
				    	//更新页面内容
				    	$api.html($api.byId('education'), convert.education(status));
				    }else{
				    	if(ret2){
			    			api.toast({msg: ret2.msg, location: 'middle'});
			    		}else if(err2){
			    			api.toast({msg: err2.msg, location: 'middle'});
			    		}else{
			    			api.toast({msg: '数据错误', location: 'middle'});
			    		}
				    }
			    });
			}
		});
	}
	
	//更新生育状况
	function updateFertility(){
		var buttons = ['未育', '已育'];
		api.actionSheet({
			cancelTitle: '取消',
			buttons: buttons,
			style: style
		}, function(ret, err){
			var status = '';			
			//buttonIndex从1开始
			if(ret.buttonIndex == 1){
				status = '0';
			}else if(ret.buttonIndex == 2){
				status = '1';
			}
			if(status != ''){
				//更新server内容
				api.ajax({
			    	url: serverUrl + '/user/UpdateUser',
				    method: 'post',
				    cache: false,
				    timeout: 15,
				    dataType: 'json',
				    data: {'values': {'uid': $api.getStorage('usr').uid, 'fertilityStatus': status}}
			    }, function(ret2, err2){
			    	if(ret2 && ret2.status){
			    		//更新缓存
						var usr = $api.getStorage('usr');
				    	usr.fertilityStatus = status;
				    	$api.setStorage('usr', usr);
				    	//更新页面内容
				    	$api.html($api.byId('fertility'), convert.fertilityStatus(status));
				    }else{
				    	if(ret2){
			    			api.toast({msg: ret2.msg, location: 'middle'});
			    		}else if(err2){
			    			api.toast({msg: err2.msg, location: 'middle'});
			    		}else{
			    			api.toast({msg: '数据错误', location: 'middle'});
			    		}
				    }
			    });
			}
		});
	}
	
	//更新住宿状况
	function updateAccommodation(){
		var buttons = ['宿舍', '租房', '其它'];
		api.actionSheet({
			cancelTitle: '取消',
			buttons: buttons,
			style: style
		}, function(ret, err){
			var status = '';			
			//buttonIndex从1开始
			if(ret.buttonIndex == 1){
				status = '0';
			}else if(ret.buttonIndex == 2){
				status = '1';
			}else if(ret.buttonIndex == 3){
				status = '2';
			}
			if(status != ''){
				//更新server内容
				api.ajax({
			    	url: serverUrl + '/user/UpdateUser',
				    method: 'post',
				    cache: false,
				    timeout: 15,
				    dataType: 'json',
				    data: {'values': {'uid': $api.getStorage('usr').uid, 'accommodation': status}}
			    }, function(ret2, err2){
			    	if(ret2 && ret2.status){
			    		//更新缓存
						var usr = $api.getStorage('usr');
				    	usr.accommodation = status;
				    	$api.setStorage('usr', usr);
				    	//更新页面内容
				    	$api.html($api.byId('accommodation'), convert.accommodation(status));
				    }else{
				    	if(ret2){
			    			api.toast({msg: ret2.msg, location: 'middle'});
			    		}else if(err2){
			    			api.toast({msg: err2.msg, location: 'middle'});
			    		}else{
			    			api.toast({msg: '数据错误', location: 'middle'});
			    		}
				    }
			    });
			}
		});
	}
	
	//更新保险状况
	function updateInsurance(){
		var buttons = ['新型农村合作医疗保险', '城镇医疗保险', '商业保险', '其它'];
		api.actionSheet({
			cancelTitle: '取消',
			buttons: buttons,
			style: style
		}, function(ret, err){
			var status = '';			
			//buttonIndex从1开始
			if(ret.buttonIndex == 1){
				status = '0';
			}else if(ret.buttonIndex == 2){
				status = '1';
			}else if(ret.buttonIndex == 3){
				status = '2';
			}else if(ret.buttonIndex == 4){
				status = '3';
			}
			if(status != ''){
				//更新server内容
				api.ajax({
			    	url: serverUrl + '/user/UpdateUser',
				    method: 'post',
				    cache: false,
				    timeout: 15,
				    dataType: 'json',
				    data: {'values': {'uid': $api.getStorage('usr').uid, 'insurance': status}}
			    }, function(ret2, err2){
			    	if(ret2 && ret2.status){
			    		//更新缓存
						var usr = $api.getStorage('usr');
				    	usr.insurance = status;
				    	$api.setStorage('usr', usr);
				    	//更新页面内容
				    	$api.html($api.byId('insurance'), convert.insurance(status));
				    }else{
				    	if(ret2){
			    			api.toast({msg: ret2.msg, location: 'middle'});
			    		}else if(err2){
			    			api.toast({msg: err2.msg, location: 'middle'});
			    		}else{
			    			api.toast({msg: '数据错误', location: 'middle'});
			    		}
				    }
			    });
			}
		});
	}
	
	//更新年龄
	function updateAge(){
		api.openPicker({
			title: '请选择出生日期',
			type: 'date'
		}, function(ret, err){
			var now = new Date();
			var nowStr = now.getFullYear() * 10000 + (now.getMonth()+1) * 100 + now.getDate();
			var selectStr = ret.year * 10000 + ret.month * 100 + ret.day;
			if(parseInt(selectStr) >= parseInt(nowStr)){
				api.toast({msg: '请选择准确的出生时间！', location: 'middle'});
			}else{
				var ageDate = ret.year + '-' + ret.month + '-' + ret.day;
				//更新server内容
				api.ajax({
			    	url: serverUrl + '/user/UpdateUser',
				    method: 'post',
				    cache: false,
				    timeout: 15,
				    dataType: 'json',
				    data: {'values': {'uid': $api.getStorage('usr').uid, 'age': ageDate}}
			    }, function(ret2, err2){
			    	if(ret2 && ret2.status){
			    		//更新缓存
						var usr = $api.getStorage('usr');
				    	usr.age = ret2.body.age;
				    	$api.setStorage('usr', usr);
						//更新页面内容
						$api.html($api.byId('age'), ret2.body.age);
				    }else{
				    	if(ret2){
			    			api.toast({msg: ret2.msg, location: 'middle'});
			    		}else if(err2){
			    			api.toast({msg: err2.msg, location: 'middle'});
			    		}else{
			    			api.toast({msg: '数据错误', location: 'middle'});
			    		}
				    }
			    });
			}
		});
	}
	
	//打开输入工厂名称的页面
	function updateValidateCode(){
		api.openWin({name: 'personInfoValidate', url: 'personInfoValidate.html'});
	}

	//输入工厂名称，提交成功之后，更新页面内容
	function modifyValidate(validatecode){
		//hasNoClsAddIt($api.byId('validate'), 'hidden');
		$api.html($api.byId('validatecode'), validatecode);
	}

	//更新所在城市，会打开城市选择列表
	function updateAddress(){
		api.execScript({name: 'personInfo', script: 'updateAddress();'});
	}
	
	//选择城市后，更新页面内容
	function modifyAddress(cityname){
		$api.html($api.byId('caddress'), cityname);
	}
	
	//打开修改手机号码页面
	function updatePhone(){
		api.openWin({name: 'personInfoPhone', url: 'personInfoPhone.html'});
	}
	
	//修改手机号码成功后，修改页面内容
	function modifyPhone(phone){
		//更新缓存
		var usr = $api.getStorage('usr');
    	usr.phone = phone;
    	$api.setStorage('usr', usr);				    	
    	//更新页面内容
    	$api.html($api.byId('phone'), phone);
	}
</script>
</html>
