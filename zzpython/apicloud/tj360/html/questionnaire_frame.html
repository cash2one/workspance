<!DOCTYPE html>
<html>
<head>
<title>问卷</title>
<meta charset="utf-8">
<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
<meta name="copyright" content="www.thundersoft.com" />
<link rel="stylesheet" href="../css/base.css">
<script src="../script/api.js"></script>
<script src="../script/template.js"></script>
<script src="../script/common.js"></script>
<style>
	html, body{
		width: 100%;
		height: 100%;
	}
	body{
		background-color: #FAFAFA;
	}
	section{
		border-bottom: 1px solid #CCCCCC;
		padding: 10px;
	}
	dl, dd{
		margin: 0px;
		padding: 0px;
	}
	dd{
		display: -webkit-box;
	}
	section div span, section dd, section dd a{
		font-size: 14px;
		color: #666666; 
	}
	section div, section dl dt, section dl dd{
		margin-bottom: 10px;		
	}
	section div{
		display: -webkit-box;
	}
	section div span{
		display: -webkit-box;
		-webkit-box-flex: 1;
		-webkit-box-align: center;
	}
	section div span:nth-child(2){
		-webkit-box-pack: end;
	}
	section div span label{
		font-size: 16px;
		color: #00b8ff;
	}
	section dt{
		font-size: 14px; 
	}
	section dd{
		width: 100%; 
	}
	section dd a{
		width: 50px;
		height: 20px;
		padding-top: 1px;
		padding-bottom: 1px;
		text-align: center;
		font-weight: bold;
		background: url(../image/checkbg.png) no-repeat top;
		-webkit-background-size: 20px 20px;
	}
	section dd span{
		display: -webkit-box;
		-webkit-box-flex: 1;
		color: inherit;
	}
	section dd a input{
		display: none !important;
		-webkit-appearance: none;
	}
	.checked{
		background: url(../image/checkedbg.png) no-repeat top !important;
		-webkit-background-size: 20px 20px !important;
		color: #FFFFFF !important;
	}
	.ddchecked{
		color: #00b8ff !important;
	}
</style>
</head>
<body>
	<div id="main">
	</div>
</body>
<script id="item_template" type="text/html">
	<%
		var list = body.list;
		var length = list.length;
		var pageIndex = body.pageIndex;
		var totalRows = body.totalRows;
	%>
		<input type="hidden" id="count" value="<%=totalRows%>"/>
	<%		
		for(var i=0; i<length; i++){
			if(list[i].multiple == '1'){
	%>
				<section>
					<div>			
						<span>多选</span>
						<span><label><%=(pageIndex * 10 + i + 1)%></label>/<%=totalRows%></span>
					</div>
					<dl>
						<dt><%=list[i].sname%></dt>
	<%
						for(var j=0; j<list[i].q_options.length; j++){
	%>
							<dd tapmode="" onclick="checkboxItem(this, '<%=list[i]._id%>', '<%=list[i].q_options[j].option%>', '<%=(pageIndex * 10 + i)%>')">
								<a><%=list[i].q_options[j].option%></a><span><%=list[i].q_options[j].describe%></span>
							</dd>
	<%
						}
	%>
					</dl>
				</section>
	<%
			}else if(list[i].multiple == '0'){
	%>
				<section>
					<div>			
						<span>单选</span>
						<span><label><%=(pageIndex * 10 + i + 1)%></label>/<%=totalRows%></span>
					</div>
					<dl>
						<dt><%=list[i].sname%></dt>
	<%
						for(var j=0; j<list[i].q_options.length; j++){
	%>
							<dd tapmode="" onclick="radioItem(this, 'q<%=(pageIndex * 10 + i)%>', '<%=list[i]._id%>', '<%=list[i].q_options[j].option%>', '<%=(pageIndex * 10 + i)%>')">
								<a><%=list[i].q_options[j].option%><input type="radio" name="q<%=(pageIndex * 10 + i)%>"/></a><span><%=list[i].q_options[j].describe%></span>
							</dd>					
	<%
						}
	%>
					</dl>
				</section>
	<%
			}
		}
	%>
</script>
<script>
	var pageIndex = 0;
	var inLoading = false;
	var needLoadMore = false;
	var qid = '';

	var userSelection = [];
	apiready = function() {
		qid = api.pageParam.qid;
	
		api.showProgress({modal: false});
		//下拉到页面底部，加载更多
		api.addEventListener({name:'scrolltobottom'}, function(){
	        if (needLoadMore) {
	            loadData(false);
	        }
	    });
	    
	    loadData(true);
	};
	
	function loadData(isReload_){
		if (inLoading) {//如果还在加载中，不执行操作
	        return;
	    }
	    inLoading = true;
	    if (isReload_) {//下拉刷新，即重新载入,pageIndex为0
	        pageIndex = 0;
	    }
	    
	    function ajaxBack(ret,err){
	    	inLoading = false;
	    	if(ret && ret.status){
	    		if(ret.body.list.length > 0){ 
	    			var list = ret.body.list;
	    			var html = baidu.template('item_template', ret);	    									
	    			pageIndex++;
					if(isReload_){//如果是刷新
						$api.html($api.byId('main'), html);
						
						setTimeout(function(){api.hideProgress();}, 300);
					}else{//如果是加载更多
						$api.append($api.byId('main'), html);
						api.toast({msg: '已加载更多', location: 'bottom'});
					}
					api.parseTapmode();
	    		}else if(ret.body.list.length == 0){
	    			api.refreshHeaderLoadDone();
	    			api.hideProgress();
	    			if(isReload_){//如果是刷新
	    				var html = '<div class="nodata">暂无数据</div>';
	    				$api.html($api.byId('main'), html);
	    			}
	    		}
	    		
	    		if(pageIndex < ret.pages){
	    			needLoadMore = true;
	    		}else{
	    			needLoadMore = false;
	    		}
	    	}else{
	    		api.hideProgress();
	    		if(ret){
	    			api.toast({msg: ret.msg, location: 'middle'});
	    		}else if(err){
	    			api.toast({msg: err.msg, location: 'middle'});
	    		}else{
	    			api.toast({msg: '数据错误', location: 'middle'});
	    		}
	    	}
	    }
	    
    	api.ajax({
	    	url: serverUrl + '/user/Questionnaire?qid=' + qid + '&qtype=0&pageIndex='+ pageIndex,
		    method:'get',
		    cache:false,
		    timeout:15,
		    dataType:'json'
	    }, ajaxBack);
	}
	
	//el:当前元素
	//sid:当前题目的id
	//select:选择的选项
	//index:当前题目在userSelection中对应的项，从0开始
	function checkboxItem(el, sid, select, index){
		var cel = el.childNodes[0];
		if($api.hasCls(cel, 'checked')){
			$api.removeCls(cel, 'checked');
			hasClsRemoveIt(el, 'ddchecked');
			//从userSelection中把该sid对应的相应选项值拿掉
			var selection = userSelection[index].selection;
			for(var i=0; i<selection.length; i++){
				if(selection[i] == select){
					userSelection[index].selection.splice(i, 1);
					break;
				}
			}
			//拿掉对应的值后，userSelection[index].selection的长度为0， 则需要移除该sid， 此时该项的值为undefined
			if(userSelection[index].selection.length == 0){
				delete userSelection[index];
			}
			
		}else if(!$api.hasCls(cel, 'checked')){
			$api.addCls(cel, 'checked');
			hasNoClsAddIt(el, 'ddchecked');
			//把选项加入userSelection
			//如果是第一次选，创建
			if(!userSelection[index]){
				var o = {
					'sid': sid,
					'selection': [select]
				};
				userSelection[index] = o;
			}else{//如果不是第一次选， 直接修改值，对值进行一个排序
				userSelection[index].selection.push(select);
				userSelection[index].selection.sort();
			}
			
		}
	}
	
	//el:当前元素
	//name:单选按钮组的名字
	//sid:当前题目的id
	//select:选择的选项
	//index:当前题目在userSelection中对应的项，从0开始
	function radioItem(el, name, sid, select, index){
		var cel = el.childNodes[0];
		if(!$api.hasCls(cel, 'checked')){			
			//移除另一个被选中的项
			var radios = document.getElementsByName(name);
			for(var i=0; i<radios.length; i++){
				if(radios[i].checked){
					hasClsRemoveIt(radios[i].parentNode, 'checked');
					hasClsRemoveIt(radios[i].parentNode.parentNode, 'ddchecked');
					userSelection[index].selection.splice(0, 1);
					break;
				}
			}
			
			$api.addCls(cel, 'checked');
			hasNoClsAddIt(el, 'ddchecked');
			$api.last(cel).checked =  true;
			
			if(!userSelection[index]){
				var o = {
					'sid': sid,
					'selection': [select]
				};
				userSelection[index] = o;
			}else{//如果不是第一次选， 直接修改值
				userSelection[index].selection.splice(0, 1);
				userSelection[index].selection.push(select);
			}
		}
	}
	
	function submitQuestionnaire(){
		try{
		var count = $api.val($api.byId('count'));
		//遍历数字，看是否有undefined的
		var isUndefined = false;
		for(var i=0; i< userSelection.length; i++){
			if(!userSelection[i]){
				isUndefined = true;
				break;
			}
		}
		
		//userSelection的长度小于总题目数，说明没有回答完
		if(userSelection.length<count || isUndefined){
			api.toast({msg: '您还有未回答的问题！', location: 'middle'});
		}else{			
			var values = {
				uid: $api.getStorage('usr').uid,
				fid: $api.getStorage('usr').fid,
				qid: qid,
				qtype: '0',
				userSelection: JSON.stringify(userSelection)
			};
			api.ajax({
		    	url: serverUrl + '/user/SubmitQuestionnaire',
			    method:'post',
			    cache:false,
			    timeout:15,
			    dataType:'json',
			    data: {'values': values}
		    }, function(ret, err){
		    	if(ret && ret.status){	    	
					api.toast({msg: '提交成功', location: 'middle'});
					setTimeout(function(){api.closeWin();}, 2000);
		    	}else{
		    		if(ret){
		    			api.toast({msg: ret.msg, location: 'middle'});
		    		}else if(err){
		    			api.toast({msg: err.msg, location: 'middle'});
		    		}else{
		    			api.toast({msg: '数据错误', location: 'middle'});
		    		}	
		    	}
		    });
		}
		}catch(e){
			alert('error:' + e.message);
		}
	}
</script>
</html>
