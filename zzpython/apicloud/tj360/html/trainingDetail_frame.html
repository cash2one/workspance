<!DOCTYPE html>
<html>
<head>
<title>课程中心</title>
<meta charset="utf-8">
<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
<meta name="copyright" content="www.thundersoft.com" />
<link rel="stylesheet" href="../css/base.css">
<script src="../script/api.js"></script>
<script src="../script/carousel.js"></script>
<script src="../script/common.js"></script>
<style>
	html, body {
		width: 100%;
		height: 100%;
	}
	body{
		background-color: #FAFAFA;
	}
	#main{
		overflow: hidden;
	}
	#video{
		display: -webkit-box;
		-webkit-box-flex:1;
		-webkit-box-orient:horizontal;
		-webkit-box-align:center;
	}
	.container{
		width: 100%;
		display: -webkit-box;
		-webkit-box-align:center;
	}
	.container div:nth-child(1){
		width: 35%;
	}
	.container div:nth-child(2){
		width: 30%;
		background: url(../image/play.png) no-repeat center;
		-webkit-background-size: contain;
		height: 100%;
	}
	.container div:nth-child(3){
		width: 35%;
		height: 100%;
		display: -webkit-box;
		-webkit-box-align: end;
		-webkit-box-pack: end;
	}
	.container div:nth-child(3) span{
		border-width: 4px;
		border-radius: 4px;
		border-style: solid;
		border-color: #FFFFFF;
		margin-right: 4px;
	}
	.currentbtn{
		border-color: rgb(225, 66, 116) !important;
	}
	.playbtnActive{
		background: url(../image/play_hov.png) no-repeat center !important;
		-webkit-background-size: contain !important;
	}
	#intro{
		padding: 10px;
		line-height: 25px;
	}
	.introborder{
		/*border-bottom: 1px solid #CCCCCC;*/
	}
	ul,li{
		list-style: none;
	}
	li{
		display: -webkit-box;
		border-bottom: 1px solid #CCCCCC;
		padding: 10px 10px;	
		background-color: #FFFFFF;
	}
	.left{
		-webkit-box-flex: 1;
		width: 100%;
		-webkit-box-align: center;
		text-overflow:ellipsis;
		overflow:hidden;
		white-space:nowrap;
	}
	.right{
		width: 25px;
		display: -webkit-box;
		background: url(../image/forward.png) no-repeat center;
		-webkit-background-size: 10px 17px;
	}
	.listActive{
		background-color: #CCCCCC !important;
	}
	.nodata{
		display: -webkit-box;
		-webkit-box-align: center;
		-webkit-box-pack: center;
		background-color: #FAFAFA;
		-webkit-box-flex: 1;
		font-size: 14px;
		padding-top: 40px;
	}
</style>
</head>
<body>
	<div id="main">
		<section id="video">
		</section>
		<section id="intro">
		</section>
		<section id="contentswrap">
		</section>
	</div>
</body>
<script>
	var pageIndex = 0;
	var inLoading = false;
	var needLoadMore = false;
	var item = null;
	var videoFiles = '';
	var zipFiles = '';
	var hasVideo = true;
	var hasZip = true;
	var manager = '';

	apiready = function() {
		item = api.pageParam.item;
		
		intro(item.mdescription);
		/**	
		 var model = api.require('model');
            var query = api.require('query');
           var relation = api.require('relation');
           model.config({
                appKey: '727724FF-FD26-C97B-B317-366723CA78A2',
                host: 'https://d.apicloud.com',
                appId:'A6961693132912'
            });
         	var param = {};
			param.class = 'traning';

			param.id = item.id;
		
			param.column = 'traninglist';
			relation.findAll(param, function(ret, err){
			setTimeout(function(){api.hideProgress();}, 500);
					if(ret){

					zipFiles = ret;
						
					}else{
						alert(JSON.stringify(err));
					}
				});
				*/

	};

	function addKeybackEventListener() {
		if (manager) {
			//如果打开了下载管理，点back的时候，关闭下载管理插件
			manager.closeManagerView();
			manager = '';
		} else {
			api.closeWin();
		}
	}

	function videoList(vidos) {
		var video = $api.byId('video');
		if (vidos.length > 0) {
			video.style.height = api.winWidth * 0.6 + 'px';
		}
		var btnstr = '';
		for (var i = 0; i < vidos.length; i++) {
			var videoStr = '<div class="container" id="v' + i + '">';
			videoStr += '<div></div>';
			videoStr += '<div class="playbtn" tapmode="playActive" onclick="playNetworkVideo(\'' + serverUrl + '/user/Download/' + vidos[i].vido.split('/')[2] + '\')"></div>';
			videoStr += '<div class="morebtn">';
			if (vidos.length > 1) {
				for (var j = 0; j < vidos.length; j++) {
					if (i == j) {
						videoStr += '<span class="currentbtn"></span>';
					} else {
						videoStr += '<span></span>';
					}
				}
			}
			videoStr += '</div></div>';

			if (i == 0) {
				$api.html(video, videoStr);
			} else {
				$api.append(video, videoStr);
			}
			api.parseTapmode();

			$api.byId('v' + i).style.backgroundImage = 'url("../image/defaultPoster.png")';
			$api.byId('v' + i).style.height = api.winWidth * 0.6 + 'px';
			$api.byId('v' + i).style.backgroundSize = api.winWidth + 'px ' + api.winWidth * 0.6 + 'px';
		}

		if (vidos.length > 1) {
			slideVideos(); //幻灯片效果
		}
	}

	function slideVideos() {
		var video = $api.byId('video');
		var rollTimer = null;
		video.slide = new Slider(video, {
			dir: 'x',
			touchStartFn: function() {
				if (rollTimer) {
					clearInterval(rollTimer);
				};
			},
			touchEndFn: function() {},
			transEndFn: function() {
				iNow = this.currentPoint;
				if (!this.hasNext()) {
					this.currentPoint = -1;
				};
			},
			duration: 100
		});
	}

	function intro(intro) {
		var el = $api.byId('intro');
		$api.html(el, intro);
		hasNoClsAddIt(el, 'introborder');
	}

	function loadData(isReload_) {
		if (inLoading) { //如果还在加载中，不执行操作
			return;
		}
		inLoading = true;
		if (isReload_) { //下拉刷新，即重新载入,pageIndex为0
			pageIndex = 0;
		}

		function ajaxBack(ret, err) {

			inLoading = false;
			if (ret) {
				if (isReload_) { //如果是刷新  						
					//videoList(item.vidos);//video列表
					intro(item.mdescription); //简介
				}

				if (ret.length > 0) {


					pageIndex++;
					zipFiles = ret.files;
					//$api.html($api.byId('contentswrap'), '<ul id="contents">' + html + '</ul>');

					setTimeout(function() {
						api.hideProgress();
					}, 500);
					/**
					if(isReload_){//如果是刷新
						//目前的目录都较少，所以对zipFiles不考虑刷新
						zipFiles = ret.files;
	    				//$api.html($api.byId('contentswrap'), '<ul id="contents">' + html + '</ul>');
	    				
	    				setTimeout(function(){api.hideProgress();}, 500);
					}else{//如果是加载更多
						$api.append($api.byId('contents'), html);
						api.toast({msg: '已加载更多', location: 'bottom'});
					}*/
					api.parseTapmode();
				} else if (ret.length == 0) {
					api.refreshHeaderLoadDone();
					api.hideProgress();
					hasZip = false;
					api.execScript({
						name: 'trainingDetail',
						script: 'checkDownload(false)'
					});
					/**
					if(isReload_){//如果是刷新
						var html = '<div class="nodata">暂无数据</div>';
						$api.html($api.byId('contentswrap'), html);
					}*/
				}

				if (pageIndex < ret.pages) {
					needLoadMore = true;
				} else {
					needLoadMore = true;
				}
				api.refreshHeaderLoadDone();
			} else {
				api.refreshHeaderLoadDone();
				api.hideProgress();
				if (ret) {
					api.toast({
						msg: ret.msg,
						location: 'middle'
					});
				} else if (err) {
					api.toast({
						msg: err.msg,
						location: 'middle'
					});
				} else {
					api.toast({
						msg: '数据错误',
						location: 'middle'
					});
				}
				/**
				var html = '<div class="nodata">数据错误，请下拉刷新重试！</div>';
				$api.html($api.byId('contentswrap'), html);
				*/
			}
		}


		var model = api.require('model');
		var query = api.require('query');
		var relation = api.require('relation');
		model.config({
			appKey: '727724FF-FD26-C97B-B317-366723CA78A2',
			host: 'https://d.apicloud.com',
			appId: 'A6961693132912'
		});
		var param = {};
		param.class = 'traning';
		param.id = '546b352b53a26b901d0c2f8c';
		param.column = 'traninglist';
		relation.findAll(param, ajaxBack);



	}

	function createContent(list) {
		var html = '';
		for (var i = 0; i < list.length; i++) {
			if (list[i].files.length > 0) {
				html += '<li tapmode="listActive" onclick="openTrainingDetailHTML(\'' + list[i]._id + '\',\'' + serverUrl + list[i].files[0].index + '/Index.html\')">';
				html += '<div class="left">' + list[i].cname + '</div>';
				html += '<a class="right"></a>';
				html += '</li>';
			}
		}
		return html;
	}

	function playNetworkVideo(url) {
		api.openVideo({
			url: url
		});
	}

	function openTrainingDetailHTML(cid, link) {
		var uid = 'guest';
		var logined = $api.getStorage('logined');
		if (logined) {
			uid = $api.getStorage('usr').uid;
		}
		var values = {
			uid: uid,
			cid: cid,
			mid: item._id,
			record: 1
		};
		api.ajax({
			url: serverUrl + '/LearningRecord',
			method: 'post',
			cache: false,
			timeout: 15,
			dataType: 'json',
			data: {
				values: values
			}
		}, function(ret, err) {

		});

		api.openWin({
			name: 'trainingDetailHTML',
			url: 'trainingDetailHTML.html',
			pageParam: {
				link: link
			}
		});
	}

	function downloadCallback() {
		manager.openManagerView({
			'title': '下载管理'
		}, onItemClick);
	}

	function downloadRecord(complete) {
		var values = {
			mid: item._id,
			uid: $api.getStorage('usr').uid,
			complete: complete
		};
		api.ajax({
			url: serverUrl + '/user/DownloadRecord',
			method: 'post',
			cache: false,
			timeout: 15,
			dataType: 'json',
			data: {
				values: values
			}
		}, function(ret, err) {

		});
	}

	var style = {
		layerColor: 'rgba(0, 0, 0, 0.3)',
		itemNormalColor: '#F1F1F1',
		itemPressColor: '#007AFF',
		fontNormalColor: '#007AFF',
		fontPressColor: '#F1F1F1',
	};

	function downLoad() {

		downZip(downloadCallback);
		/**
			if(hasVideo && hasZip){
				var complete = 0;
				var buttons = ['下载视频','下载课件', '同时下载'];
				api.actionSheet({cancelTitle: '取消', buttons: buttons, style: style}, function(ret, err){
					if(ret.buttonIndex == 1){//buttonIndex从1开始
						downVideo(downloadCallback);
					}else if(ret.buttonIndex == 2){
						downZip(downloadCallback);			
					}else if(ret.buttonIndex == 3){
						complete = 1;
						downVideo(downZip(downloadCallback));
					}
					downloadRecord(complete);
				});
			}else if(hasVideo && !hasZip){
				var buttons = ['下载视频'];
				api.actionSheet({cancelTitle: '取消', buttons: buttons, style: style}, function(ret, err){
					if(ret.buttonIndex == 1){//buttonIndex从1开始
						downVideo(downloadCallback);
					}
					downloadRecord('1');
				});
			}else if(!hasVideo && hasZip){
				var buttons = ['下载课件'];
				api.actionSheet({cancelTitle: '取消', buttons: buttons, style: style}, function(ret, err){
					if(ret.buttonIndex == 1){
						downZip(downloadCallback);
					}
					downloadRecord('1');
				});
			}*/
	}

	function downVideo(callback) {
		manager = api.require('downloadManager');
		var iconPath = 'widget://res/video.png';
		for (var i = 0; i < videoFiles.length; i++) {
			var url = serverUrl + '/user/Download/' + videoFiles[i].vido.split('/')[2];
			var filename = videoFiles[i].filename;
			var savePath = 'cache://download/' + filename;
			filename = filename.substring(0, filename.lastIndexOf('.'));

			manager.enqueue({
				url: url,
				iconPath: iconPath,
				savePath: savePath,
				allowResume: true,
				cache: false,
				mimeType: 'video/mp4',
				title: filename
			}, function(ret, err) {});
		}
		callback();
	}

	function downZip(callback) {
		manager = api.require('downloadManager');
		var iconPath = 'widget://res/htmlfile.png';
		for (var i = 0; i < zipFiles.length; i++) {
			var url = zipFiles[i].files.url;

			var filename = zipFiles[i].files.name;
			var savePath = 'cache://download/' + filename;
			filename = filename.substring(0, filename.lastIndexOf('.'));

			manager.enqueue({
				url: url,
				iconPath: iconPath,
				savePath: savePath,
				uncompress: true,
				cache: false,
				mimeType: 'application/zip',
				allowResume: true,
				title: filename
			}, function(ret, err) {});
		}
		callback();
	}

	function onItemClick(ret, err) {
		if (ret) {
			var mimeType = ret.mimeType;
			var savePath = ret.savePath;
			var uncompressPath = ret.uncompressPath;
			if (uncompressPath) {
				//uncompressPath及压缩包内部资源目录层级开发者自己定义
				uncompressPath = uncompressPath + "/Index.html";
				api.openWin({
					name: 'trainingDetailHTML',
					url: 'trainingDetailHTML.html',
					pageParam: {
						link: uncompressPath
					},
					bgColor: '#FFFFFF'
				});
				return;
			} else {
				manager.openDownloadedFile({
					id: ret.id
				}, function(ret, err) {});
			}
		}
	}
</script>
</html>
